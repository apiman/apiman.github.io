<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="http://www.apiman.io/latest/resources/images/favicon.ico">
  <title>At long last, Metrics R Us!</title>
  <meta name="description" content="A core feature of any good API Management solution is the recording of and reporting oninteresting metrics related to API requests.  Because apiman acts as a...">

  <link href="http://www.apiman.io/latest/resources/bootstrap-3.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/patternfly-1.0.5/css/patternfly.min.css" rel="stylesheet">
  <link href="http://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/css/apiman-web.css?v=1.1.9.Final" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/css/apiman-web.responsive.css?v=1.1.9.Final" rel="stylesheet">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/blog/css/highlight.css" rel="stylesheet">
  <link href="/blog/css/main.css" rel="stylesheet">
  <link href="/blog/css/coderay-asciidoctor.css" rel="stylesheet">
  
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  
  <script src="http://www.apiman.io/latest/resources/jquery-1.11.1/js/jquery.min.js"></script>
  <script src="http://www.apiman.io/latest/resources/bootstrap-3.3.0/js/bootstrap.min.js"></script>
  <script>
      $(document).ready(function() {
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-56678850-1', 'auto');
              ga('send', 'pageview');
      });
  </script>

  <link rel="canonical" href="http://apiman.io/blog/api-manager/service/ui/metrics/2015/07/06/metrics.html">
  <link rel="alternate" type="application/rss+xml" title="apiman blog" href="http://apiman.io/blog/feed.xml" />
</head>

  <body class="blog">
    <div id="rhbar">
      <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a>
      <a class="rhlogo" href="http://www.redhat.com/"></a>
    </div>
    <nav id="top-nav" class="navbar navbar-inverse" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.apiman.io/latest/index.html">apiman</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/index.html">Overview</a></li>
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/download.html">Download</a></li>
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/roadmap.html">Roadmap</a></li>
        <li class="top-menu-item menu-item active"><a href="http://www.apiman.io/blog/">Blog</a></li>
        <li class="top-menu-item menu-item dropdown">
            <a href="https://www.patternfly.org/visual-styles/" class="dropdown-toggle" data-toggle="dropdown">Get Involved<b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li class="menu-item">
                    <a href="https://issues.jboss.org/browse/APIMAN">Report a Bug</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/chat.html">Chat on IRC</a>
                </li>
                <li class="menu-item">
                    <a href="https://twitter.com/apiman_io">Twitter Feed</a>
                </li>
                <li class="menu-item">
                    <a href="https://lists.jboss.org/mailman/listinfo/apiman-user">Mailing List</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/contributors.html">Contributors List</a>
                </li>
            </ul>
        </li>
        <li class="top-menu-item menu-item dropdown">
            <a href="https://www.patternfly.org/visual-styles/" class="dropdown-toggle" data-toggle="dropdown">Learn More<b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/tutorials.html">Tutorials &amp; Walkthroughs</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/installation-guide.html">Installation Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/user-guide.html">User Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/developer-guide.html">Developer Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/production-guide.html">Production Guide</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/api-manager-restdocs.html">API Manager REST Endpoints</a>
                </li>
            </ul>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <div class="container" id="blog">
      <div class="blog-content">
        

<div class="post">
  <header class="post-header" style="margin-top: 25px">
    <h1 style="color: #666; font-weight: bold" class="post-title section-header">At long last, Metrics R Us!</h1>
    <span style="color: #243446; font-size: 13px"><i class="fa fa-calendar"></i> Jul 6, 2015</span>
    <span style="color: #243446; margin-left: 15px; font-size: 13px"><i class="fa fa-user"></i> <a href="https://www.github.com/ericwittmann">Eric Wittmann</a></span>
    <span style="color: #243446; margin-left: 15px; font-size: 13px"><i class="fa fa-tags"></i> api-manager, service, ui, and metrics</span>
  </header>

  <article class="post-content" style="margin-top: 20px; font-size: 14px; line-height: 20px">
    <p>A core feature of any good API Management solution is the recording of and reporting on
interesting metrics related to API requests.  Because apiman acts as a central Gateway
for all managed API traffic, it is the perfect location to record information about each
and every request.  This allows it to report on interesting data it has recorded, related
to response times, successful vs. failed requests, total number of requests broken down
by time, consumer id, or plan used.  As you can imagine, this is extremely valuable
information and it is a bit embarrassing that we haven’t offered this functionality until
now!</p>

<p>But that gap is finally filled with version 1.1.4.Final.</p>

<!--more-->

<h2 id="overview">Overview</h2>
<p>First let me give you just a high level overview of what this is all about.  Every time
the API Gateway gets a request from an API client, it will add a record in the metrics
system with a bunch of interesting fields.  These include but are not limited to:</p>

<ul>
  <li>Request start and end times</li>
  <li>Service start and end times (i.e. just the part of the request taken up by the back end service)</li>
  <li>Resource path</li>
  <li>Response type (success, failure, error)</li>
  <li>Service info (org id, id, version)</li>
  <li>Application info (org id, id, version)</li>
</ul>

<p>All of this information is recorded in the metrics storage system so that later on it
can be analyzed/mined for interesting trends.</p>

<p>In the API Manager, we extract interesting reports from the recorded metrics data and
display it as graphs in the UI (as well as provide the data via a set of metrics
related REST endpoints in the API Manager’s own API).</p>

<h2 id="how-do-we-store-metrics">How do we store metrics?</h2>
<p>Out of the box, apiman stores the metrics information into an elasticsearch index.  This
elasticsearch instance is provided as part of the apiman distribution and is enabled and
running by default.  If you wish to use a different elasticsearch instance that’s of
course no problem - all it requires is some tweaking of settings in the apiman.properties
file.  I recommend having a look at the <a href="http://www.apiman.io/latest/installation-guide.html">Installation Guide</a>
for more details.</p>

<p>The intention is to support various metrics storage systems, not just elasticsearch.
For example, we have InfluxDB and Hawkular implementations in progres.  You can even
implement your own!  Custom metrics systems is likely a separate blog post, but note
that <em>storing</em> metrics data into an alternate system is easy - simply implement the
<em>IMetrics</em> interface:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">io</span><span class="o">.</span><span class="na">apiman</span><span class="o">.</span><span class="na">gateway</span><span class="o">.</span><span class="na">engine</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IMetrics</span> <span class="o">{</span>

  <span class="cm">/**</span>
<span class="cm">  * Records the metrics for a single request.  Most implementations will likely</span>
<span class="cm">  * asynchronously process this information.</span>
<span class="cm">  */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">record</span><span class="o">(</span><span class="n">RequestMetric</span> <span class="n">metric</span><span class="o">);</span>

  <span class="cm">/**</span>
<span class="cm">  * Provides the component registry (before any call to {@link #record(RequestMetric)})</span>
<span class="cm">  * is made. Metrics can then access HTTP client components, etc.</span>
<span class="cm">  */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setComponentRegistry</span><span class="o">(</span><span class="n">IComponentRegistry</span> <span class="n">registry</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>

<p>A little bit of configuration foo in the apiman.properties is all it takes to switch
from elasticsearch to your custom provider.</p>

<h2 id="metrics-data-from-the-api-managers-rest-api">Metrics data from the API Manager’s REST API</h2>
<p>There is no way to extract arbitrary metrics information from the metrics source unless
you hit the metrics storage directly.  For example, you could use Kibana to directly
view the apiman metrics information stored in elasticsearch.  In the future we will
be exploring ways to integrate the data visualization tools that come with each of the
providers we support (elasticsearch, hawkular, influxcb, etc).  However, we do provide
a set of REST endpoints you can use to extract common metrics.  These REST endpoints are
available as a part of the standard API Manager’s REST API.</p>

<p>Please refer to the <a href="http://www.apiman.io/latest/api-manager-restdocs.html">API documentation</a>
for the latest information, but at the time of this blog post the available metrics
endpoints are:</p>

<ul>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/usage</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/appUsage</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/planUsage</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/responseStats</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/summaryResponseStats</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/planResponseStats</version></svc_id></org_id></li>
  <li>/organizations/<org_id>/services/<svc_id>/versions/<version>/metrics/appResponseStats</version></svc_id></org_id></li>
</ul>

<p>The ‘usage’ endpoints return information about the number of requests made.  The
‘responseStats’ endpoints are similar, but are broken down by response type (successful
vs. failed vs. error responses).  All endpoints require a time range (from and to).  The
<em>/usage</em> and <em>/responseStats</em> endpoints also require a time interval, because they both
return a histogram/time series dataset.</p>

<p>Sensible limits are enforced on all these endpoints to discourage abuse.  For example,
don’t ask for a per-minute granularity time series dataset over a ten year data range.
The system won’t like that one bit.</p>

<h2 id="viewing-metrics-info-in-the-ui">Viewing metrics info in the UI</h2>
<p>The metrics information provided by the API is also available directly in the API Manager
UI.  For any published service, simply navigate to the <em>Metrics</em> tab for that Service
(in the provider section of the UI).  The UI should be pretty easy to use - simply pick
a type of metric you want to see and a pre-configured time period!  Here is what the
usage metrics might look like for a typical service:</p>

<p><img src="/blog/images/2015-07-06/usage-metrics.png" alt="Usage Metrics" /></p>

<p>And here is what you might expect to find for typical response type metrics:</p>

<p><img src="/blog/images/2015-07-06/response-type-metrics.png" alt="Response Type Metrics" /></p>

<h2 id="conclusion">Conclusion</h2>
<p>As you can see, this is highly valuable information to have.  We only have a couple of
different categories of metrics exposed via the API and UI right now - so this is
your opportunity to come tell us what you’d like to see!  Join the apiman metrics
conversation on our <a href="https://lists.jboss.org/mailman/listinfo/apiman-user">mailing list</a>
or <a href="http://www.apiman.io/latest/chat.html">IRC channel</a>.</p>

<p>/post</p>

  </article>

</div>

      </div>
      <div class="blog-footer">
        <footer role="contentinfo">
    <div id="inner-footer" class="clearfix row">
        <div id="widget-footer" class="clearfix">
            <hr>
            <div class="widget col-sm-6 col-md-6 widget_text">
                <div class="textwidget">
                    <p>
                        Copyright &copy; 2015 Red Hat, Inc. All rights reserved.<br>
                        apiman code is open source and released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.<br> 
                        <a href="disclosure.html">Open Source Disclosure</a>
                    </p>
                </div>
            </div>
            <div class="widget col-sm-6 col-md-6 widget_text" style="text-align: right">
                <a href="http://www.redhat.com"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png"></a>
            </div>
        </div>
        <nav class="clearfix"></nav>
    </div>
</footer>

      </div>
    </div>
  </body>
</html>
