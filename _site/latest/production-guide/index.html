<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Guide - Deploying for Production</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e3"/>Guide - Deploying for Production</h1></div><div><h2 class="subtitle">apiman 1.1.9.Final</h2></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#_deployment_tooling_for_apiman">1. Deployment Tooling for apiman</a></span></dt><dt><span class="chapter"><a href="#_architecture_summary">2. Architecture Summary</a></span></dt><dt><span class="chapter"><a href="#_database">3. Database</a></span></dt><dt><span class="chapter"><a href="#_elasticsearch">4. Elasticsearch</a></span></dt><dt><span class="chapter"><a href="#_keycloak">5. Keycloak</a></span></dt><dt><span class="chapter"><a href="#_api_gateway">6. API Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_installing_the_api_gateway">6.1. Installing the API Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_the_api_gateway">6.2. Configuring the API Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_disabling_the_keycloak_server">6.2.1. Disabling the Keycloak Server</a></span></dt><dt><span class="section"><a href="#_setting_the_api_gateway_public_endpoint">6.2.2. Setting the API Gateway Public Endpoint</a></span></dt><dt><span class="section"><a href="#_configuring_keycloak_authentication_for_the_gateway_api">6.2.3. Configuring Keycloak Authentication for the Gateway API</a></span></dt><dt><span class="section"><a href="#_pointing_the_api_gateway_to_a_remote_elasticsearch">6.2.4. Pointing the API Gateway to a Remote Elasticsearch</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_api_manager">7. API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_installing_the_api_manager">7.1. Installing the API Manager</a></span></dt><dt><span class="section"><a href="#_configuring_the_api_manager">7.2. Configuring the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_disabling_the_keycloak_server_2">7.2.1. Disabling the Keycloak Server</a></span></dt><dt><span class="section"><a href="#_connecting_to_the_database">7.2.2. Connecting to the Database</a></span></dt><dt><span class="section"><a href="#_point_the_api_manager_to_the_api_gateway">7.2.3. Point the API Manager to the API Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_keycloak_authentication_for_the_manager_api_and_ui">7.2.4. Configuring Keycloak Authentication for the Manager API and UI</a></span></dt><dt><span class="section"><a href="#_pointing_the_api_manager_to_a_remote_elasticsearch">7.2.5. Pointing the API Manager to a Remote Elasticsearch</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_deployment_tooling_for_apiman"/>Chapter 1. Deployment Tooling for apiman</h2></div></div></div><p>This guide should serve as a guide to manually deploy apiman into production.  However, we also offer a
simple shell script that can do much of the work for you.  It will likely always be a work in progress,
so many production deployers may not feel comfortable using it.  However, it can currently install the
following components:</p><div class="itemizedlist"><ul><li>Elasticsearch</li><li>Keycloak</li><li>API Manager</li><li>API Gateway</li></ul></div><p>You can find the apiman production deployer here:</p><p><a class="ulink" href="https://github.com/apiman/apiman-deployer/tree/apiman-1.1.9.Final">https://github.com/apiman/apiman-deployer/tree/apiman-1.1.9.Final</a></p><p>Simply download that script and run it on each of the machines you wish to install the various apiman
components!</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_architecture_summary"/>Chapter 2. Architecture Summary</h2></div></div></div><p>Before we get started, it may be useful to know the overall architecture of apiman.  Let’s start with a
picture!</p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Architecture of apiman</h5><p class="formalpara"><span class="inlinemediaobject"><img src="images/images/apiman-architecture.png" alt="Architecture of apiman"/></span></p><p>The apiman solution is made up of a number of pieces, including:</p><div class="itemizedlist"><ul><li>Keycloak Authentication Server</li><li>Relational Database</li><li>Elasticsearch Datastore</li><li>apiman API Gateway</li><li>apiman API Manager</li></ul></div><p>The image above should give you an idea of how they all fit together.</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_database"/>Chapter 3. Database</h2></div></div></div><p>You have a number of persistence options in both Keycloak and apiman, but this guide will focus on using an
RDBMS instead of other options (e.g. Elasticsearch for apiman or mongodb for KC).</p><p>On a separate server, install a production ready database such as mysql, mariadb, or postresql.  You will
want to create two schemas/databases:</p><div class="itemizedlist"><ul><li>keycloak</li><li>apiman</li></ul></div><p>Make sure your DB is accessible remotely and enable whatever security options you need (SSL, users/passwords).
We recommend using two different users and permissioning them appropriately (e.g. create a "sa_apiman" account
and a "sa_keycloak" account).</p><p>After creating the ‘apiman' database, you can initialize it using the appropriate DDL for the database you
selected.  We currently support mysql5/mariadb and postgresql.  The DDLs for these databases can be found in
the quickstart/overlay ZIP file, or you can grab them directly from github.  For example:</p><p><a class="ulink" href="https://github.com/apiman/apiman/tree/master/distro/wildfly8/src/main/resources/overlay/apiman/ddls">https://github.com/apiman/apiman/tree/master/distro/wildfly8/src/main/resources/overlay/apiman/ddls</a></p><p>Make sure you grab the right one for whichever version of apiman you are going to be installing (<span class="strong"><strong>hint</strong></span>: use
the appropriate github tag).</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_elasticsearch"/>Chapter 4. Elasticsearch</h2></div></div></div><p>If you wish to enable metrics in apiman (who doesn’t?) you’ll need to install Elasticsearch.  This is
because the API Gateway stores all metrics information in Elasticsearch (by default), and the API Manager
queries that data to present analytics information in the UI.</p><p>Please see the Elasticsearch documentation for how to install and configure it in production.  Ultimately you
will need Elasticsearch running in a well known and accessible location.  We also recommend you enable
authentication (e.g. via Shield) and SSL.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>The data in Elasticsearch is not backed up or stored in some other location - Elasticsearch is being
used as the primary/canonical data store for the metrics information.  You may wish to configure backup
procedures</p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_keycloak"/>Chapter 5. Keycloak</h2></div></div></div><p>In production, it is typically useful to deploy Keycloak server as a standalone solution.  For more
specific information about how to configure a standalone Keycloak server, see the Keycloak documentation:</p><p><a class="ulink" href="http://keycloak.github.io/docs/userguide/html/server-installation.html">http://keycloak.github.io/docs/userguide/html/server-installation.html</a></p><p>Once Keycloak is installed as a standalone server, you must configure the ‘apiman' realm.  This realm will
be used for authentication into each of the apiman components (API Manager REST services, API Manager UI,
API Gateway REST services, etc).</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You can configure additional Keycloak Realms for use when using the apiman "Keycloak OAuth2 Policy".</p></div><p>Fortunately, apiman comes with a realm file you can import.  Simply log into your keycloak server and then
create the apiman realm using this file:</p><p><a class="ulink" href="https://github.com/apiman/apiman/blob/master/distro/data/src/main/resources/data/apiman-realm.json">https://github.com/apiman/apiman/blob/master/distro/data/src/main/resources/data/apiman-realm.json</a></p><p>Once you have created the apiman realm, you must use the keycloak UI to add your API Manager UI as a valid
redirect URL for the ‘apimanui' client.  To do this, log into the keycloak admin console and choose the
<span class="strong"><strong>apiman</strong></span> realm.  Next click "clients" in the left navigation, and choose <span class="strong"><strong>apimanui</strong></span> in the resulting list.
From there you can add public URL if your API Manager UI to the list of "<span class="strong"><strong><span class="emphasis"><em>Valid Redirect URIs</em></span></strong></span>".  It might
be something like:</p><pre class="literallayout">https://apimanager.mycompany.org:8443/apimanui/*</pre><p>That will allow users of the API Manager UI to actually log in and be properly redirected back to the
application!</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway"/>Chapter 6. API Gateway</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_installing_the_api_gateway">6.1. Installing the API Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_the_api_gateway">6.2. Configuring the API Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_disabling_the_keycloak_server">6.2.1. Disabling the Keycloak Server</a></span></dt><dt><span class="section"><a href="#_setting_the_api_gateway_public_endpoint">6.2.2. Setting the API Gateway Public Endpoint</a></span></dt><dt><span class="section"><a href="#_configuring_keycloak_authentication_for_the_gateway_api">6.2.3. Configuring Keycloak Authentication for the Gateway API</a></span></dt><dt><span class="section"><a href="#_pointing_the_api_gateway_to_a_remote_elasticsearch">6.2.4. Pointing the API Gateway to a Remote Elasticsearch</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_the_api_gateway"/>6.1. Installing the API Gateway</h2></div></div></div><p>The easiest way to install just the API Gateway is to download and install the apiman quickstart overlay
and then remove the extraneous components.  Follow that up with some modification of the apiman.properties
configuration file and you’ll be Gatewaying in no time!</p><p>Here are the steps you should take to install a standalone API Gateway:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and unpack WildFly</li><li>Download apiman</li><li>Unpack apiman into WildFly</li><li>Remove unused apiman deployments from standalone/deployments</li></ol></div><p>Which apiman deployments should you delete?  These:</p><pre class="literallayout">standalone/deployments/apiman-ds.xml
standalone/deployments/apiman-es.war
standalone/deployments/apiman.war
standalone/deployments/apimanui.war</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_configuring_the_api_gateway"/>6.2. Configuring the API Gateway</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_disabling_the_keycloak_server"/>6.2.1. Disabling the Keycloak Server</h3></div></div></div><p>Because you will be using an external/standalone Keycloak server, it is useful to disable the Keycloak
components that are bundled with the apiman quickstart.  To do that, make the following modification to
the <span class="strong"><strong>standalone-apiman.xml</strong></span> file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">subsystem</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:keycloak:1.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">auth-server</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;main-auth-server&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">enabled</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">enabled</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">web-context</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">auth</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">web-context</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">auth-server</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">subsystem</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_setting_the_api_gateway_public_endpoint"/>6.2.2. Setting the API Gateway Public Endpoint</h3></div></div></div><p>An important step is to let the API Gateway know what its public endpoint is.  This is important because
the API Manager will sometimes ask the Gateway to report on the Managed Endpoint for a published service.</p><p>To set the public URL/endpoint of the API Gateway, add the following to apiman.properties:</p><pre class="literallayout">apiman-gateway.public-endpoint=https://api-gateway-host.org:8443/apiman-gateway/</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Please make sure to use your appropriate values for the host and port.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_keycloak_authentication_for_the_gateway_api"/>6.2.3. Configuring Keycloak Authentication for the Gateway API</h3></div></div></div><p>The API Gateway has a REST based configuration API which the API Manager uses when publishing services to
it.  This API is protected by Keycloak authentication.  The apiman quickstart assumes that the keycloak
server is local, so you’ll need to modify the <span class="strong"><strong>standalone-apiman.xml</strong></span> file to point to the remote Keycloak
instance.</p><p>Here is the relevant portion of the <span class="strong"><strong>standalone-apiman.xml</strong></span> file that you must change:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns:kc</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:keycloak:1.0&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">MIGf..snip..QAB</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">https://keycloak-host.org:8443/auth</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">none</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">preferred_username</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_pointing_the_api_gateway_to_a_remote_elasticsearch"/>6.2.4. Pointing the API Gateway to a Remote Elasticsearch</h3></div></div></div><p>The API Gateway uses Elasticsearch in a number of ways, including:</p><div class="itemizedlist"><ul><li>Storing configuration information</li><li>Managing shared state across a cluster</li><li>Storing metrics to share with the API Manager  (analytics)</li></ul></div><p>In order to configure the gateway properly, you will need to configure the location of the Elasticsearch
instance.  To do this, modify these properties in the <span class="strong"><strong>apiman.properties</strong></span> file:</p><pre class="literallayout">apiman.es.protocol=http
apiman.es.host=es.myorg.com
apiman.es.port=9200
apiman.es.username=es_admin
apiman.es.password=es_admin_password</pre><p>Obviously you will need to replace the values in the properties above with those appropriate for your
installation of elasticsearch.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_manager"/>Chapter 7. API Manager</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_installing_the_api_manager">7.1. Installing the API Manager</a></span></dt><dt><span class="section"><a href="#_configuring_the_api_manager">7.2. Configuring the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_disabling_the_keycloak_server_2">7.2.1. Disabling the Keycloak Server</a></span></dt><dt><span class="section"><a href="#_connecting_to_the_database">7.2.2. Connecting to the Database</a></span></dt><dt><span class="section"><a href="#_point_the_api_manager_to_the_api_gateway">7.2.3. Point the API Manager to the API Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_keycloak_authentication_for_the_manager_api_and_ui">7.2.4. Configuring Keycloak Authentication for the Manager API and UI</a></span></dt><dt><span class="section"><a href="#_pointing_the_api_manager_to_a_remote_elasticsearch">7.2.5. Pointing the API Manager to a Remote Elasticsearch</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_the_api_manager"/>7.1. Installing the API Manager</h2></div></div></div><p>The easiest way to install just the API Manager is to download and install the apiman quickstart overlay
and then remove the extraneous components.  Follow that up with a few configuration modifications, and
you should have the Manager running in no time!</p><p>Here are the steps you should take to install a standalone API Manager:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and unpack WildFly</li><li>Download apiman</li><li>Unpack apiman into WildFly</li><li>Remove unused apiman deployments from standalone/deployments</li></ol></div><p>Which apiman deployments should you delete?  These:</p><pre class="literallayout">standalone/deployments/apiman-es.war
standalone/deployments/apiman-gateway-api.war
standalone/deployments/apiman-gateway.war</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_configuring_the_api_manager"/>7.2. Configuring the API Manager</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_disabling_the_keycloak_server_2"/>7.2.1. Disabling the Keycloak Server</h3></div></div></div><p>Because you will be using an external/standalone Keycloak server, it is useful to disable the Keycloak
components that are bundled with the apiman quickstart.  To do that, make the following modification to
the <span class="strong"><strong>standalone-apiman.xml</strong></span> file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">subsystem</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:keycloak:1.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">auth-server</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;main-auth-server&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">enabled</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">enabled</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">web-context</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">auth</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">web-context</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">auth-server</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">subsystem</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_connecting_to_the_database"/>7.2.2. Connecting to the Database</h3></div></div></div><p>This guide assumes you are using a production ready RDBMS as the storage layer for the API Manager.  Note
that other options exist, but configuring them is out of scope for this guide.</p><p>Hopefully you’ve already created and initialized the database in the earlier section labeled "<span class="emphasis"><em>Installing a
Database</em></span>".  So at this point you really only need to connect the API Manager up to the already existing
database.  The following must be done in order to connect to your database:</p><div class="itemizedlist"><ul><li>Deploy a JDBC driver compatible with your database</li><li>Update the <span class="strong"><strong>apiman-ds.xml</strong></span> datasource file (to point it at your database)</li><li>Update the hibernate dialect in <span class="strong"><strong>apiman.properties</strong></span></li></ul></div><p>First, you will need to deploy a JDBC driver that is compatible with whichever database you have chosen.
Here are two popular drivers:</p><p><span class="emphasis"><em>*MySQL 5*</em></span></p><p><a class="ulink" href="https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.33/mysql-connector-java-5.1.33.jar">https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.33/mysql-connector-java-5.1.33.jar</a></p><p><span class="emphasis"><em>*Postgresql 9*</em></span></p><p><a class="ulink" href="https://repo1.maven.org/maven2/org/postgresql/postgresql/9.3-1102-jdbc41/postgresql-9.3-1102-jdbc41.jar">https://repo1.maven.org/maven2/org/postgresql/postgresql/9.3-1102-jdbc41/postgresql-9.3-1102-jdbc41.jar</a></p><p>The easiest way to deploy the driver is to simply download it and copy it into the
<span class="strong"><strong>wildfly/standalone/deployments</strong></span> directory.</p><p>Next, you must update or replace the <span class="strong"><strong>apiman-ds.xml</strong></span> file to something that is configured for your
 particular database.  Examples of appropriate datasource files for mysql and postgresql can be found here:</p><p><a class="ulink" href="https://github.com/apiman/apiman/tree/master/distro/wildfly8/src/main/resources/overlay/apiman/sample-configs">https://github.com/apiman/apiman/tree/master/distro/wildfly8/src/main/resources/overlay/apiman/sample-configs</a></p><p>These examples are also included in the apiman quickstart/overlay ZIP download.</p><p>Finally you must update the <span class="strong"><strong>apiman.properties</strong></span> file to configure the hibernate dialect for your database.
Popular dialects for mysql and postgresql are:</p><div class="itemizedlist"><ul><li><span class="emphasis"><em>*MySQL 5*</em></span>: org.hibernate.dialect.MySQL5Dialect</li><li><span class="emphasis"><em>*Postgresql 9*</em></span>: org.hibernate.dialect.PostgreSQLDialect</li></ul></div><p>Here is the line you should change in the <span class="strong"><strong>apiman.properties</strong></span> file:</p><pre class="literallayout">apiman.hibernate.dialect=io.apiman.manager.api.jpa.ApimanH2Dialect</pre><p>Change the value of that property to the appropriate dialect for your database.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_point_the_api_manager_to_the_api_gateway"/>7.2.3. Point the API Manager to the API Gateway</h3></div></div></div><p>Now that both your API Manager and API Gateway are running, you need to hook them up.  This just means
telling API Manager where the gateway lives.  There is an admin UI page in apiman that will let you do
this.  Simply navigate here:</p><p><a class="ulink" href="https://api-manager-host.org:8443/apimanui/api-manager/admin/gateways">https://api-manager-host.org:8443/apimanui/api-manager/admin/gateways</a></p><p>From there you will be able to click on the gateway and modify its settings.  Make sure to use the <span class="strong"><strong>Test</strong></span>
button on the Edit Gateway UI page to make sure you got the settings right!  Don’t worry, the <span class="strong"><strong>Test</strong></span> button
will simply try to make a connection to the API Gateway’s configuration URL, asking it for the current
Gateway status.  If the Gateway responds as expected, then you can be confident that your settings are
correct.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You will need to log into the UI.  The default credentials are:  admin/admin123!</p></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You may have changed the default user credentials when you installed and configured keycloak.  If
so, make sure you use those credentials.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_keycloak_authentication_for_the_manager_api_and_ui"/>7.2.4. Configuring Keycloak Authentication for the Manager API and UI</h3></div></div></div><p>The API Manager has a REST based API which the User Interface uses for all actions taken.  It can also be
used directly for automation and/or integration purposes.  This API is protected by Keycloak authentication.
The apiman quickstart assumes that the keycloak server is local, so you’ll need to modify the
<span class="strong"><strong>standalone-apiman.xml</strong></span> file to point to the remote Keycloak instance.</p><p>Here is the relevant portion of the <span class="strong"><strong>standalone-apiman.xml</strong></span> file that you must change:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns:kc</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:keycloak:1.0&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">MIGf..snip..QAB</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">https://keycloak-host.org:8443/auth</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">none</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">preferred_username</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_pointing_the_api_manager_to_a_remote_elasticsearch"/>7.2.5. Pointing the API Manager to a Remote Elasticsearch</h3></div></div></div><p>The API Manager uses Elasticsearch for analysis of metrics.  This metrics data is stored in Elasticsearch
by the API Gateway whenever API requests are handled.  Therefore, the API Manager and API Gateway must
talk to the same Elasticsearch instance/cluster.</p><p>To configure Elasticsearch for the API Manager, modify these properties in the <span class="strong"><strong>apiman.properties</strong></span> file:</p><pre class="literallayout">apiman.es.protocol=http
apiman.es.host=es.myorg.com
apiman.es.port=9200
apiman.es.username=es_admin
apiman.es.password=es_admin_password</pre><p>Obviously you will need to replace the values in the properties above with those appropriate for your
installation of elasticsearch.</p></div></div></div></div></body></html>