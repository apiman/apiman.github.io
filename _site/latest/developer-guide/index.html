<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">apiman - Developer Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e3"/>apiman - Developer Guide</h1></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dt><span class="chapter"><a href="#_developer_resources">2. Developer Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#_source_code">2.1. Source Code</a></span></dt><dt><span class="section"><a href="#_issue_tracking">2.2. Issue Tracking</a></span></dt><dt><span class="section"><a href="#_development_tools">2.3. Development Tools</a></span></dt><dt><span class="section"><a href="#_building_the_project">2.4. Building the Project</a></span></dt><dt><span class="section"><a href="#_setting_up_a_development_environment">2.5. Setting up a Development Environment</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_architecture">3. Architecture</a></span></dt><dt><span class="chapter"><a href="#_plugins">4. Plugins</a></span></dt><dd><dl><dt><span class="section"><a href="#_creating_a_plugin">4.1. Creating a Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="#_the_plugin_specification_file">4.1.1. The Plugin Specification File</a></span></dt><dt><span class="section"><a href="#_using_maven_to_create_a_plugin">4.1.2. Using Maven to Create a Plugin</a></span></dt><dt><span class="section"><a href="#_making_your_plugin_available_to_apiman">4.1.3. Making Your Plugin Available to apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_contributing_a_policy">4.2. Contributing a Policy</a></span></dt><dd><dl><dt><span class="section"><a href="#_policy_implementation">4.2.1. Policy Implementation</a></span></dt><dt><span class="section"><a href="#_policy_definition">4.2.2. Policy Definition</a></span></dt><dt><span class="section"><a href="#_policy_configuration_form">4.2.3. Policy Configuration Form</a></span></dt></dl></dd><dt><span class="section"><a href="#_testing_a_plugin_policy">4.3. Testing a Plugin Policy</a></span></dt><dd><dl><dt><span class="section"><a href="#_import_the_framework_maven_dependency">4.3.1. Import the Framework (Maven Dependency)</a></span></dt><dt><span class="section"><a href="#_create_and_annotate_a_junit_test_case">4.3.2. Create and Annotate a JUnit Test Case</a></span></dt><dt><span class="section"><a href="#_providing_a_custom_back_end_service_mock">4.3.3. Providing a Custom Back-End Service Mock</a></span></dt></dl></dd><dt><span class="section"><a href="#_contributing_a_core_component">4.4. Contributing a Core Component</a></span></dt><dd><dl><dt><span class="section"><a href="#_implementing_a_custom_core_component">4.4.1. Implementing a Custom Core Component</a></span></dt><dt><span class="section"><a href="#_enabling_your_custom_component">4.4.2. Enabling Your Custom Component</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_gateway_implementations">5. Gateway Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#_implementing_iapimanbuffer">5.1. Implementing IApimanBuffer</a></span></dt><dt><span class="section"><a href="#_executing_apiman_core">5.2. Executing apiman-core</a></span></dt><dd><dl><dt><span class="section"><a href="#_streaming_data">5.2.1. Streaming data</a></span></dt><dt><span class="section"><a href="#_handling_results">5.2.2. Handling results</a></span></dt><dt><span class="section"><a href="#_handling_failures">5.2.3. Handling Failures</a></span></dt></dl></dd><dt><span class="section"><a href="#_creating_a_service_connector">5.3. Creating a Service Connector</a></span></dt><dd><dl><dt><span class="section"><a href="#_connector_basics">5.3.1. Connector basics</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnection">5.3.2. Creating the IServiceConnection</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnectionresponse">5.3.3. Creating the IServiceConnectionResponse</a></span></dt><dt><span class="section"><a href="#_implementation_strategies">5.3.4. Implementation strategies</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_introduction"/>Chapter 1. Introduction</h2></div></div></div><p>Are you interested in contributing to the development of apiman?  Maybe you want to embed the
project in your own solution?  In either case this is the guide for you.</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_developer_resources"/>Chapter 2. Developer Resources</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_source_code">2.1. Source Code</a></span></dt><dt><span class="section"><a href="#_issue_tracking">2.2. Issue Tracking</a></span></dt><dt><span class="section"><a href="#_development_tools">2.3. Development Tools</a></span></dt><dt><span class="section"><a href="#_building_the_project">2.4. Building the Project</a></span></dt><dt><span class="section"><a href="#_setting_up_a_development_environment">2.5. Setting up a Development Environment</a></span></dt></dl></div><p>This section describes a number of resources that are useful if you wish to contribute
code to apiman.  It is likely also a good starting point for those wishing to provide
functionality by implementing a plugin, although more information about plugins can
be found in the <span class="emphasis"><em>Plugins</em></span> section.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_source_code"/>2.1. Source Code</h2></div></div></div><p>The apiman source code is located in github here:</p><p><a class="ulink" href="https://github.com/apiman/apiman">https://github.com/apiman/apiman</a></p><p>Source code for the apiman project web site is here:</p><p><a class="ulink" href="https://github.com/apiman/apiman.github.io">https://github.com/apiman/apiman.github.io</a></p><p>The docker files are currently here:</p><p><a class="ulink" href="https://github.com/apiman/apiman-docker">https://github.com/apiman/apiman-docker</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_issue_tracking"/>2.2. Issue Tracking</h2></div></div></div><p>The apiman project uses JIRA to track issues such as bugs and feature requests.  It’s a good place to start
if you’re trying to figure out how to get involved!</p><p><a class="ulink" href="https://issues.jboss.org/browse/APIMAN">https://issues.jboss.org/browse/APIMAN</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_development_tools"/>2.3. Development Tools</h2></div></div></div><p>We’re rather IDE agnostic, so contributors should feel free to use whatever tools they feel most
comfortable with.  At the time of this writing, the core apiman developers primarily use Eclipse
Kepler.</p><p><a class="ulink" href="http://www.eclipse.org/downloads/">http://www.eclipse.org/downloads/</a></p><p>The core apiman project is built using maven.  Currently we recommend at least version 3.0.3.</p><p><a class="ulink" href="http://maven.apache.org/download.cgi">http://maven.apache.org/download.cgi</a></p><p>And of course you’ll need to have git installed if you want to check out the code from github.</p><p><a class="ulink" href="http://git-scm.com/">http://git-scm.com/</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_building_the_project"/>2.4. Building the Project</h2></div></div></div><p>Building apiman should be a simple matter of doing a standard Maven build:</p><pre class="literallayout">mvn clean install</pre><p>This will do a full build of apiman and execute all unit tests.  However,
the result will not include a ready-to-run version of apiman.  For that, you
may want to try the following:</p><pre class="literallayout">mvn clean install -Pinstall-all-wildfly8</pre><p>This command will do a full apiman build, but will also download WildFly
and install apiman into it.  The result will be a fully configured install of
apiman running in WildFly.  The location of this WildFly install will be here:</p><pre class="literallayout">apiman/tools/server-all/targe/wildfly-{wildfly.version}/</pre><p>At this point you can test apiman by simply running WildFly from the above
location using a command something like this:</p><pre class="literallayout">./bin/standalone.sh -b 0.0.0.0</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_setting_up_a_development_environment"/>2.5. Setting up a Development Environment</h2></div></div></div><p>Because apiman is a fairly standard maven project, it should be relatively easy
to import the project into Eclipse or IntelliJ IDEA.  For now we’ll leave this
as an exercise for the reader.</p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_architecture"/>Chapter 3. Architecture</h2></div></div></div><p>The basic architecture of apiman is fairly straightforward.  There are several WARs that
make up the default apiman installation.  These include:</p><div class="itemizedlist"><ul><li>API Manager back-end (JAX-RS WAR)</li><li>API Manager UI (AngularJS/Hawtio WAR)</li><li>API Gateway Config (JAX-RS WAR)</li><li>API Gateway (Servlet WAR)</li></ul></div><p>The API Manager back-end WAR is responsible for exposing a set of REST endpoints that
make up the API Manager REST interface.  The API Manager UI uses this REST API
directly when the user manages the various entities in the data model.</p><p>The API Manager UI is a client-only AngularJS application.  Aside from authentication
related activities, this WAR only contains HTML, JavaScript, and CSS.  The UI uses
the browser to make direct, authenticated calls to the REST endpoints exposed by the
API Manager back-end WAR.</p><p>The API Gateway Config exposes the standard apiman Gateway REST API so that the API
Gateway can be remotely configured.  This is the REST API that the API Manager uses
whenever a user publishes a Service or registers an Application.  It is responsible
for configuring the API Gateway’s embedded Policy Engine.</p><p>The API Gateway is the primary runtime component of apiman and is implemented as a
servlet that embeds the apiman Policy Engine.  All requests to the API Gateway WAR are
assumed to be intended for managed Services previously published to it.</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_plugins"/>Chapter 4. Plugins</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_creating_a_plugin">4.1. Creating a Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="#_the_plugin_specification_file">4.1.1. The Plugin Specification File</a></span></dt><dt><span class="section"><a href="#_using_maven_to_create_a_plugin">4.1.2. Using Maven to Create a Plugin</a></span></dt><dt><span class="section"><a href="#_making_your_plugin_available_to_apiman">4.1.3. Making Your Plugin Available to apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_contributing_a_policy">4.2. Contributing a Policy</a></span></dt><dd><dl><dt><span class="section"><a href="#_policy_implementation">4.2.1. Policy Implementation</a></span></dt><dt><span class="section"><a href="#_policy_definition">4.2.2. Policy Definition</a></span></dt><dt><span class="section"><a href="#_policy_configuration_form">4.2.3. Policy Configuration Form</a></span></dt></dl></dd><dt><span class="section"><a href="#_testing_a_plugin_policy">4.3. Testing a Plugin Policy</a></span></dt><dd><dl><dt><span class="section"><a href="#_import_the_framework_maven_dependency">4.3.1. Import the Framework (Maven Dependency)</a></span></dt><dt><span class="section"><a href="#_create_and_annotate_a_junit_test_case">4.3.2. Create and Annotate a JUnit Test Case</a></span></dt><dt><span class="section"><a href="#_providing_a_custom_back_end_service_mock">4.3.3. Providing a Custom Back-End Service Mock</a></span></dt></dl></dd><dt><span class="section"><a href="#_contributing_a_core_component">4.4. Contributing a Core Component</a></span></dt><dd><dl><dt><span class="section"><a href="#_implementing_a_custom_core_component">4.4.1. Implementing a Custom Core Component</a></span></dt><dt><span class="section"><a href="#_enabling_your_custom_component">4.4.2. Enabling Your Custom Component</a></span></dt></dl></dd></dl></div><p>The easiest way to extend the functionality of apiman is by implementing an apiman
plugin.  This section details how this is done and what functionality can be
extended or provided.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_creating_a_plugin"/>4.1. Creating a Plugin</h2></div></div></div><p>An apiman plugin is basically a java web archive (WAR) with a little bit of extra
sauce.  This approach makes it very easy to build using maven, and should be quite
familiar to most Java developers.  Because a plugin consists of some resources files,
compiled java classes, front-end resource such as HTML and javascript, and dependencies
in the form of JARs, the WAR format is a natural choice.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_the_plugin_specification_file"/>4.1.1. The Plugin Specification File</h3></div></div></div><p>In addition to the standard layout of a Java Web Archive, an apiman plugin must contain
the following plugin specification file (which contains information about the plugin):</p><pre class="screen">META-INF/apiman/plugin.json</pre><p>This <span class="emphasis"><em>plugin.json</em></span> file contains the basic meta-data that describes the plugin, and
should be of the following format:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "frameworkVersion" : 1.0,
  "name" : "Plugin Name",
  "description" : "A plugin description goes here.",
  "version" : "3.1.9"
}</pre><div class="itemizedlist"><ul><li><span class="strong"><strong>frameworkVersion</strong></span>: Indicates the apiman plugin framework version this plugin is compatible with - this should simply be 1.0 for now (reserved for future use)</li><li><span class="strong"><strong>name</strong></span>: The name of the plugin.</li><li><span class="strong"><strong>description</strong></span>: The description of the plugin.</li><li><span class="strong"><strong>version</strong></span>: The plugin version.</li></ul></div><p>If this <span class="emphasis"><em>plugin.json</em></span> file is missing from the plugin archive, then the plugin will
fail to load.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_using_maven_to_create_a_plugin"/>4.1.2. Using Maven to Create a Plugin</h3></div></div></div><p>One benefit of using WAR as the format of an apiman plugin is that plugins can easily
be created using Maven.  This section will describe how this can be done.  Note that
you can use the following simple plugin as a reference if you prefer:</p><p><a class="ulink" href="https://github.com/apiman/apiman-plugins/tree/master/noop-policy">https://github.com/apiman/apiman-plugins/tree/master/noop-policy</a></p><p>In order to create an apiman plugin using maven, simply create a new maven project
and set its <span class="emphasis"><em>packaging</em></span> type to <span class="strong"><strong>war</strong></span>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">packaging</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">war</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">packaging</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>Next, obviously feel free to include any dependencies you might need:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;apiman&nbsp;dependencies&nbsp;(must&nbsp;be&nbsp;excluded&nbsp;from&nbsp;the&nbsp;WAR)&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">io.apiman</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">apiman-gateway-engine-core</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">scope</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">provided</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">scope</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>You’ll want to make any apiman dependencies provided so that there aren’t any classloading
conflicts when executing your code.</p><p>Finally, we recommend that you put your plugin.json file in the following location
in your maven project:</p><pre class="screen">src/main/apiman</pre><p>Of course, any resoures in that location are not automatially included in the final
WAR, so you should add the following markup to your pom.xml:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">build</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">plugins</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">plugin</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.apache.maven.plugins</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">maven-war-plugin</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">failOnMissingWebXml</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">failOnMissingWebXml</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">webResources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">resource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">directory</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">src/main/apiman</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">directory</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">targetPath</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">META-INF/apiman</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">targetPath</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">filtering</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">true</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">filtering</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">resource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">webResources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">plugin</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">plugins</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">build</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>This markup will ensure that resources in the <span class="strong"><strong>src/main/apiman</strong></span> folder will be included
in the correct location in the WAR.  Also note that resource filtering is enabled,
which will make it easier to maintain your <span class="strong"><strong>plugin.json</strong></span> file:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "frameworkVersion" : 1.0,
  "name" : "My Plugin Name",
  "description" : "My plugin description.",
  "version" : "${project.version}"
}</pre><p>Note that the <span class="emphasis"><em>version</em></span> of the plugin is set to <span class="strong"><strong>${project.version}</strong></span>, which will get
automatically changed to the version of your maven project at build time.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_making_your_plugin_available_to_apiman"/>4.1.3. Making Your Plugin Available to apiman</h3></div></div></div><p>Plugins are identified by their Maven coordinates (groupId, artifactId, version,
classifier, type).  Note that the classifier and type are optional.  If the type is
not specified when loading a plugin, apiman will assume <span class="emphasis"><em>war</em></span>.</p><p>When loading a plugin for use, apiman will first check for the plugin in the local
user’s .m2 directory.  This is useful when running apiman during development, but
is unlikely to be available in a production environment.  If the plugin cannot be
found locally, apiman will attempt to download it from a remote repository such as
Maven Central.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You can configure additional remote repositories when you set up apiman.
Please refer to the Installation Guide for details.</p></div><p>This all means that when testing your plugin locally, you can simply use maven to install
it into your local .m2 directory and then ask apiman to load it.  In production, the
plugin will need to be available from a remote maven repository.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_contributing_a_policy"/>4.2. Contributing a Policy</h2></div></div></div><p>Now that you know how to create an apiman plugin, you might be wondering what you can
actually do with it!  The most important purpose of a plugin is to provide additional
<span class="strong"><strong>Policies</strong></span> that can be used when configuring Plans, Services, and Applications in
apiman.  Although apiman comes with a set of useful built-in policies, it is often
necessary for users to provide their own custom policies.  The best way to do that is
to create a plugin that provides such policies.</p><p>In order to provide a custom policy from a plugin, several things are needed:</p><div class="itemizedlist"><ul><li>An implementation of IPolicy (Java code)</li><li>A policy definition (JSON file)</li><li>An optional policy configuration form that the API Manager UI will present to the user when configuring the policy</li></ul></div><p>The next few sections explain each of these elements further, but note that they are
all included in the apiman plugin WAR.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_policy_implementation"/>4.2.1. Policy Implementation</h3></div></div></div><p>A policy implementation is the java code that is executed by the API Gateway when
a managed service request is made.  This is the bread and butter of the API Gateway; its
primary purpose.  For each request, the API Gateway creates a chain of policies that
must be executed before proxying the request to the back-end service implementation.
Each of the policies in that chain is an implementation of the <span class="emphasis"><em>IPolicy</em></span> interface.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_standard_ipolicy"/>4.2.1.1. Standard IPolicy</h4></div></div></div><p>All policies must implement the <code class="literal">IPolicy</code> interface, consisting of several methods.</p><p>The <code class="literal">apply</code> method with <code class="literal">ServiceRequest</code> is called during the request phase, and
the <code class="literal">apply</code> with <code class="literal">ServiceResponse</code> during the response phase:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;apply</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyContext</span><!-- <br/> --><span class="java_plain">&nbsp;context</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;config</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyChain</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;chain</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">void</span><span class="java_plain">&nbsp;apply</span><span class="java_separator">(</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;config</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyChain</span><span class="java_operator">&lt;</span><span class="java_type">ServiceResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">);</span></pre><p>The service objects, respectively, provide abstracted representations of the head
of a request and response for a given conversation. These can be modified in any
manner the implementor sees fit.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Policy instances are stateless, so it is not a good idea to use fields for any
reason.  The IPolicyContext can be used to pass information from the request phase
to the response phase.  Any state that must span multiple requests will need to use
one of the policy components described in the <span class="strong"><strong>Provided Components</strong></span> section.</p></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;parseConfiguration</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;jsonConfiguration</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">throws</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ConfigurationParseException</span><!-- <br/> --><span class="java_separator">;</span></pre><p>The final <code class="literal">IPolicy</code> method is used to parse JSON configuration into an arbitrary
object configuration which will be passed in in its parsed form to <code class="literal">doApply</code>, where
the implementor may cast it their native configuration object.  This method will
be invoked for each unique configuration of the policy.</p><p>For mroe information about policy configuration, see the <span class="strong"><strong>Policy Configuration</strong></span> section
below.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_indicating_successes"/>4.2.1.1.1. Indicating Successes</h5></div></div></div><p>If a policy determines that the conversation can continue, <code class="literal">chain.doApply</code> should
be signalled. Any modifications you wish to pass onto the next policy should be
completed and included in the invocation.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_indicating_failures"/>4.2.1.1.2. Indicating Failures</h5></div></div></div><p>If it is determined that a conversation should be interrupted for governance reasons
(i.e. according to business logic and not exceptional), then <code class="literal">chain.doFailure</code> should
be signalled. A useful <code class="literal">PolicyFailure</code> should be provided, which allows gateways to
respond in a sensible way to the requestor.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>The platform’s <code class="literal">IPolicyFailureFactoryComponent</code> can be used to generate failures.
See the <span class="strong"><strong>Provided Components</strong></span> section for more details on this component.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="_handling_exceptions"/>4.2.1.1.3. Handling Exceptions</h5></div></div></div><p>As a factor of the asynchronous nature of apiman, any exceptions that may occur during
the operation of a policy should be caught and explicitly handed to <code class="literal">chain.doError</code>.
If exceptions are left uncaught, then it is possible that they will be lost.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_idata_policy"/>4.2.1.2. IData Policy</h4></div></div></div><p>Whilst standard policies are concerned only with the head of the conversation, it
is also possible for policies to access and manipulate the body in transit. A data
policy must implement the <code class="literal">IDataPolicy</code> interface.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Handling of data streams is a performance sensitive area, implementors
should strive to be as efficient as possible and avoid any unnecessary interactions
with the stream.</p></div><p>The <code class="literal">getRequestDataHandler</code> and <code class="literal">getResponseDataHandler</code> methods are the data
corollaries of <code class="literal">apply</code>. Implementors must return <code class="literal">IReadWriteStream</code> streams, which
apiman uses to write data chunks into policies, and the policies write data to
subsequent policies:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">IReadWriteStream</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;getRequestDataHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyContext</span><!-- <br/> --><span class="java_plain">&nbsp;context</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">IReadWriteStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getResponseDataHandler</span><span class="java_separator">(</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">);</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not return an <code class="literal">IApimanBuffer</code> with a different native type than you
received. Use assign and append patterns instead.</p></div><p>Implementors must explicitly hand each chunk onto apiman when they are finished
interacting with it. A convenient way to achieve this is via <code class="literal">AbstractStream&lt;H&gt;</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Override</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IReadWriteStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceRequest</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getRequestDataHandler</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AbstractStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceRequest</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;write</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Mutate</span><span class="java_plain">&nbsp;chunk&nbsp;by&nbsp;appending&nbsp;a&nbsp;string</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_literal">&quot;my&nbsp;modification&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">'re&nbsp;finished</span><span class="java_operator">:</span><span class="java_plain">&nbsp;write&nbsp;the&nbsp;chunk&nbsp;back&nbsp;to&nbsp;apiman</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;using&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">().</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">chunk</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;end</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">End</span><span class="java_plain">&nbsp;of&nbsp;stream&nbsp;signalled</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;cleanup</span><span class="java_separator">,</span><span class="java_plain">&nbsp;etc</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">end</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not mutate an <code class="literal">IApimanBuffer</code> once handed over.</p></div><p>The request or response body will not begin streaming before the corresponding <code class="literal">doApply</code>
has been called, however, it is still possible to interrupt the conversation during
the streaming phase by signalling <code class="literal">doFailure</code> or <code class="literal">doError</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_performance_considerations"/>4.2.1.3. Performance Considerations</h4></div></div></div><p>Policies are amongst the most impactful elements of the system for performance. To
minimise the impact of a policy implementors may wish to follow these guidelines:</p><div class="itemizedlist"><ul><li>Maintain as little state within a policy instance as possible.</li><li>Call <code class="literal">doApply</code>, <code class="literal">doFailure</code> or <code class="literal">doError</code> as soon as possible.</li><li>Data policies should interact with the data stream as efficiently as possible and prefer mutating in-place (especially with small changes).</li><li>If you are contributing a policy to apiman: implement any long-running tasks asynchronously (e.g. database calls); <span class="strong"><strong>do not</strong></span> block the main thread (e.g. blocking futures, wait, sleep); use asynchronous techniques to interact with the outside world, such as callbacks.</li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_dependencies"/>4.2.1.4. Dependencies</h4></div></div></div><p>Typically a policy implementation should minimize the number of third party libraries
it depends on, but often times this is unavoidable.  Plugins are isolated from one
another, so it is a simple matter of including any required dependencies inside the
plugin’s WAR archive in the standard location of:</p><pre class="screen">WEB-INF/lib</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You should make sure that any apiman dependencies you use (for example the apiman
core module that contains the IPlugin and other necessary interfaces) are marked
as <span class="emphasis"><em>provided</em></span> in your maven project so that they are not included in the plugin
archive.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_provided_components"/>4.2.1.5. Provided Components</h4></div></div></div><p>All policy implementations have access to various resources at runtime.  These resources
are primarily accessed through the <span class="strong"><strong>IPolicyContext</strong></span> object that is passed to the policy
when it is executed.  Along with the ability to set conversation-level attributes, the
policy context is how you access Policy Components.</p><p>A Policy Component is simply a runtime component that a policy implementation may find
useful.  To access a component, use the <span class="emphasis"><em>getComponent</em></span> method found on the policy
context, passing it the interface of the component you wish to use.  The following
components are available:</p><div class="itemizedlist"><ul><li><span class="strong"><strong>IPolicyFailureFactoryComponent</strong></span>: Used to create a policy failure that is needed to call <span class="emphasis"><em>doFailure</em></span> on the policy chain (indicating that the policy failed).</li><li><span class="strong"><strong>ISharedStateComponent</strong></span>: Used to share state information across the conversation boundary.</li><li><span class="strong"><strong>IHttpClientComponent</strong></span>: Allows HTTP requests to be made from within a policy.</li><li><span class="strong"><strong>IRateLimiterComponent</strong></span>: Supports standard quota/rate limiting behavior, maintaining the current number of requests.</li></ul></div><p>All of the components have asynchronous APIs in order to better support the runtime
philosophy in the API Gateway.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>For more information about each component, see its javadoc.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_policy_definition"/>4.2.2. Policy Definition</h3></div></div></div><p>The policy implementation is what allows the API Gateway to execute the policy at runtime.
But how does the API Manager know about the policy so that users can add it to a Plan,
Service, or Application from within the User Interface?  The answer is that the plugin
must also include a Policy Definition JSON file for each policy it is providing.</p><p>A plugin definition is a JSON file that must be located within the plugin archive
here:</p><pre class="screen">META-INF/apiman/policyDefs</pre><p>The plugin definition file takes the following form:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "id" : "policy_name",
  "name" : "Policy Name",
  "description" : "A useful description of what the policy does.",
  "policyImpl" : "plugin:${project.groupId}:${project.artifactId}:${project.version}:${project.packaging}/com.example.plugins.MyFirstPolicy",
  "icon" : "document",
  "formType" : "JsonSchema",
  "form" : "schemas/policy_name.schema"
}</pre><div class="itemizedlist"><ul><li><span class="strong"><strong>id</strong></span>: The unique id of the policy.</li><li><span class="strong"><strong>name</strong></span>: The name of the policy.</li><li><span class="strong"><strong>description</strong></span>: The description of the policy.</li><li><span class="strong"><strong>policyImpl</strong></span>: Identifies the java class that implements the policy.</li><li><span class="strong"><strong>icon</strong></span>: The icon to use when displaying the policy in the UI (name of a Font Awesome icon).</li><li><span class="strong"><strong>formType</strong></span>: The type of form to use in the UI when configuring an instance of the policy.  See the Policy Configuration section below for details.  Valid values: <span class="emphasis"><em>Default</em></span>, <span class="emphasis"><em>JsonSchema</em></span></li><li><span class="strong"><strong>form</strong></span>: (<span class="emphasis"><em>optional</em></span>) Path to a UI form that should be used when configuring an instance of the policy.  See the Policy Configuration section below for details.</li></ul></div><p>The most important thing to get right in this file is probably the <span class="emphasis"><em>policyImpl</em></span>.  This
is the information that the API Manager will use when it tries to instantiate the
policy implementation at runtime.  For policies that come from plugins, the format
of the <span class="emphasis"><em>policyImpl</em></span> is:</p><pre class="screen">plugin:{pluginGroupId}:{pluginArtifactId}:{pluginVersion}:{pluginType}/{fullyQualifiedClassname}</pre><p>An example of what this string might look like if you cracked open a valid apiman plugin
and had a peek at one of its policy definition files is:</p><pre class="screen">plugin:io.apiman.plugins:apiman-plugins-example:6.3.3.Final:war/io.apiman.plugins.example.ExamplePolicy</pre><p>When building your plugin using the recommended maven configuration documented in the
<span class="strong"><strong>Using Maven to Create a Plugin</strong></span> section, it is extremely convenient to simply let
Maven set the values for you:</p><pre class="screen">plugin:${project.groupId}:${project.artifactId}:${project.version}:${project.packaging}/com.example.plugins.ExamplePolicy</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_policy_configuration_form"/>4.2.3. Policy Configuration Form</h3></div></div></div><p>You may be wondering how configuration information specific to a Plan, Service, or
Application is managed.  Since the same policy implementation instance is used for all
requests, unique configuration appropriate to a particular request must be passed to
the policy implementation when it is executed.  This configuration is created in the
API Manager user interface when adding the policy to a Plan, Service, or Application.</p><p>Policy configuration takes the form of string data that is ultimately included when
publishing a service to the API Gateway.  That string data is parsed into a Java object
via the <span class="emphasis"><em>parseConfiguration</em></span> on the <span class="strong"><strong>IPolicy</strong></span> interface and then passed to the policy
during execution.</p><p>The string data is created in the API Manager user interface, either by interacting with
a Policy Configuration Form contributed by the plugin, or (if no form is included
in the plugin) by a default configuration form (a simple text area).</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_default_policy_configuration"/>4.2.3.1. Default Policy Configuration</h4></div></div></div><p>If the policy definition indicates that the configuration form type is <span class="strong"><strong>Default</strong></span>, then it is
up to the UI to determine how to display configuration information.  For the policies provided
by apiman itself, there are UI forms provided.  If the policy is contributed from a plugin,
then the UI has no way to know the format of the configuration data.  In this case, a simple
TextArea is presented to the user.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>This approach is clearly not recommended, because users will likely have no idea what to
enter into the TextArea presented to them.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_json_schema_policy_configuration"/>4.2.3.2. JSON Schema Policy Configuration</h4></div></div></div><p>Alternatively, the policy definition can specify a <a class="ulink" href="http://json-schema.org/">JSON Schema</a> in
the policy definition JSON file.  For example, the policy definition might include the
following:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">  "formType" : "JsonSchema",
  "form" : "schemas/policy_name.schema"</pre><p>In this case, apiman will look for a file inside the plugin artifact in the following location:</p><pre class="screen">META-INF/apiman/policyDefs/schemas/policy_name.schema</pre><p>The file in this location must be a JSON Schema file, which describes the JSON format of the
configuration data expected by the policy implementation.  The UI will use this JSON schema
to generate an appropriate UI form that can edit the JSON configuration data needed by the
policy implementation.</p><p>Perhaps it’s best if we have an example.  The following illustrates a policy contributed from
a plugin, its JSON Schema file, the resulting form displayed in the UI, and the configuration
data format that will be passed to the policy implementation at runtime.</p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">META-INF/apiman/policyDefs/my-policy.json</h5><p class="formalpara">
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "id" : "my-policy",
  "name" : "My First Policy",
  "description" : "A policy with custom configuration!",
  "policyImpl" : "plugin:${project.groupId}:${project.artifactId}:${project.version}:${project.packaging}/io.apiman.plugins.config_policy.ConfigPolicy",
  "icon" : "pie-chart",
  "formType" : "JsonSchema",
  "templates" : [
    {
      "language": null,
      "template": "Set policy with @{property1} and @{property2}!"
    }
  ],
  "form" : "schemas/config-policyDef.schema"
}</pre><p class="formalpara">
</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>The templates <span class="emphasis"><em>language</em></span> field will support other languages in future, but
for now is null (i.e. single-language only). The template field itself is
<a class="ulink" href="https://github.com/mvel/mvel">MVEL</a> (Orb tag syntax), and displays in the UI
after a plugin has been selected by a user.</p></div><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">META-INF/apiman/policyDefs/schemas/my-policy.schema</h5><p class="formalpara">
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "title" : "Configure My Policy",
  "description" : "Configure all of the necessary properties used by my policy.",
  "type" : "object",
  "properties": {
    "property1": {
      "title" : "Property 1",
      "type" : "string",
      "minLength" : 1,
      "maxLength" : 64
      },
    "property2": {
      "title" : "Property 2",
      "type" : "string",
      "minLength" : 1,
      "maxLength" : 64
    }
  }
}</pre><p class="formalpara">
</p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Generated UI Form</h5><p class="formalpara"><span class="inlinemediaobject"><img src="images/images/plugin-policy-config-1.png" alt="Generated UI Form"/></span></p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">JSON Configuration Data Format</h5><p class="formalpara">
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JSON">{
  "property1" : "USER_DATA_1",
  "property2" : "USER_DATA_2"
}</pre><p class="formalpara">
</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You can easily consume the JSON configuration data above in your policy implementation
by having your policy implementation Java class extend the <code class="literal">AbstractMappedPolicy</code> base class
provided by apiman (in the <span class="emphasis"><em>apiman-gateway-engine-policies</em></span> module) and creating a simple Java Bean
to hold the JSON configuration data.</p></div><p>First, here is the java bean used to (un)marshal the JSON configuration data.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">MyConfigBean</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Serializable</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">long</span><span class="java_plain">&nbsp;serialVersionUID&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">683486516910591477L</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;property1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;property2</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;*&nbsp;Constructor.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getProperty1</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;property1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setProperty1</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;property1</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">property1&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;property1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getProperty2</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;property2</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setProperty2</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;property2</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">property2&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;property2</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Now have a look at how to use that class when extending the <code class="literal">AbstractMappedPolicy</code>.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">MyPolicy</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">AbstractMappedPolicy</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">MyConfigBean</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;*&nbsp;Constructor.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">MyPolicy</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">protected</span><span class="java_plain">&nbsp;</span><span class="java_type">Class</span><span class="java_operator">&lt;</span><span class="java_type">MyConfigBean</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getConfigurationClass</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">protected</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;doApply</span><span class="java_separator">(</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_plain">&nbsp;config</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyChain</span><span class="java_operator">&lt;</span><span class="java_type">ServiceRequest</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Do</span><span class="java_plain">&nbsp;something&nbsp;with&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_plain">&nbsp;here</span><span class="java_operator">?</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">It</span><span class="java_plain">&nbsp;has&nbsp;all&nbsp;the&nbsp;configuration&nbsp;data</span><span class="java_operator">!</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">doApply</span><span class="java_separator">(</span><span class="java_plain">request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">My</span><span class="java_separator">,</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">protected</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;doApply</span><span class="java_separator">(</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_plain">&nbsp;config</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyChain</span><span class="java_operator">&lt;</span><span class="java_type">ServiceResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Do</span><span class="java_plain">&nbsp;something&nbsp;with&nbsp;</span><span class="java_type">MyConfigBean</span><span class="java_plain">&nbsp;here</span><span class="java_operator">?</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">It</span><span class="java_plain">&nbsp;has&nbsp;all&nbsp;the&nbsp;configuration&nbsp;data</span><span class="java_operator">!</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">doApply</span><span class="java_separator">(</span><span class="java_plain">response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;config</span><span class="java_separator">,</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_json_schema_policy_configuration_sdk"/>4.2.3.3. JSON Schema Policy Configuration SDK</h4></div></div></div><p>If you are creating a non-trivial JSON Schema (more than just a couple of simple fields)
it can be difficult to get it right without a few iterations.  For this reason, we have
created a simple "SDK" to help you create your JSON Schema quickly.  The SDK can be found
in the apiman github repository at the following location:</p><pre class="screen">manager/ui/war/src/main/sdk/json-schema.html</pre><p>If you have the apiman source code checked out, you can simply open that file in your browser
and start using it to author a custom JSON Schema.</p><p>Alternatively you can use "rawgit" and just go straight to the following URL:</p><p><a class="ulink" href="http://rawgit.com/apiman/apiman/master/manager/ui/war/src/main/sdk/json-schema.html">http://rawgit.com/apiman/apiman/master/manager/ui/war/src/main/sdk/json-schema.html</a></p><p>The SDK provides a way to edit your JSON schema and then see how that schema will look in
the apiman UI, as well as the format that the policy configuration data will ultimately
be in when it is sent to your policy at runtime.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Once you have the JSON Schema finalized, you could also use the online <a class="ulink" href="http://www.jsonschema2pojo.org/">jsonschema2pojo</a>
tool to generate a good starting point for a Java Bean that can be used to marshal/unmarshal your policy’s configuration
data at runtime.  See the discussion about AbstractMappedPolicy above for additional information.</p></div></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_testing_a_plugin_policy"/>4.3. Testing a Plugin Policy</h2></div></div></div><p>While it is quite simple to create a custom policy for apiman, you may be wondering the best way to
unit test your implementation.  Fortunately we have made this extremely easy by including an easy-to-use
Policy Testing junit framework.  Once you have followed the instructions above to create your custom
policy, refer to this section to learn how to test it using junit.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_import_the_framework_maven_dependency"/>4.3.1. Import the Framework (Maven Dependency)</h3></div></div></div><p>The first thing you will need is to include the appropriate maven dependencies in your project’s
pom.xml file.  There is a single additional dependency that you will need (make sure to import it using
the <span class="emphasis"><em>test</em></span> maven scope):</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">io.apiman</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">apiman-test-policies</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">1.1.2-SNAPSHOT</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">scope</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">test</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">scope</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_create_and_annotate_a_junit_test_case"/>4.3.2. Create and Annotate a JUnit Test Case</h3></div></div></div><p>Once you have imported the appropriate dependency, you can go ahead and create a JUnit test case.  The
only additional thing you need is to annotate your test case appropriately and make sure your test case
Java class extends the framework’s <span class="emphasis"><em>ApimanPolicyTest</em></span> base class.</p><p>The following annotations can then be added to your test:</p><div class="itemizedlist"><ul><li>@TestingPolicy(&lt;classname&gt;) - indicates which of your policy implementations you wish to test</li><li>@Configuration("&lt;custom_policy_configuration_data&gt;") - specifies the policy configuration to use for the test</li></ul></div><p>The @TestingPolicy annotation is always placed at the class level, but the @Configuration annotation can
either be global or specified at the test method level.</p><p>These annotations tell the apiman Policy Testing framework <span class="strong"><strong>what</strong></span> policy you want to test and the
policy configuration you want to use when testsing, but you still need to actually send requests to a
"service".  This is done using the "send(PolicyTestReqest)" method defined by the base class.  The
send() method allows you to send a request (that you build) to the mock back-end service governed by
your policy.  By default the mock back-end service is a simple "echo" service that responds to all
requests with a JSON payload describing the request it received (more on how to override this default
functionality later).</p><p>The send() method requires that you create and pass to it a valid PolicyTestRequest object.  This can
be created using the PolicyTestRequest.build() method.  You can set the request’s type, resource path,
request headers, and body.  If the request is successful, then a PolicyTestResponse object will be
returned and you can perform assertions on it.  If there is a policy failure, then the send() method
will throw a PolicyFailureError.</p><p>Here is a full example of everything working together:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">TestingPolicy</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">CustomPolicy</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">CustomPolicyTest</span><span class="java_plain">&nbsp;</span><span class="java_keyword">extends</span><span class="java_plain">&nbsp;</span><span class="java_type">ApimanPolicyTest</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Test</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Configuration</span><span class="java_separator">(</span><span class="java_literal">&quot;{}&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;testGet</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Throwable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Send</span><span class="java_plain">&nbsp;a&nbsp;test&nbsp;HTTP&nbsp;request&nbsp;to&nbsp;the&nbsp;service&nbsp;</span><span class="java_separator">(</span><span class="java_plain">resulting&nbsp;in&nbsp;executing&nbsp;the&nbsp;policy</span><span class="java_separator">).</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">PolicyTestResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;send</span><span class="java_separator">(</span><span class="java_type">PolicyTestRequest</span><span class="java_separator">.</span><span class="java_plain">build</span><span class="java_separator">(</span><span class="java_type">PolicyTestRequestType</span><span class="java_separator">.</span><span class="java_plain">GET</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;/some/resource&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">header</span><span class="java_separator">(</span><span class="java_literal">&quot;X-Test-Name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;testGet&quot;</span><span class="java_separator">));</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Now</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;some&nbsp;assertions&nbsp;on&nbsp;the&nbsp;result</span><span class="java_operator">!</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">200</span><span class="java_separator">,</span><span class="java_plain">&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">code</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">EchoResponse</span><span class="java_plain">&nbsp;entity&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_type">EchoResponse</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">&quot;GET&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">.</span><span class="java_plain">getMethod</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">&quot;/some/resource&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">.</span><span class="java_plain">getResource</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">&quot;testGet&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">.</span><span class="java_plain">getHeaders</span><span class="java_separator">().</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">&quot;X-Test-Name&quot;</span><span class="java_separator">));</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Assert</span><span class="java_plain">&nbsp;the&nbsp;request&nbsp;header&nbsp;that&nbsp;was&nbsp;added&nbsp;by&nbsp;the&nbsp;policy</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">&quot;Hello&nbsp;World&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">.</span><span class="java_plain">getHeaders</span><span class="java_separator">().</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">&quot;X-MTP-Header&quot;</span><span class="java_separator">));</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Assert</span><span class="java_plain">&nbsp;the&nbsp;response&nbsp;header&nbsp;was&nbsp;added&nbsp;by&nbsp;the&nbsp;policy</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Assert</span><span class="java_separator">.</span><span class="java_plain">assertEquals</span><span class="java_separator">(</span><span class="java_literal">&quot;Goodbye&nbsp;World&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">header</span><span class="java_separator">(</span><span class="java_literal">&quot;X-MTP-Response-Header&quot;</span><span class="java_separator">));</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_providing_a_custom_back_end_service_mock"/>4.3.3. Providing a Custom Back-End Service Mock</h3></div></div></div><p>Sometimes the echo service is not sufficient when testing your custom policy.  Perhaps the custom policy
is more tightly coupled to the service it is protecting.  In this case you may want to provide your own
custom back-end service mock implementation.  This can be done by simply annotating either the class or
an individual test method with @BackEndService.  If you do this then you must supply the annotation with
a class that implements the IPolicyTestBackEndService interface.  Here is an example of what this might
look like in a test:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">TestingPolicy</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">CustomPolicy</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">CustomPolicyTest</span><span class="java_plain">&nbsp;</span><span class="java_keyword">extends</span><span class="java_plain">&nbsp;</span><span class="java_type">ApimanPolicyTest</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Test</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Configuration</span><span class="java_separator">(</span><span class="java_literal">&quot;{}&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">BackEndService</span><span class="java_separator">(</span><span class="java_type">MyCustomBackEndServiceImpl</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;testGetWithCustomBackEndSvc</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">Throwable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Send</span><span class="java_plain">&nbsp;a&nbsp;test&nbsp;HTTP&nbsp;request&nbsp;to&nbsp;the&nbsp;service&nbsp;</span><span class="java_separator">(</span><span class="java_plain">resulting&nbsp;in&nbsp;executing&nbsp;the&nbsp;policy</span><span class="java_separator">).</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">PolicyTestResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;send</span><span class="java_separator">(</span><span class="java_type">PolicyTestRequest</span><span class="java_separator">.</span><span class="java_plain">build</span><span class="java_separator">(</span><span class="java_type">PolicyTestRequestType</span><span class="java_separator">.</span><span class="java_plain">GET</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;/some/resource&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">header</span><span class="java_separator">(</span><span class="java_literal">&quot;X-Test-Name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;testGet&quot;</span><span class="java_separator">));</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Now</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;some&nbsp;assertions&nbsp;on&nbsp;the&nbsp;result</span><span class="java_operator">!</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">MyCustomBackEndServiceResponseBean</span><span class="java_plain">&nbsp;entity&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">entity</span><span class="java_separator">(</span><span class="java_type">MyCustomBackEndServiceResponseBean</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>In this example everything works as it did before, but instead of responding with an Echo Response
the send() method will return with a custom response (as created and returned by the provided custom
back-end service implementation).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_contributing_a_core_component"/>4.4. Contributing a Core Component</h2></div></div></div><p>In addition to policies, the apiman plugin framework allows developers to provide custom implementations
of core apiman components.  What does this mean?  Apiman is composed of a number of different core
components, all working together to provide API Management functionality.  Both the API Gateway and
the API Manager have core components that can be customized by providing new implementations via plugins.</p><p>Some examples of API Manager components include (but are not limited to):</p><div class="itemizedlist"><ul><li>Storage Component</li><li>Query Component</li><li>IDM Component</li><li>Metrics Accessor (consumes metrics data recorded by the API Gateway at runtime)</li></ul></div><p>Additionally, some examples of API Gateway components include:</p><div class="itemizedlist"><ul><li>Configuration Registry</li><li>Rate Limiting Component</li><li>Metrics Emitter (records metrics data for each request)</li></ul></div><p>By default, the apiman quickstart uses default values for all of these, resulting in a stable, working
system with the following characteristics:</p><div class="itemizedlist"><ul><li>Stores API Manager data in a JDBC database</li><li>Records and queries metrics data via Elasticsearch</li><li>Stores Gateway configuration information in Elasticsearch</li><li>Uses Elasticsearch to share rate limiting state across gateway nodes</li></ul></div><p>However, if you wish to provide a custom implementation of something, you can implement the appropriate
Java interface for the correct component, bundle the implementation up into a plugin, and then tell
apiman to use yours instead of the default.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_implementing_a_custom_core_component"/>4.4.1. Implementing a Custom Core Component</h3></div></div></div><p>The procedure for creating a plugin to hold your custom component is exactly the same as already
described in the <span class="strong"><strong>Creating a Plugin</strong></span> section above.  Once you have created your plugin, including
a custom implementation of a core component is simply a matter of creating a Java class that
implements the appropriate component interface.</p><p>Let’s try an example.</p><p>By default, apiman stores API Gateway configuration in Elasticsearch.  The component responsible
for this is called ESRegistry, and it implements this interface:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">package</span><!-- <br/> --><span class="java_plain">&nbsp;io</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">apiman</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">gateway</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">engine</span><!-- <br/> --><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">interface</span><span class="java_plain">&nbsp;</span><span class="java_type">IRegistry</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;getContract</span><span class="java_separator">(</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">ServiceContract</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;publishService</span><span class="java_separator">(</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;retireService</span><span class="java_separator">(</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;registerApplication</span><span class="java_separator">(</span><span class="java_type">Application</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;unregisterApplication</span><span class="java_separator">(</span><span class="java_type">Application</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;getService</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;organizationId</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;serviceId</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;serviceVersion</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Service</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Perhaps you’d rather store the API Gateway configuration information into mongodb instead of
Elasticsearch.  Since we don’t support a mongodb registry, you would need to implement your own
and contribute it via a plugin.  Simple create a new plugin and include in it the following
Java class:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">package</span><!-- <br/> --><span class="java_plain">&nbsp;org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">example</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">apiman</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">plugins</span><!-- <br/> --><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">MongoDbRegistry</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">IRegistry</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">MongoDbRegistry</span><span class="java_separator">(</span><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;config</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;consume&nbsp;any&nbsp;config&nbsp;params&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;these&nbsp;come&nbsp;from&nbsp;apiman</span><span class="java_separator">.</span><span class="java_plain">properties</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;getContract</span><span class="java_separator">(</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">ServiceContract</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;publishService</span><span class="java_separator">(</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;retireService</span><span class="java_separator">(</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;registerApplication</span><span class="java_separator">(</span><span class="java_type">Application</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;unregisterApplication</span><span class="java_separator">(</span><span class="java_type">Application</span><span class="java_plain">&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;getService</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;organizationId</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;serviceId</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;serviceVersion</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">Service</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;handler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;TODO&nbsp;implement&nbsp;mongodb&nbsp;specific&nbsp;logic&nbsp;here</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>While optional, it is often useful to provide a constructor that takes a map of configuration
params.  These values comes from the <span class="strong"><strong>apiman.properties</strong></span> and is an arbitrary set of keys/values.  It
can be extremely helpful when, for example, configuring the mongodb connection information.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_enabling_your_custom_component"/>4.4.2. Enabling Your Custom Component</h3></div></div></div><p>Now that you have a custom component built and included in a plugin, you will need to make sure
that the plugin is available to your server.  You can do this by deploying the plugin artifact
to a maven repository and then making that repository available to apiman by adding its URL to
the following property in <span class="strong"><strong>apiman.properties</strong></span>:</p><pre class="screen">apiman.plugins.repositories=http://repository.jboss.org/nexus/content/groups/public/</pre><p>Simply add your organization’s maven repository to that (the value can be a comma separated list of
URLs).</p><p>Alternatively, you can make sure your plugin is installed in the ".m2" directory on the machine
that is running your server.  Obviously you can use "mvn install" to accomplish this.</p><p>Next, simply enable the custom component implementation by updating your <span class="strong"><strong>apiman.properties</strong></span> file
like this (for example):</p><pre class="screen">apiman-gateway.registry=plugin:GROUP_ID:ARTIFACT_ID:VERSION/org.example.apiman.plugins.MongoDbRegistry
apiman-gateway.registry.mongo.host=localhost
apiman-gateway.registry.mongo.port=27017
apiman-gateway.registry.mongo.username=sa
apiman-gateway.registry.mongo.password=sa123!
apiman-gateway.registry.mongo.database=apiman</pre><p>The most important part above is the format for the registry itself.  It might look something like
this:</p><pre class="screen">apiman-gateway.registry=plugin:org.example.apiman-plugins:plugin-mongodb:1.0.0.Final/org.example.apiman.plugins.MongoDbRegistry</pre><p>Finally, the set of properties prefixed with "apiman-gateway.registry" will be processed and passed
to your <span class="strong"><strong>MongoDbRegistry</strong></span> class’s <span class="strong"><strong>Map</strong></span> constructor if one is provided.  The map that is passed to
the constructor will contain the following:</p><pre class="screen">mongo.host=localhost
mongo.port=27017
mongo.username=sa
mongo.password=sa123!
mongo.database=apiman</pre></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_gateway_implementations"/>Chapter 5. Gateway Implementations</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_implementing_iapimanbuffer">5.1. Implementing IApimanBuffer</a></span></dt><dt><span class="section"><a href="#_executing_apiman_core">5.2. Executing apiman-core</a></span></dt><dd><dl><dt><span class="section"><a href="#_streaming_data">5.2.1. Streaming data</a></span></dt><dt><span class="section"><a href="#_handling_results">5.2.2. Handling results</a></span></dt><dt><span class="section"><a href="#_handling_failures">5.2.3. Handling Failures</a></span></dt></dl></dd><dt><span class="section"><a href="#_creating_a_service_connector">5.3. Creating a Service Connector</a></span></dt><dd><dl><dt><span class="section"><a href="#_connector_basics">5.3.1. Connector basics</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnection">5.3.2. Creating the IServiceConnection</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnectionresponse">5.3.3. Creating the IServiceConnectionResponse</a></span></dt><dt><span class="section"><a href="#_implementation_strategies">5.3.4. Implementation strategies</a></span></dt></dl></dd></dl></div><p>At the heart of any apiman gateway implementation is the flexible, lightweight
apiman-core. The core serves to execute policies upon the traffic passing through
it, determining whether a given conversation should continue or not.</p><p>A set of simple, asynchronous interfaces are provided which an implementor should
fulfill using the platform’s native functionality to allow apiman to interact with
its various components and services.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_implementing_iapimanbuffer"/>5.1. Implementing IApimanBuffer</h2></div></div></div><p>Before you can send any data through apiman, you must implement the <code class="literal">IApimanBuffer</code> interface. It provides a set of methods which allow apiman to access your native buffer format as effectively as possible. Any data you pass into apiman must be wrapped in your implementation of <code class="literal">IApimanBuffer</code>, whilst any data returned to you by apiman will be an <code class="literal">IApimanBuffer</code> which you can extricate your native buffer from.</p><p>Implementation is fairy self explanatory, but a few points are worth noting:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">YourApimanBufferImpl</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IApimanBuffer</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">VertxApimanBuffer</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">nativeBuffer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;is&nbsp;your&nbsp;mechanism&nbsp;to&nbsp;efficiently&nbsp;yank&nbsp;your&nbsp;</span><span class="java_keyword">native</span><span class="java_plain">&nbsp;buffer&nbsp;back</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;getNativeBuffer</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;length</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">.</span><span class="java_plain">length</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;insert</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_plain">&nbsp;index</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;buffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;nativeBuffer</span><span class="java_separator">.</span><span class="java_plain">setBuffer</span><span class="java_separator">(</span><span class="java_plain">index</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Buffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;buffer</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_separator">...</span><span class="java_operator">&gt;</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Implementors of <code class="literal">IApimanBuffer</code> should ensure that the native format is preserved within the instance, this allows it to be retrieved again using <code class="literal">getNativeBuffer</code>. Any mutation should be on the native buffer.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_executing_apiman_core"/>5.2. Executing apiman-core</h2></div></div></div><p>Let’s consider the following snippet:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">IEngine</span><!-- <br/> --><span class="java_plain">&nbsp;engine&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">your&nbsp;engine</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEngine</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Request</span><span class="java_plain">&nbsp;executor</span><span class="java_separator">,</span><span class="java_plain">&nbsp;through&nbsp;which&nbsp;we&nbsp;can&nbsp;send&nbsp;chunks&nbsp;and&nbsp;indicate&nbsp;end</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceRequestExecutor</span><span class="java_plain">&nbsp;requestExecutor&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engine</span><span class="java_separator">.</span><span class="java_plain">executor</span><span class="java_separator">(</span><span class="java_plain">request</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IAsyncResult</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;result</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;streamHandler&nbsp;called&nbsp;when&nbsp;back</span><span class="java_operator">-</span><span class="java_plain">end&nbsp;connector&nbsp;is&nbsp;ready&nbsp;to&nbsp;receive&nbsp;data</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">requestExecutor</span><span class="java_separator">.</span><span class="java_plain">streamHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnection</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;writeStream</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Execute</span><span class="java_plain">&nbsp;the&nbsp;request</span>
<!--  --><br/><span class="java_plain">executor</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">();</span></pre><p>After instantiating your engine implementation, you can call <code class="literal">execute</code>. This is the main point through which you pipe data into and out of apiman. In order to avoid any buffering you must write body data through <code class="literal">streamHandler</code>'s <code class="literal">IServiceConnection</code> which will be called when the connection to the backend service is ready to receive. The result is provided to <code class="literal">executor</code>'s <code class="literal">IAsyncResultHandler</code>, which can be evaluated to determine the result of the call, and, if successful, retrieve a <code class="literal">ServiceResponse</code> and attach handlers to receive response data.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_streaming_data"/>5.2.1. Streaming data</h3></div></div></div><p>Exploring <code class="literal">streamHandler</code> further:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">requestExecutor</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">streamHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IAsyncHandler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">IServiceConnection</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;writeStream</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Just</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;illustrative&nbsp;purposes</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;apimanBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">YourApimanBufferImpl</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Call</span><span class="java_plain">&nbsp;#write&nbsp;as&nbsp;many&nbsp;times&nbsp;as&nbsp;desired</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;writeStream</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">apimanBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Call</span><span class="java_plain">&nbsp;#end&nbsp;only&nbsp;once</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;writeStream</span><span class="java_separator">.</span><span class="java_plain">end</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Any data flowing into the executor must first be wrapped in your implementation of <code class="literal">IApimanBuffer</code> before being passed to <code class="literal">write</code>. You may call <code class="literal">write</code> an unlimited number of times, and indicate that transmission has completed by signalling <code class="literal">end</code>.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>No further calls to <code class="literal">write</code> should occur after <code class="literal">end</code> has been called.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_handling_results"/>5.2.2. Handling results</h3></div></div></div><p>An excerpt of the executor’s result handler and considering a successful result:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">engine</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">executor</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IAsyncResultHandler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">IEngineResult</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IAsyncResult</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;result</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Did</span><span class="java_plain">&nbsp;an&nbsp;exception&nbsp;occur</span><span class="java_operator">?</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">result</span><span class="java_separator">.</span><span class="java_plain">isSuccess</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IEngineResult</span><span class="java_plain">&nbsp;engineResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;result</span><span class="java_separator">.</span><span class="java_plain">getResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">engineResult</span><span class="java_separator">.</span><span class="java_plain">isResponse</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Our</span><span class="java_plain">&nbsp;successfully&nbsp;returned&nbsp;service&nbsp;response</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getServiceResponse</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;a&nbsp;bodyHandler&nbsp;to&nbsp;receive&nbsp;the&nbsp;response's&nbsp;body&nbsp;chunks</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">bodyHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Important</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;efficiency</span><span class="java_separator">,</span><span class="java_plain">&nbsp;retrieve&nbsp;</span><span class="java_keyword">native</span><span class="java_plain">&nbsp;buffer&nbsp;format&nbsp;directly&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;possible</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_keyword">instanceof</span><span class="java_plain">&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;buffer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;an&nbsp;endHandler&nbsp;to&nbsp;receive&nbsp;the&nbsp;end&nbsp;signal</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">endHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">Void</span><span class="java_plain">&nbsp;flag</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Transmission</span><span class="java_plain">&nbsp;has&nbsp;now&nbsp;completed</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;policy&nbsp;failure</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;exception</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">});</span></pre><p>After testing <code class="literal">IAsyncResult.isSuccess</code>, we can be certain that the request completed without an exception occurring. Next, we verify <code class="literal">IEngineResult.isFailure</code>, which indicates whether there was a policy failure or the response returned successfully.</p><p>Upon success the <code class="literal">ServiceResponse</code> can be extracted, and a <code class="literal">bodyHandler</code> and <code class="literal">endHandler</code> can be attached in order to receive the response’s associated data as it arrives. At this point the data has exited apiman, and can handled as makes sense for your implementation. For instance, you may wish to translate the <code class="literal">ServiceResponse</code> into its native equivalent and return it to the requestor.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Where possible, it is advisable to use <code class="literal">getNativeBuffer</code> on any <code class="literal">IApimanBuffer</code> chunks you receive; avoiding any expensive format conversions. You must cast it back to your native format; <code class="literal">instanceof</code> is helpful to ensure the the correct type has been received.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_handling_failures"/>5.2.3. Handling Failures</h3></div></div></div><p>In the case of errors or policy failures, a variety of information is provided which can be used to construct a sensible response:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">if</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">result</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">isSuccess</span><!-- <br/> --><span class="java_separator">())</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IEngineResult</span><span class="java_plain">&nbsp;engineResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;result</span><span class="java_separator">.</span><span class="java_plain">getResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_operator">!</span><span class="java_plain">engineResult</span><span class="java_separator">.</span><span class="java_plain">isFailure</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_separator">...</span><span class="java_operator">&gt;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">PolicyFailure</span><span class="java_plain">&nbsp;policyFailure&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getPolicyFailure</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;type:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getType</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;code:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getFailureCode</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;Message:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getMessage</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;Headers:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getHeaders</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">Throwable</span><span class="java_plain">&nbsp;throwable&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getError</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">error</span><span class="java_separator">(</span><span class="java_literal">&quot;Something&nbsp;bad&nbsp;happened:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;throwable</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The appropriate response to failures will vary widely depending upon implementation. For instance, a RESTful platform may wish to transmit an appropriate HTTP error code, message and possibly body.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_creating_a_service_connector"/>5.3. Creating a Service Connector</h2></div></div></div><p>Connectors enable apiman to transmit and receive data from the backend services under management. For instance, should your system need to connect to an HTTP service, an HTTP connector must be created. The following samples illustrate in general terms how an implementor may go about creating a connector, and although the specifics will vary extremely widely depending upon the platform some general principals should be obeyed.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_connector_basics"/>5.3.1. Connector basics</h3></div></div></div><p>Inside of your <code class="literal">IConnectorFactory</code> implementation you must return an <code class="literal">IServiceConnector</code> corresponding to the type of request and service being interacted with:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ConnectorFactory</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IConnectorFactory</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnector</span><span class="java_plain">&nbsp;createConnector</span><span class="java_separator">(</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnector</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Inspecting the <code class="literal">IServiceConnector</code> more closely, we can see the key interface of a connector:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IServiceConnection</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;resultHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The <code class="literal">IServiceConnection</code> you must return is used by apiman to write request chunks; hence, it will be <span class="strong"><strong>read</strong></span> by your connector. Conversely, the <code class="literal">IServiceConnectionResponse</code> handler must be called in order to send the <code class="literal">ServiceResponse</code> and its associated data chunks back to apiman once a response has returned from the service; hence, you will <span class="strong"><strong>write</strong></span> data to it.</p><p>The <code class="literal">IAsyncResultHandler</code> is also used to indicate whether an exception has occurred during the conversation with the backend.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_the_iserviceconnection"/>5.3.2. Creating the IServiceConnection</h3></div></div></div><p>Generally, an implementor must attempt to return their <code class="literal">IServiceConnection</code> as soon as it is valid for apiman to write data to the backend. Until you respond, apiman will not fire <code class="literal">IServiceRequestExecutor.streamHandler</code>, and hence no data will arrive prematurely to your connector. Following this guideline should help to minimise or eliminate any buffering requirements in your connectors.</p><p>Looking at an example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Native</span><!-- <br/> --><span class="java_plain">&nbsp;platform's&nbsp;connector&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">e</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">g</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">&nbsp;HTTP</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">ImaginaryBackendConnector</span><span class="java_plain">&nbsp;imaginaryConnector&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Connection</span><span class="java_plain">&nbsp;c&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">establishConnection</span><span class="java_separator">(</span><span class="java_plain">service</span><span class="java_separator">.</span><span class="java_plain">getEndpoint</span><span class="java_separator">(),</span><span class="java_plain">&nbsp;</span><span class="java_separator">...);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Prepare</span><span class="java_plain">&nbsp;in&nbsp;advance&nbsp;to&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;something&nbsp;sensible&nbsp;with&nbsp;the&nbsp;response</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">See</span><span class="java_plain">&nbsp;next&nbsp;section&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;more&nbsp;detail</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">c</span><span class="java_separator">.</span><span class="java_plain">responseHandler</span><span class="java_separator">(</span><span class="java_operator">&lt;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;the&nbsp;response</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;an&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">From</span><span class="java_plain">&nbsp;our&nbsp;perspective&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;is</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">inbound&nbsp;data</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">i</span><span class="java_separator">.</span><span class="java_plain">e</span><span class="java_separator">.</span><span class="java_plain">&nbsp;the&nbsp;user&nbsp;writes&nbsp;to&nbsp;us</span><span class="java_separator">).</span>
<!--  --><br/><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;write</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;arriving&nbsp;data&nbsp;chunk</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;end</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;the&nbsp;signal&nbsp;to&nbsp;indicate&nbsp;stream&nbsp;has&nbsp;completed</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">finish_connection</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;abort</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;immediate&nbsp;abort</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;instance&nbsp;by&nbsp;closing&nbsp;your&nbsp;connection</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">abort</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isFinished</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;finished</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">};</span></pre><p><code class="literal">imaginaryConnector</code> represents your platform’s backend connector. After establishing a connection that can accept data, you should return an <code class="literal">IServiceConnection</code>, allowing data to be written to your connector. You can extract your native buffer format using <code class="literal">getNativeBuffer</code> plus a cast. Although we haven’t yet explored how to handle a response, we can imagine that the platform’s <code class="literal">ImaginaryBackendConnector</code> would allows us to set a <code class="literal">responseHandler</code>, which will be fired when a response has arrived; this is point at which we can build an <code class="literal">IServiceConnectionResponse</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_the_iserviceconnectionresponse"/>5.3.3. Creating the IServiceConnectionResponse</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_handling_a_successful_response"/>5.3.3.1. Handling a successful response</h4></div></div></div><p>Apiman’s <code class="literal">resultHandler</code> should be called with an  <code class="literal">IServiceConnectionResponse</code> when your connector has received a response from the service.</p><p>Let’s imagine that <code class="literal">responseHandler</code> is called when the platform’s response has arrived, and looks like this:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">c</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">responseHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Handler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ImaginaryResponse</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">ImaginaryResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">});</span></pre><p>This is where we must build our apiman response, using the data returned in the platform’s response, and attaching appropriate handlers to capture any data that arrives.</p><p>In the following example, we expand the response <code class="literal">handle</code> method to build an <code class="literal">IServiceConnectionResponse</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;handle</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ImaginaryResponse</span><!-- <br/> --><span class="java_plain">&nbsp;response</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_plain">&nbsp;readStream&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">YourResponseBuilder</span><span class="java_separator">.</span><span class="java_plain">build</span><span class="java_separator">(</span><span class="java_plain">response</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doConnection</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;doConnection</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">&nbsp;stop&nbsp;any&nbsp;data&nbsp;arriving</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">pause</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;will&nbsp;be&nbsp;called&nbsp;when&nbsp;we&nbsp;resume&nbsp;transmission</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">bodyHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Handler</span><span class="java_operator">&lt;</span><span class="java_type">NativeDataChunk</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">NativeDataChunk</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;apimanBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">YourApimanBufferImpl</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bodyHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">apimanBuffer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Transmission</span><span class="java_plain">&nbsp;has&nbsp;finished</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">endHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Handler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">Void</span><span class="java_plain">&nbsp;flag</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">((</span><span class="java_type">Void</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">You</span><span class="java_plain">&nbsp;may&nbsp;want&nbsp;to&nbsp;close&nbsp;your&nbsp;backend&nbsp;connection&nbsp;here</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">(</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">bodyHandler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">(</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">endHandler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;getHead</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;serviceResponse</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isFinished</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;finished</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;abort</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Abort</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">&nbsp;explicitly&nbsp;resume&nbsp;transmission</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;transmit</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">resume</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">};</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">'re&nbsp;ready&nbsp;to&nbsp;transmit&nbsp;the&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;let&nbsp;apiman&nbsp;know</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResult</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">AsyncResultImpl</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;create</span><span class="java_separator">(</span><span class="java_plain">readStream</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;resultHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">result</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We imagine that our <code class="literal">response</code> object contains what we need to build a <code class="literal">ServiceResponse</code>, and that handlers can be attached in order to retrieve body data and an end signal. It can be paused using <code class="literal">pause</code>, which prevents any data from arriving until <code class="literal">resume</code> is called.</p><p>Importantly, data transmission <span class="strong"><strong>must not</strong></span> begin until <code class="literal">transmit</code> has been called, otherwise the appropriate handlers may not yet have been set, and data will be liable to disappear. Hence, in this example, <code class="literal">resume</code> is called in <code class="literal">transmit</code> where we are certain that it’s safe to send data.</p><p>After <code class="literal">end</code> has been signalled, clean up on the native connection can be performed, such as closing it. In this example was assume the connection is closed for us.</p><p>Once we are sure our stream is ready, we pass it to apiman using <code class="literal">resultHandler.handle</code> wrapped inside of an IAsyncResult indicating we were successful. Some helpful <code class="literal">create</code> methods are available in <code class="literal">AsyncResultImpl</code>.</p><p>Whilst a given platform’s implementation may look very different, implementors must be careful to preserve the same external behaviour; some platforms may require buffering of data if pause-like functionality is not available. In many cases it may be possible to implement <code class="literal">IServiceConnectionResponse</code> and <code class="literal">IServiceConnection</code> in the same class.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not transmit any response data into apiman until <code class="literal">transmit</code> has been signalled.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_handling_an_error"/>5.3.3.2. Handling an error</h4></div></div></div><p>If an error occurs, you must return a failure <code class="literal">IAsyncResult</code>, which may be caused, for instance, by an endpoint being unresolvable. The simplest way to share this is by using <code class="literal">AsyncResultImpl</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">try</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_separator">(</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResult</span><span class="java_plain">&nbsp;errorResult&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AsyncResultImpl</span><span class="java_separator">.</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;create</span><span class="java_separator">(</span><span class="java_plain">e</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;resultHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">errorResult</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Remember to clean up any resources you may have left open.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_implementation_strategies"/>5.3.4. Implementation strategies</h3></div></div></div><p>Implementors may notice that the only overlap between the <code class="literal">IServiceConnection</code> and <code class="literal">IServiceConnectionResponse</code> interfaces is the <code class="literal">isFinished</code> method. Hence, it is often possible to implement both interfaces using the same class, which may be a cleaner way to orchestrate the process.</p><p>Implementation exemplars:</p><div class="itemizedlist"><ul><li>link:<code class="literal"><a class="ulink" href="https://github.com/apiman/apiman/blob/master/gateway/platforms/servlet/src/main/java/io/apiman/gateway/platforms/servlet/connectors/HttpServiceConnection.java">https://github.com/apiman/apiman/blob/master/gateway/platforms/servlet/src/main/java/io/apiman/gateway/platforms/servlet/connectors/HttpServiceConnection.java</a></code>[Servlet HTTP Connector] is a more traditional synchronous implementations.</li><li>link:<code class="literal"> <a class="ulink" href="https://github.com/apiman/apiman/blob/master/gateway/platforms/vertx/src/main/java/io/apiman/gateway/vertx/connector/HttpConnector.java">https://github.com/apiman/apiman/blob/master/gateway/platforms/vertx/src/main/java/io/apiman/gateway/vertx/connector/HttpConnector.java</a></code>[Vert.x HTTP Connector] is an asynchronous HTTP implementation.</li></ul></div></div></div></div></div></body></html>