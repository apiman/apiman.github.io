<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="msvalidate.01" content="C3BF2C67B92C75F2DEAA096973652038" />
  <link rel="shortcut icon" href="http://www.apiman.io/latest/resources/images/favicon.ico">
  <title>Keycloak and dagger: Securing your APIs with OAuth2 | apiman Open Source API Management</title>
  <meta name="description" content="One great advantage of API Management is centralising auth concerns, thereby avoiding burdensome reimplementation issues and streamlining your security proce...">

  <!-- CSS -->
  <link href="http://www.apiman.io/latest/resources/bootstrap-3.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/patternfly-1.0.5/css/patternfly.min.css" rel="stylesheet">
  <link href="http://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/css/apiman-web.css?v=1.2.7.Final" rel="stylesheet">
  <link href="http://www.apiman.io/latest/resources/css/apiman-web.responsive.css?v=1.2.7.Final" rel="stylesheet">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="/blog/css/highlight.css" rel="stylesheet">
  <link href="/blog/css/main.css" rel="stylesheet">
  <link href="/blog/css/coderay-asciidoctor.css" rel="stylesheet">


  <!-- Scripts -->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  
  <script src="http://www.apiman.io/latest/resources/jquery-1.11.1/js/jquery.min.js"></script>
  <script src="http://www.apiman.io/latest/resources/bootstrap-3.3.0/js/bootstrap.min.js"></script>
  <script id="dsq-count-scr" src="//apiman.disqus.com/count.js" async></script>

  <!-- Canonical URL --><link rel="canonical" href="http://apiman.io/blog/gateway/security/oauth2/keycloak/authentication/authorization/1.2.x/2016/01/22/keycloak-oauth2-redux.html"><link rel="alternate" type="application/rss+xml" title="Apiman Blog | Open Source API Management" href="http://apiman.io/blog/feed.xml" />


  <!-- Google Analytics -->
  <script>
    $(document).ready(function() {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-56678850-1', 'auto');
      ga('send', 'pageview');
    });
  </script>
</head>
<body class="blog">
    <div id="rhbar">
      <a class="jbdevlogo" href="http://www.jboss.org/projects/about" rel="nofollow" target="_blank"></a>
      <a class="rhlogo" href="http://www.redhat.com/" rel="nofollow" target="_blank"></a>
    </div><nav id="top-nav" class="navbar navbar-inverse" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.apiman.io/latest/index.html">apiman</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/index.html">Overview</a></li>
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/download.html">Download</a></li>
        <li class="top-menu-item menu-item"><a href="http://www.apiman.io/latest/roadmap.html">Roadmap</a></li>
        <li class="top-menu-item menu-item active"><a href="http://www.apiman.io/blog/">Blog</a></li>
        <li class="top-menu-item menu-item dropdown">
            <a href="" class="dropdown-toggle" data-toggle="dropdown">Get Involved<b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li class="menu-item">
                    <a href="https://issues.jboss.org/browse/APIMAN">Report a Bug</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/chat.html">Chat on IRC</a>
                </li>
                <li class="menu-item">
                    <a href="https://twitter.com/apiman_io" rel="nofollow" target="_blank">Twitter Feed</a>
                </li>
                <li class="menu-item">
                    <a href="https://lists.jboss.org/mailman/listinfo/apiman-user" rel="nofollow" target="_blank">Mailing List</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/contributors.html">Contributors List</a>
                </li>
            </ul>
        </li>
        <li class="top-menu-item menu-item dropdown">
            <a href="" class="dropdown-toggle" data-toggle="dropdown">Learn More<b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/tutorials.html">Tutorials &amp; Walkthroughs</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/crash-course.html">Crash Course!</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/installation-guide.html">Installation Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/user-guide.html">User Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/developer-guide.html">Developer Guide</a>
                </li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/production-guide.html">Production Guide</a>
                </li>
                <li class="divider"></li>
                <li class="menu-item">
                    <a href="http://www.apiman.io/latest/api-manager-restdocs.html">API Manager REST Endpoints</a>
                </li>
            </ul>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>
<div class="container" id="blog">
      <div class="blog-content">
        <div class="post">
  <header class="post-header" style="margin-top: 25px">
    <h1 style="color: #666; font-weight: bold" class="post-title section-header">Keycloak and dagger: Securing your APIs with OAuth2</h1>
    <span style="color: #243446; font-size: 13px"><i class="fa fa-calendar"></i> Jan 22, 2016</span>
    <span style="color: #243446; margin-left: 15px; font-size: 13px"><i class="fa fa-user"></i> <a href="https://github.com/msavy">Marc Savy</a></span>
    <span style="color: #243446; margin-left: 15px; font-size: 13px"><i class="fa fa-tags"></i> gateway, security, oauth2, keycloak, authentication, authorization, and 1.2.x</span>
  </header><!-- New Post -->
    <p class="bg-warning"
       style="margin-top:15px; padding: 10px;">
        Note: This is a redux of our blogpost for <b>apiman 1.2.x</b>. If you're still using <b>apiman 1.1.x</b>, you can refer to the <a href="http://apiman.io/blog/gateway/security/oauth2/keycloak/authentication/authorization/2015/06/09/keycloak-oauth2.html">older revision</a>.
    </p><article class="post-content"
           style="margin-top: 20px; font-size: 14px; line-height: 20px">
    <div class="paragraph">
<p>One great advantage of API Management is centralising auth concerns, thereby avoiding burdensome reimplementation issues and streamlining your security processes. The good news is that you can easily configure apiman to handle many common auth use-cases, such as OAuth2 with our popular Keycloak OAuth2 policy which I’ll outline in this blogpost.</p>
</div>
<div class="sect1">
<h2 id="preparation">Preparation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this example, let’s assume we’re using apiman’s <a href="http://www.apiman.io/latest/download.html">quickstart</a> setup and have it running. I suggest using the <em>'Or simply try this…​'</em> box.</p>
</div>
<div class="paragraph">
<p>After you have your apiman quickstart running (replace <strong>apiman-1.2.0.Final</strong> in the path below with whatever version you downloaded), we can live deploy a handy <strong>echo service</strong> into our environment so we have an API to test against:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ShellSession">cd /tmp
git clone https://github.com/apiman/apiman-quickstarts.git
cd apiman-quickstarts/echo-service
git checkout 1.2.0.Final
mvn clean install
mvn wildfly:deploy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-plugin">Installing the Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Those amongst you with some experience of apiman may have noticed that the OAuth2 policy doesn’t appear in the standard list of policies in the manager UI; that’s because the OAuth2 policy is an example of an <strong>apiman plugin</strong>, all of which are shipped separately from apiman, but are trivially easy to install.</p>
</div>
<div class="paragraph">
<p>When logged into <a href="http://localhost:8080/apimanui/">the apiman manager UI</a> as an administrator (for the quickstart that’s u:`admin`, p:`admin123!`), navigate to the <strong>manage plugins</strong> page:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="http://www.apiman.io/latest/user-guide.html#_plugins"><img src="/blog/images/2016-01-08/sysadmin-manage-plugins.png" alt="System Administration" /></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/images/2016-01-08/available-plugins.png" alt="Select Keycloak OAuth Policy Plugin from the available plugins list" />
</div>
</div>
<div class="paragraph">
<p>Tab to <strong>Available Plugins</strong>, select <strong>Install</strong> for <em>Keycloak OAuth Policy Plugin</em>, confirm the plugin coordinates, and click <strong>Add Plugin</strong>. That’s it!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up">Setting Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two essential components to our system. First, is the <a href="http://keycloak.jboss.org" target="_blank" rel="nofollow">Keycloak server</a>, an all-in-one <a href="https://en.wikipedia.org/wiki/Single_sign-on" target="_blank" rel="nofollow">SSO</a> and <a href="https://en.wikipedia.org/wiki/Identity_management" target="_blank" rel="nofollow">IdM</a> platform; we’ll configure it to be our identity source and handle the issuance of OAuth2 bearer tokens. Second, is the apiman OAuth2 policy; we’ll set it up to validate the tokens precisely to our requirements.</p>
</div>
<div class="paragraph">
<p>Let’s assume we’re going to protect a very simple <strong>echo service</strong>, which echoes back to the requestor the details of any request made to it. It is located at <code><a href="http://localhost:8080/apiman-echo" class="bare">http://localhost:8080/apiman-echo</a></code>.</p>
</div>
<div class="sect2">
<h3 id="keycloak-server">Keycloak Server</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
There are a huge number of configuration permutations with Keycloak, and the most suitable approach will vary according to your requirements. It is highly recommended to consult the <a href="http://keycloak.jboss.org/docs.html" target="_blank" rel="nofollow">Keycloak guides</a> to determine your optimal setup, as for the sake of brevity we’re only going to cover a couple of trivial preconfigured scenarios.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, log into the <a href="http://localhost:8080/auth/admin">Keycloak server</a>. If you’re following our walkthrough, the log-in details are identical to those mentioned earlier (<code>admin</code>, <code>admin123!</code>). You can see that there is already an <strong>apiman</strong> realm defined, but we’re going to create a new one, so navigate to <strong>Add Realm</strong> (top right), and import and upload <a href="/blog/resources/2015-06-04/stottie.json">this demonstration realm definition</a>; it provides an extremely simple setup where we have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A realm: <code>stottie</code></p>
</li>
<li>
<p>A single user: <code>rincewind</code>, with password: <code>apiman</code> and a realm role: <code>echomeister</code></p>
</li>
<li>
<p>And, a client: <code>apiman</code>, which is allowed direct grants via Keycloak’s <a href="https://keycloak.github.io/docs/userguide/keycloak-server/html/direct-access-grants.html" target="_blank" rel="nofollow">RESTful Direct Access Grants API</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let’s quickly test requesting ourselves an OpenID Connect OAuth2 token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ShellSession">curl -X POST http://127.0.0.1:8080/auth/realms/stottie/protocol/openid-connect/token  -H "Content-Type: application/x-www-form-urlencoded" -d "username=rincewind" -d 'password=apiman' -d 'grant_type=password' -d 'client_id=apiman'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should return some JSON similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">"</span><span class="content">access_token</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">eyJhbGciOiJSUzI1NiJ9...&lt;SNIP&gt;</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">expires_in</span><span class="delimiter">"</span></span>: <span class="integer">300</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">refresh_expires_in</span><span class="delimiter">"</span></span>: <span class="integer">1800</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">refresh_token</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">eyJhbGcg...&lt;SNIP&gt;</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">not-before-policy</span><span class="delimiter">"</span></span>: <span class="integer">0</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">session-state</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">69974623-be8b-49d7-840a-0330c6bdde21</span><span class="delimiter">"</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the OAuth2 token we’re interested in is contained within the <code>access_token</code> field, with useful ancillary information about token validity and refreshing.</p>
</div>
<div class="paragraph">
<p>In this instance, the access token is a signed OpenID Connect JSON Web Token (JWT). Using the handy decoder available at <a href="https://jwt.io" target="_blank" rel="nofollow">jwt.io</a>, we can see a lot interesting information, including the <code>echomiester</code> realm role defined on <code>rincewind</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">"</span><span class="content">jti</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">c89b8cf7-84ef-4f02-9954-f8d3d4321473</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">exp</span><span class="delimiter">"</span></span>: <span class="integer">1433414538</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">nbf</span><span class="delimiter">"</span></span>: <span class="integer">0</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">iat</span><span class="delimiter">"</span></span>: <span class="integer">1433414238</span>,
    <span class="key"><span class="delimiter">"</span><span class="content">iss</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">http://127.0.0.1:8080/auth/realms/stottie</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">aud</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">apiman</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">sub</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">de4af322-85b2-4dbe-8d53-6a2ee29e4080</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">azp</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">apiman</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">session_state</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">69974623-be8b-49d7-840a-0330c6bdde21</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">client_session</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">b5bd36a0-d576-4593-be7b-4648612c25b8</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">allowed-origins</span><span class="delimiter">"</span></span>: [],
    <span class="key"><span class="delimiter">"</span><span class="content">realm_access</span><span class="delimiter">"</span></span>: {
        <span class="key"><span class="delimiter">"</span><span class="content">roles</span><span class="delimiter">"</span></span>: [
            <span class="string"><span class="delimiter">"</span><span class="content">echomeister</span><span class="delimiter">"</span></span>
        ]
    },
    <span class="key"><span class="delimiter">"</span><span class="content">resource_access</span><span class="delimiter">"</span></span>: {
        <span class="key"><span class="delimiter">"</span><span class="content">account</span><span class="delimiter">"</span></span>: {
            <span class="key"><span class="delimiter">"</span><span class="content">roles</span><span class="delimiter">"</span></span>: [
                <span class="string"><span class="delimiter">"</span><span class="content">view-profile</span><span class="delimiter">"</span></span>,
                <span class="string"><span class="delimiter">"</span><span class="content">manage-account</span><span class="delimiter">"</span></span>
            ]
        }
    },
    <span class="key"><span class="delimiter">"</span><span class="content">name</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="delimiter">"</span></span>,
    <span class="key"><span class="delimiter">"</span><span class="content">preferred_username</span><span class="delimiter">"</span></span>: <span class="string"><span class="delimiter">"</span><span class="content">rincewind</span><span class="delimiter">"</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This demonstrates one OpenID Connect’s most useful attributes: all the information required to validate a request is contained within the token itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="apiman-oauth2-policy">Apiman OAuth2 Policy</h3>
<div class="paragraph">
<p>First, log into apiman, and <strong>Create a New Organization</strong>; let’s call it <strong><em>Newcastle</em></strong>. Select the <strong>APIs</strong> tab, and add a <strong>New API</strong>; we’ll name this one <strong><em>EchoAPI</em></strong> and then <strong>Create API</strong>.</p>
</div>
<div class="paragraph">
<p>Select the <strong>Implementation</strong> tab, and set the endpoint to our echo service, <code><a href="http://localhost:8080/apiman-echo" class="bare">http://localhost:8080/apiman-echo</a></code>. Save and move onto the <strong>Plans</strong> tab, where you should opt to <strong>Make this API public</strong>. After saving, we can move onto the <strong>Policies</strong> tab, where the interesting stuff starts.</p>
</div>
<div class="paragraph">
<p>Navigate to <strong>Add Policy</strong>, and select <strong>Keycloak OAuth Policy</strong> from the drop-down list. A substantial set of options are available for your perusal, but for the purposes of this blog demo we’ll set the following:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://127.0.0.1:8080/auth/realms/stottie" class="bare" target="_blank" rel="nofollow">http://127.0.0.1:8080/auth/realms/stottie</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to our realm <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. Note that in older versions of Keycloak (pre <code>1.2.0</code>), the realm will just be the <strong>stottie</strong> (no path).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak Realm Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base64 encoded cert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paste your <a href="http://localhost:8080/auth/admin/master/console/#/realms/stottie/keys-settings">Keycloak realm certificate</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forward Authorization Roles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forward Realm Roles, and set <em>Forward Realm Roles?</em> to <strong>true</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If we decide to use the authorization policy later, we’ll forward the realm roles contained within the token (i.e. <code>echomeister</code>). If we don’t need the granularity of roles, you can still just validate the token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forward Keycloak Token Information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header: <code>X-AZP</code> ⇒ Field: <code>azp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set header <code>X-AZP</code> to be value of token’s <code>azp</code> field. We would expect this to be <code>apiman</code> for this case,  but you can set any field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Select <strong>Add Policy</strong>, and then <strong>Publish</strong> the API. You can see its endpoint information in the <strong>Endpoint</strong> tab, it should be similar to:</p>
</div>
<div class="paragraph">
<p><a href="https://localhost:8443/apiman-gateway/Newcastle/EchoAPI/1.0" class="bare">https://localhost:8443/apiman-gateway/Newcastle/EchoAPI/1.0</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-authentication">Testing Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s test our setup with cURL to see whether our request is <em>denied</em> if we don’t use a token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ShellSession">[msavy@mmbp tmp]$ curl -k  https://127.0.0.1:8443/apiman-gateway/Newcastle/EchoAPI/1.0
{
    "type": "Authentication",
    "failureCode": 11005,
    "responseCode": 401,
    "message": "OAuth2 'Authorization' header or 'access_token' query parameter must be provided.",
    "headers": {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Excellent, it all seems to be working! Notice that we’re using self-signed certificates for this demo, so the <code>-k</code> flag will skip certificate validation.</p>
</div>
<div class="paragraph">
<p>Next, let’s do a request with a token. There are two ways to attach your bearer token to a request. Either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Authorization</code> header, as <code>Authorization: Bearer &lt;token&gt;</code></p>
</li>
<li>
<p><code>access_token</code> query parameter, as <code><a href="http://example.org/the/path/?access_token=" target="_blank" rel="nofollow">token</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, let’s retrieve a fresh token from Keycloak, and extract the <code>access_token</code> field from the json using <code>jq</code> <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>curl -X POST http://127.0.0.1:8080/auth/realms/stottie/protocol/openid-connect/token  -H "Content-Type: application/x-www-form-urlencoded" -d 'username=rincewind' -d 'password=apiman' -d 'grant_type=password' -d 'client_id=apiman' | jq -r '.access_token'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, we’ll take the token and attach it to our request to the API</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[msavy@mmbp tmp]$ curl -k -H "Authorization: Bearer eyJhbGciOiJSUzI1NiJ9.eyJqdGkiOiJiNDY1YW..." https://127.0.0.1:8443/apiman-gateway/Newcastle/EchoAPI/1.0
{
  "method" : "GET",
  "resource" : "/apiman-echo",
  "uri" : "/apiman-echo",
  "headers" : {
    "Authorization" : "Bearer eyJhbGciOiJSUzI1NiJ9.eyJqdGkiOiJiNDY1YWMzNi1hMTczLTRjOWMtYWJjZS00MzE2MJ...",
    "Host" : "127.0.0.1:8080",
    "User-Agent" : "curl/7.37.1",
    "Accept" : "*/*",
    "Connection" : "keep-alive",
    "Cache-Control" : "no-cache",
    "Pragma" : "no-cache",
    "X-AZP": "apiman"
  },
  "bodyLength" : null,
  "bodySha1" : null,
  "counter" : 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great, it worked! We can see EchoAPI has now been reached, meaning our OAuth2 token was validated successfully, and it sent us back a response which includes the bearer token we used (you can strip this out in the options).</p>
</div>
<div class="paragraph">
<p>Furthermore, you can see our <code>X-AZP</code> header has been set to the expected value of <code>apiman</code>, which was pulled from the token.</p>
</div>
<div class="paragraph">
<p>If you’re feeling lazy, here’s <a href="https://gist.github.com/msavy/eaa1841e0c7a50e6ea8c" target="_blank" rel="nofollow">an all-in-one script</a> to do it for you.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-authorization">Adding Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We’re going to develop our example a little bit further. At present, we simply have a binary approach where we either allow or disallow based upon which realm the token was issued from. If we want a more granular approach where we can discriminate upon roles, then we need to add another element: <strong>Authorization</strong>.</p>
</div>
<div class="paragraph">
<p>The more observant readers will note that we have already added two of the required elements when we imported the realm into Keycloak; namely, a user <code>rincewind</code> and a realm role <code>echomeister</code>.</p>
</div>
<div class="paragraph">
<p>If we navigate back to the <strong>EchoAPI</strong> API in the apiman UI, we can create a <strong>New Version</strong>. We’ll call it <strong><em>2.0</em></strong> and clone the previous configuration. Moving over to the <strong>Policies</strong> tab again, we <strong>Add Policy</strong> and select <strong>Authorization Policy</strong> from the drop-down.</p>
</div>
<div class="paragraph">
<p>We’re going to add two rules:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;" />
<col style="width: 33.3333%;" />
<col style="width: 33.3334%;" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">To access resource</th>
<th class="tableblock halign-left valign-top">using verb/action</th>
<th class="tableblock halign-left valign-top">the user must have role</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>/rincewind/.*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>echomeister</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>/secret/.*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>overlord</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Our example user has the first role, but not the second. <strong>Add</strong> the policy and <strong>Publish</strong> the API again. Our endpoint will now reflect the changed version.</p>
</div>
<div class="paragraph">
<p>You will probably need to issue a new bearer token, which you can achieve by repeating the previous shell command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ShellSession">[msavy@mmbp tmp]$ curl -k -H "Authorization: Bearer eyJhbGciOiJSUzI1NiJ9.eyJqdGkiOiJmODAyZjFmMy1kN2JmLTQ0YjQtODA2N..." \
 https://127.0.0.1:8443/apiman-gateway/Newcastle/EchoAPI/2.0/rincewind/wizard
{
  "method" : "GET",
  "resource" : "/apiman-echo/rincewind/wizard",
  "uri" : "/apiman-echo/rincewind/wizard",
  "headers" : {
    "Authorization" : "Bearer eyJhbGciOiJSUzI1NiJ9.eyJqdGkiOiJmODAyZjFmMy1kN2JmLTQ0YjQtODA2N...",
    "Host" : "127.0.0.1:8080",
    "User-Agent" : "curl/7.37.1",
    "Accept" : "*/*",
    "Connection" : "keep-alive",
    "Cache-Control" : "no-cache",
    "Pragma" : "no-cache",
    "X-AZP": "apiman"
  },
  "bodyLength" : null,
  "bodySha1" : null,
  "counter" : 19
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As our user <code>rincewind</code> has the role <code>echomeister</code>, his request went through successfully.</p>
</div>
<div class="paragraph">
<p>However, if we try to access a resource for which he doesn’t hold the appropriate role, we see an error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ShellSession">[msavy@mmbp tmp]$ curl -k -H "Authorization: Bearer eyJhbGciOiJSUzI1NiJ9.eyJqdGkiOiJmODAyZjFmMy1kN2JmLTQ0YjQtODA2N..." \
 https://127.0.0.1:8443/apiman-gateway/Newcastle/EchoAPI/2.0/secret/not/allowed

{
    "type": "Authorization",
    "failureCode": 10009,
    "responseCode": 0,
    "message": "The user is not authorized to make this request (a required role is missing).",
    "headers": {}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="in-conclusion">In Conclusion…​</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We protected an API with apiman using OAuth2; with examples of both simple authentication and role-based authorization. It should be easy to design your own role-based auth setups in combination with Keycloak.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr />
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Ensure you use whatever the valid ISS value is for your Keycloak realm. One quick way to find this is by decoding an access_token looking at what Keycloak has set for the <code>iss</code> field
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. We’re going to use <code>jq</code> to select the <code>access_token</code> field in our JSON, so if you don’t have <code>jq</code> installed you can use your package manager to get it: OS X Brew <code>brew install jq</code>; On Fedora <code>sudo yum install jq</code>; On Debian <code>sudo apt-get install jq</code>
</div>
</div>
  </article><div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = '';
        this.page.identifier = '/gateway/security/oauth2/keycloak/authentication/authorization/1.2.x/2016/01/22/keycloak-oauth2-redux';
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//apiman.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>

      </div>
      <div class="blog-footer"><footer role="contentinfo">
    <div id="inner-footer" class="clearfix row">
        <div id="widget-footer" class="clearfix">
            <hr>
            <div class="widget col-sm-6 col-md-6 widget_text">
                <div class="textwidget">
                    <p>
                        Copyright &copy; 2017 Red Hat, Inc. All rights reserved.<br>
                        apiman code is open source and released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html" rel="nofollow" target="_blank">Apache License, v2.0</a>.<br>
                        <a href="/latest/disclosure.html">Open Source Disclosure</a>
                    </p>
                </div>
            </div>
            <div class="widget col-sm-6 col-md-6 widget_text" style="text-align: right">
                <a href="http://www.redhat.com" rel="nofollow" target="_blank"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png" alt="Red Hat"></a>
            </div>
        </div>
        <nav class="clearfix"></nav>
    </div>

    <!-- Adobe Analytics -->
    <script src="//www.redhat.com/j/s_code.js" />
    <script>
        /**
         * Adobe Analytics
         *
         * Variables reported to Adobe Analytics:
         *  -pageName
         *  -server
         *  -channel
         *  -first minor section
         *  -second minor section (if available)
         *  -third minor section (if available)
         *  -full URL (domain + path + query string)
         *  -base URL (domain + path)
         *  -language
         *  -country
         *
         */

        /**
         * Additional JS files to be loaded BEFORE adobe-analytics.js:
         *
         * - http://www.redhat.com/j/s_code.js
         *
         * Additional JS files to be loaded AFTER adobe-analytics.js
         *
         * - http://www.redhat.com/j/rh_omni_footer.js
         */


        (function() {

            // Load the path name, without its initial /
            var arr = location.pathname.substr(1, location.pathname.length).toLowerCase().split('/');
            // If the path ends in index.html or whitespace, trim the array
            if (arr[arr.length - 1] == "index.html" || arr[arr.length - 1] == "" ) {
                arr.pop();
            }

            /*
             * Assign values to Adobe Analytics properties
             */

            s.channel = "apiman | "; // The channel is our top level classification
            s.server = "apiman"; // The server is ???
            s.pageName = "apiman |  | " + (arr[arr.length -1] || "homepage"); // pageName is apiman | <Channel> | {page_name}. {page_name} has index.html removed
            s.prop2 = s.eVar22 = "en"; // prop2/eVar22 is the ISO 639-1 language code
            s.prop4 = s.eVar23 = encodeURI(location.search); //prop4/eVar23 is the query string of the page

            // Pad the array as needed, so we can shift away later
            for (var i = arr.length; i < 3; i++) {
                arr[i] = "";
            }

            s.prop14 = s.eVar27 = arr.shift(); // prop14/eVar27 is the first minor section (normally /{minor_section_1})
            s.prop15 = s.eVar28 = arr.shift(); // prop15/eVar28 is the second minor section (normally /a/{minor_section_2})
            s.prop16 = s.eVar29 = arr.shift(); // prop16/eVar29 is the third minor section (normally /a/b/{minor_section_3})
            s.prop21 = s.eVar18 = encodeURI(location.hostname+location.pathname).toLowerCase(); // prop21/eVar18 is the URL, less any query strings or fragments
        })();
    </script>
    <script src="//www.redhat.com/assets/js/tracking/rh_omni_footer.js"/>
</footer>
</div>
    </div>
  </body>
</html>
