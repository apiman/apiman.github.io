<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">apiman - Installation Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e3"/>apiman - Installation Guide</h1></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#_installation">1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#_installing_in_wildfly_9">1.1. Installing in WildFly 9</a></span></dt><dd><dl><dt><span class="section"><a href="#_download">1.1.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack">1.1.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_9">1.1.3. Run WildFly 9</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_in_wildfly_8">1.2. Installing in WildFly 8</a></span></dt><dd><dl><dt><span class="section"><a href="#_download_2">1.2.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack_2">1.2.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_8">1.2.3. Run WildFly 8</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_in_jboss_eap_6_4">1.3. Installing in JBoss EAP 6.4</a></span></dt><dd><dl><dt><span class="section"><a href="#_download_3">1.3.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack_3">1.3.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_eap_6_4">1.3.3. Run EAP 6.4</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_using_docker">1.4. Installing using Docker</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_logging_in">2. Logging In</a></span></dt><dt><span class="chapter"><a href="#_general_configuration">3. General Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuration_properties">3.1. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_api_manager_database">3.2. API Manager Database</a></span></dt><dt><span class="section"><a href="#_api_gateway_registry">3.3. API Gateway Registry</a></span></dt><dt><span class="section"><a href="#_api_gateway_rate_limiter">3.4. API Gateway Rate Limiter</a></span></dt><dt><span class="section"><a href="#_api_gateway_shared_state">3.5. API Gateway Shared State</a></span></dt><dt><span class="section"><a href="#_gateway_api_authentication">3.6. Gateway API Authentication</a></span></dt><dt><span class="section"><a href="#_data_export_import">3.7. Data Export/Import</a></span></dt><dd><dl><dt><span class="section"><a href="#_backing_up_your_data">3.7.1. Backing Up Your Data</a></span></dt><dt><span class="section"><a href="#_migrating_data_between_environments">3.7.2. Migrating Data Between Environments</a></span></dt><dt><span class="section"><a href="#_upgrading_to_a_new_apiman_version">3.7.3. Upgrading to a New Apiman Version</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_howtos">4. HowTos</a></span></dt><dd><dl><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager">4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview">4.1.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch">4.1.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties">4.1.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman">4.1.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_a_standalone_elasticsearch_instance_cluster_instead_of_the_quickstart_instance">4.2. How To:  Use a standalone Elasticsearch instance/cluster instead of the quickstart instance</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_2">4.2.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch_2">4.2.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_2">4.2.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_2">4.2.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_enable_mtls_mutual_ssl_support_for_endpoint_security">4.3. How To:  Enable MTLS (Mutual SSL) Support for Endpoint Security</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_3">4.3.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_create_trust_and_key_stores">4.3.2. Create Trust and Key Stores</a></span></dt><dt><span class="section"><a href="#_example_scenarios">4.3.3. Example Scenarios</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_3">4.3.4. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_3">4.3.5. (Re)start apiman</a></span></dt><dt><span class="section"><a href="#_configure_one_or_more_api_to_use_mtls">4.3.6. Configure one or more API to use MTLS</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_an_external_keycloak_authentication_server">4.4. How To:  Use an External Keycloak Authentication Server</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_4">4.4.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_create_the_apiman_realm_in_keycloak">4.4.2. Create the apiman Realm in Keycloak</a></span></dt><dt><span class="section"><a href="#_configure_the_api_manager_ui_client_in_keycloak">4.4.3. Configure the API Manager UI client in Keycloak</a></span></dt><dt><span class="section"><a href="#_point_apiman_at_the_remote_keycloak">4.4.4. Point apiman at the remote Keycloak</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_configure_a_custom_api_catalog">4.5. How To:  Configure a Custom API Catalog</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_5">4.5.1. High Level Overview</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_a_custom_plugin_registry">4.6. How To:  Use a Custom Plugin Registry</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_6">4.6.1. High Level Overview</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_property_replacement_in_policy_config">4.7. How To:  Use Property Replacement in Policy Config</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_7">4.7.1. High Level Overview</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installation"/>Chapter 1. Installation</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_installing_in_wildfly_9">1.1. Installing in WildFly 9</a></span></dt><dd><dl><dt><span class="section"><a href="#_download">1.1.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack">1.1.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_9">1.1.3. Run WildFly 9</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_in_wildfly_8">1.2. Installing in WildFly 8</a></span></dt><dd><dl><dt><span class="section"><a href="#_download_2">1.2.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack_2">1.2.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_8">1.2.3. Run WildFly 8</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_in_jboss_eap_6_4">1.3. Installing in JBoss EAP 6.4</a></span></dt><dd><dl><dt><span class="section"><a href="#_download_3">1.3.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack_3">1.3.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_eap_6_4">1.3.3. Run EAP 6.4</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_using_docker">1.4. Installing using Docker</a></span></dt></dl></div><p>This guide provides detailed information about how to install and configure apiman.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_in_wildfly_9"/>1.1. Installing in WildFly 9</h2></div></div></div><p>The apiman project primarily targets WildFly 9 as a runtime environment.  In order to install
apiman you will need to download both WildFly 9 and the apiman overlay distribution.  Once
both are downloaded, it’s a simple matter of unpacking both into the same location.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download"/>1.1.1. Download</h3></div></div></div><p>First you will need to download both WildFly 9 and apiman:</p><div class="itemizedlist"><ul><li><a class="link" href="http://download.jboss.org/wildfly/9.0.2.Final/wildfly-9.0.2.Final.zip" target="">Download WildFly 9</a></li><li><a class="link" href="http://downloads.jboss.org/apiman/1.2.5.Final/apiman-distro-wildfly9-1.2.5.Final-overlay.zip" target="">Download apiman 1.2.5.Final</a></li></ul></div><pre class="literallayout">curl http://download.jboss.org/wildfly/9.0.2.Final/wildfly-9.0.2.Final.zip -o wildfly-9.0.2.Final.zip
curl http://downloads.jboss.org/apiman/1.2.5.Final/apiman-distro-wildfly9-1.2.5.Final-overlay.zip -o apiman-distro-wildfly9-1.2.5.Final-overlay.zip</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_unpack"/>1.1.2. Unpack</h3></div></div></div><p>Once both files have been downloaded, simply unpack both in the same location.</p><pre class="literallayout">unzip wildfly-9.0.2.Final.zip
unzip -o apiman-distro-wildfly9-1.2.5.Final-overlay.zip -d wildfly-9.0.2.Final</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_run_wildfly_9"/>1.1.3. Run WildFly 9</h3></div></div></div><p>The apiman overlay contains everything needed to run apiman, including:</p><div class="itemizedlist"><ul><li>apiman binaries (several WAR files)</li><li>apiman-specific WildFly 9 configuration (<span class="strong"><strong>standalone-apiman.xml</strong></span>)</li><li>apiman rdbms datasource (h2)</li><li>pre-configured <span class="strong"><strong>admin</strong></span> user with password <span class="strong"><strong>admin123!</strong></span></li><li>pre-configured h2 database for the API Manager (populated with default values)</li><li>embedded Elasticsearch instance for metrics and gateway storage</li></ul></div><p>For this reason, there is no additional configuration required to run apiman.  Simply start up
WildFly using the apiman configuration file:</p><pre class="literallayout">cd wildfly-9.0.2.Final
./bin/standalone.sh -c standalone-apiman.xml</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_in_wildfly_8"/>1.2. Installing in WildFly 8</h2></div></div></div><p>The apiman project primarily targets WildFly 8 as a runtime environment.  In order to install
apiman you will need to download both WildFly 8 and the apiman overlay distribution.  Once
both are downloaded, it’s a simple matter of unpacking both into the same location.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_2"/>1.2.1. Download</h3></div></div></div><p>First you will need to download both WildFly 8 and apiman:</p><div class="itemizedlist"><ul><li><a class="link" href="http://download.jboss.org/wildfly/8.2.0.Final/wildfly-8.2.0.Final.zip" target="">Download WildFly 8</a></li><li><a class="link" href="http://downloads.jboss.org/apiman/1.2.5.Final/apiman-distro-wildfly8-1.2.5.Final-overlay.zip" target="">Download apiman 1.2.5.Final</a></li></ul></div><pre class="literallayout">curl http://download.jboss.org/wildfly/8.2.0.Final/wildfly-8.2.0.Final.zip -o wildfly-8.2.0.Final.zip
curl http://downloads.jboss.org/apiman/1.2.5.Final/apiman-distro-wildfly8-1.2.5.Final-overlay.zip -o apiman-distro-wildfly8-1.2.5.Final-overlay.zip</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_unpack_2"/>1.2.2. Unpack</h3></div></div></div><p>Once both files have been downloaded, simply unpack both in the same location.</p><pre class="literallayout">unzip wildfly-8.2.0.Final.zip
unzip -o apiman-distro-wildfly8-1.2.5.Final-overlay.zip -d wildfly-8.2.0.Final</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_run_wildfly_8"/>1.2.3. Run WildFly 8</h3></div></div></div><p>The apiman overlay contains everything needed to run apiman, including:</p><div class="itemizedlist"><ul><li>apiman binaries (several WAR files)</li><li>apiman-specific WildFly 8 configuration (<span class="strong"><strong>standalone-apiman.xml</strong></span>)</li><li>apiman rdbms datasource (h2)</li><li>pre-configured <span class="strong"><strong>admin</strong></span> user with password <span class="strong"><strong>admin123!</strong></span></li><li>pre-configured h2 database for the API Manager (populated with default values)</li><li>embedded Elasticsearch instance for metrics and gateway storage</li></ul></div><p>For this reason, there is no additional configuration required to run apiman.  Simply start up
WildFly using the apiman configuration file:</p><pre class="literallayout">cd wildfly-8.2.0.Final
./bin/standalone.sh -c standalone-apiman.xml</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_in_jboss_eap_6_4"/>1.3. Installing in JBoss EAP 6.4</h2></div></div></div><p>If you prefer to run apiman on a Red Hat supported application server, you can install it
into JBoss EAP 6.4.  In order to install apiman you will need to download both EAP and the apiman
overlay distribution.  Once both are downloaded, it’s a simple matter of unpacking both into the
same location.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_3"/>1.3.1. Download</h3></div></div></div><p>First you will need to download both EAP 6.4 and apiman:</p><div class="itemizedlist"><ul><li><a class="link" href="http://www.jboss.org/products/eap/download/" target="">Download EAP 6.4</a></li><li><a class="link" href="http://downloads.jboss.org/apiman/1.2.5.Final/apiman-distro-eap64-1.2.5.Final-overlay.zip" target="">Download apiman 1.2.5.Final</a></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_unpack_3"/>1.3.2. Unpack</h3></div></div></div><p>Once both files have been downloaded, simply unpack both in the same location (see the instructions
for Wildfly above).</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_run_eap_6_4"/>1.3.3. Run EAP 6.4</h3></div></div></div><p>The apiman overlay contains everything needed to run apiman, including:</p><div class="itemizedlist"><ul><li>apiman binaries (several WAR files)</li><li>apiman-specific EAP configuration (<span class="strong"><strong>standalone-apiman.xml</strong></span>)</li><li>apiman rdbms datasource (h2)</li><li>pre-configured <span class="strong"><strong>admin</strong></span> user with password <span class="strong"><strong>admin123!</strong></span></li><li>pre-configured h2 database for the API Manager (populated with default values)</li><li>embedded Elasticsearch instance for metrics and gateway storage</li></ul></div><p>For this reason, there is no additional configuration required to run apiman.  Simply start up
EAP using the apiman configuration file:</p><pre class="literallayout">cd jboss-eap*
./bin/standalone.sh -c standalone-apiman.xml</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_using_docker"/>1.4. Installing using Docker</h2></div></div></div><p>Another option when installing apiman is to use our docker image.  You’re probably pretty
familiar with docker if you’re going that route, but here is an example of how to start up
the apiman docker image:</p><pre class="literallayout">docker pull jboss/apiman-wildfly
docker run -it -p 8080:8080 -p 8443:8443 jboss/apiman-wildfly</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>You can find apiman on <a class="link" href="https://registry.hub.docker.com/repos/apiman/" target="">docker hub</a>.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_logging_in"/>Chapter 2. Logging In</h2></div></div></div><p>Once apiman is running, you should be able to log in to the API Manager by pointing your
browser at the following URL:</p><pre class="literallayout">http://localhost:8080/apimanui/</pre><p>You may log in with credentials <span class="strong"><strong>admin/admin123!</strong></span>.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>We strongly advise that you immediately change the Keycloak admin user password, as well
as the "admin" user found in the "apiman" realm!!  ( you can do that by navigating to
<a class="link" href="http://localhost:8080/auth/admin/" target="">http://localhost:8080/auth/admin/</a> )</p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_general_configuration"/>Chapter 3. General Configuration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_configuration_properties">3.1. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_api_manager_database">3.2. API Manager Database</a></span></dt><dt><span class="section"><a href="#_api_gateway_registry">3.3. API Gateway Registry</a></span></dt><dt><span class="section"><a href="#_api_gateway_rate_limiter">3.4. API Gateway Rate Limiter</a></span></dt><dt><span class="section"><a href="#_api_gateway_shared_state">3.5. API Gateway Shared State</a></span></dt><dt><span class="section"><a href="#_gateway_api_authentication">3.6. Gateway API Authentication</a></span></dt><dt><span class="section"><a href="#_data_export_import">3.7. Data Export/Import</a></span></dt><dd><dl><dt><span class="section"><a href="#_backing_up_your_data">3.7.1. Backing Up Your Data</a></span></dt><dt><span class="section"><a href="#_migrating_data_between_environments">3.7.2. Migrating Data Between Environments</a></span></dt><dt><span class="section"><a href="#_upgrading_to_a_new_apiman_version">3.7.3. Upgrading to a New Apiman Version</a></span></dt></dl></dd></dl></div><p>Of course apiman is made up of a number of different components, many of which can be configured
to use various implementations and/or providers.  When downloading and installing apiman, the
default distribution includes reasonable default values for all options.  This section details
these options and explains the default values.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_configuration_properties"/>3.1. Configuration Properties</h2></div></div></div><p>All of the apiman WARs share a common configuration file called <span class="strong"><strong>apiman.properties</strong></span>, which can
be found in <span class="strong"><strong>standalone/configuration</strong></span>.  This file therefore contains configuration settings
for all three applications (API Manager, API Manager UI, API Gateway).</p><p>Please refer to the apiman.properties file itself, as well as this document, for more information
on each property’s purpose and possible values.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_manager_database"/>3.2. API Manager Database</h2></div></div></div><p>The API Manager, by default, is a typical CDI application and uses JPA/Hibernate to persist its data.  The
JPA layer requires a data source to connect to a supported database.  When running in WildFly this
datasource is made available by deploying the following file:</p><pre class="literallayout">standalone/deployments/apiman-ds.xml</pre><p>Out of the box this data source is usually a simple H2 configuration, but you can (of course) change
it to support whatever database you desire.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">datasources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">datasource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">jndi-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jdbc/ApiManDT&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">pool-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman-manager-api&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">enabled</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">use-java-context</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">connection-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">jdbc:h2:${jboss.server.data.dir}${/}h2${/}apiman-manager-api;MVCC=true</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">connection-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">driver</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">h2</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">driver</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">security</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">user-name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">sa</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">user-name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">security</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">datasource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">datasources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>The project comes with DDLs for MySQL and PostgreSQL, to hopefully make it easy to switch away from H2.  Note
that switching databases also requires a change to the apiman.properties file.  The following should be
changed to appropriate values for your database:</p><pre class="screen">apiman.hibernate.dialect=io.apiman.manager.api.jpa.ApimanMySQL5Dialect
apiman.hibernate.hbm2ddl.auto=validate</pre><p>Note that the following dialects are available:</p><div class="itemizedlist"><ul><li>io.apiman.manager.api.jpa.ApimanH2Dialect</li><li>io.apiman.manager.api.jpa.ApimanMySQL5Dialect</li><li>io.apiman.manager.api.jpa.ApimanOracle12Dialect</li><li>io.apiman.manager.api.jpa.ApimanPostgreSQLDialect</li></ul></div><p>You can, of course, set the hbm2ddl property to "update" so that hibernate automatically creates the
database structure when it starts up.  Additional DDLs for various databases can be found in
<span class="strong"><strong>apiman/ddls/</strong></span>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_registry"/>3.3. API Gateway Registry</h2></div></div></div><p>The API Gateway includes a registry that stores the published API and Client App information.
This registry is updated whenever a user publishes an API (or registers a Client App) from
within the API Manager UI.  The registry contains just the configuration information necessary for
the API Gateway to properly apply the appropriate policies to all inbound requests.</p><p>Out of the box, the API Gateway is configured to use Elasticsearch to store the
published/registered data.</p><p>The configuration of the Registry can be found in the <span class="strong"><strong>apiman.properties</strong></span> file.</p><p>See section 4.2 for more information on modifying Elasticsearch settings.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_rate_limiter"/>3.4. API Gateway Rate Limiter</h2></div></div></div><p>Part of the running apiman system is a "Rate Limiter" component.  This component is used by
apiman policies to enforce rate limits and uses Elasticsearch to store data.</p><p>The configuration of the Rate Limiter component can be found in the <span class="strong"><strong>apiman.properties</strong></span>
file.</p><p>See section 4.2 for more information on modifying Elasticsearch settings.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_shared_state"/>3.5. API Gateway Shared State</h2></div></div></div><p>Part of the running apiman system is a "Shared State" component.  This component is used by
apiman policies to share interesting state information across multiple requests.  The
shared state component uses Elasticsearch to store data.</p><p>The configuration of the Shared State component can be found in the <span class="strong"><strong>apiman.properties</strong></span>
file.</p><p>See section 4.2 for more information on modifying Elasticsearch settings.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_gateway_api_authentication"/>3.6. Gateway API Authentication</h2></div></div></div><p>The Gateway’s REST API is what the API Manager invokes when publishing APIs and Client Apps
to the Gateway.  This REST API should be protected, often using BASIC authentication.  By default,
the Gateway REST API requires BASIC authentication credentials, as well as a role of <span class="strong"><strong>apipublisher</strong></span>.
In other words, the Gateway REST API can only be invoked by a valid user, and that user must have
the <span class="strong"><strong>apipublisher</strong></span> role.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_data_export_import"/>3.7. Data Export/Import</h2></div></div></div><p>Apiman has a feature that allows admin users to export all of the configuration data from
the Manager into a single export file (JSON formatted).  This exported file can then be
edited (if necessary) and then imported into another instance of apiman.  This feature
attempts to address the following use-cases:</p><div class="itemizedlist"><ul><li>Data backups</li><li>Migrating between environments</li><li>Upgrading apiman to a new version</li></ul></div><p>Using the feature is simple - you must log into the apiman UI as an admin user, then
navigate to the "Export/Import" UI page by clicking the "Export/Import Data" link on
the API Manager Dashboard.  From there you can export or import data.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_backing_up_your_data"/>3.7.1. Backing Up Your Data</h3></div></div></div><p>There are multiple strategies for backing up your apiman data, depending on the configuration
you have chosen (e.g. whether you are using a Database or elasticserach to store your data).
However, once approach to data backups that is consitent across all configurations is to
use the Data Export feature of apiman to create a JSON file containing all of the apiman
configuration data.</p><p>This can be done via the UI or via the following API Manager REST endpoint:</p><pre class="screen">https://HOST:PORT/apiman/system/export</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_migrating_data_between_environments"/>3.7.2. Migrating Data Between Environments</h3></div></div></div><p>Often times you may have a Test version of apiman deployed, as well as a Production
version.  Depending on your workflow, you may wish to configure your APIs in the Test
environment and then migrate that configuration into Production (rather than having to
re-create the same configuration in Production manually).  This can be accomplished
by Exporting data from Test and then importing it into Production.</p><p>When doing this, note that the Export feature will export the entire set of configuration
from apiman.  This may be precisely what you want, but many times only a subset of the
data is desired.  If this is the case, then you will need to edit the resulting JSON
file to only include the data you wish to migrate.  In the future, we hope to build
tools that will make this editing of the exported file easier.</p><p>Once you have edited the exported file, you can simply log into your production apiman
instance and use the Export/Import UI page to import the data.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_upgrading_to_a_new_apiman_version"/>3.7.3. Upgrading to a New Apiman Version</h3></div></div></div><p>Whenever you wish to upgrade from an old to a newer version of apiman, you will likely want
to preserve all of the Plan, API, and Client App configurations you have created.  To
do this, you can follow these steps:</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Export all data from OLD VERSION of apiman</li><li>Shut down OLD VERSION of apiman</li><li>Install NEW VERSION of apiman</li><li>Start up NEW VERSION of apiman</li><li>Import data into NEW VERSION of apiman (data exported in step #1)</li></ol></div><p>Once these steps are complete, you should have a new version of apiman running
with all of your existing data.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_howtos"/>Chapter 4. HowTos</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager">4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview">4.1.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch">4.1.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties">4.1.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman">4.1.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_a_standalone_elasticsearch_instance_cluster_instead_of_the_quickstart_instance">4.2. How To:  Use a standalone Elasticsearch instance/cluster instead of the quickstart instance</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_2">4.2.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch_2">4.2.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_2">4.2.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_2">4.2.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_enable_mtls_mutual_ssl_support_for_endpoint_security">4.3. How To:  Enable MTLS (Mutual SSL) Support for Endpoint Security</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_3">4.3.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_create_trust_and_key_stores">4.3.2. Create Trust and Key Stores</a></span></dt><dt><span class="section"><a href="#_example_scenarios">4.3.3. Example Scenarios</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_3">4.3.4. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_3">4.3.5. (Re)start apiman</a></span></dt><dt><span class="section"><a href="#_configure_one_or_more_api_to_use_mtls">4.3.6. Configure one or more API to use MTLS</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_an_external_keycloak_authentication_server">4.4. How To:  Use an External Keycloak Authentication Server</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_4">4.4.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_create_the_apiman_realm_in_keycloak">4.4.2. Create the apiman Realm in Keycloak</a></span></dt><dt><span class="section"><a href="#_configure_the_api_manager_ui_client_in_keycloak">4.4.3. Configure the API Manager UI client in Keycloak</a></span></dt><dt><span class="section"><a href="#_point_apiman_at_the_remote_keycloak">4.4.4. Point apiman at the remote Keycloak</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_configure_a_custom_api_catalog">4.5. How To:  Configure a Custom API Catalog</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_5">4.5.1. High Level Overview</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_a_custom_plugin_registry">4.6. How To:  Use a Custom Plugin Registry</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_6">4.6.1. High Level Overview</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_property_replacement_in_policy_config">4.7. How To:  Use Property Replacement in Policy Config</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_7">4.7.1. High Level Overview</a></span></dt></dl></dd></dl></div><p>This section contains specific instructions for how to configure apiman for specific scenarios.
For example, it is possible to use Elasticsearch instead of Infinispan for certain API Gateway
components.  This section details how to make these sorts of changes.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager"/>4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</h2></div></div></div><p>The API Manager is configured (by default) to use JPA as the persistence technology for
storing all of its data.  But this isn’t the only persistence technology supported.  Another
option is to use Elasticsearch.  This section details how to set up apiman to use Elasticsearch
instead of an RDBMS to store your API Manager data.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview"/>4.1.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and install <a class="link" href="https://www.elastic.co/downloads/elasticsearch" target="">Elasticsearch</a></li><li>Make changes to "apiman.properties" to switch from JPA to Elasticsearch</li><li>(Re)start apiman!</li><li>Perform standard admin configuration of apiman (the database will of course be empty!)</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_and_install_elasticsearch"/>4.1.2. Download and install Elasticsearch</h3></div></div></div><p>This part is pretty easy - download the Elasticsearch software and get it running.  A very good
resource for this can be found here:</p><p><a class="link" href="http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html" target="">http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html</a></p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>As of apiman 1.1.4.Final, an instance of Elasticsearch is included in the default
apiman distribution.  You may use it as your API Manager persistence store.  It is running
on port 19200.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_make_changes_to_apiman_properties"/>4.1.3. Make changes to "apiman.properties"</h3></div></div></div><p>Once Elasticsearch is running smoothly, you must make some changes to the <span class="strong"><strong>apiman.properties</strong></span>
file in order to tell apiman to use ES instead of a database.  You should modify the
apiman.properties file to have the following properties set:</p><pre class="screen">apiman.es.protocol=http
apiman.es.host=localhost
apiman.es.port=19200
apiman.es.username=
apiman.es.password=

apiman-manager.storage.type=es
apiman-manager.storage.es.protocol=${apiman.es.protocol}
apiman-manager.storage.es.host=${apiman.es.host}
apiman-manager.storage.es.port=${apiman.es.port}
apiman-manager.storage.es.username=${apiman.es.username}
apiman-manager.storage.es.password=${apiman.es.password}
apiman-manager.storage.es.initialize=true</pre><p>Make sure you enter appropriate values for the apiman.es.protocol, apiman.es.host, and apiman.es.port
properties.  These values should reflect the settings of your Elasticsearch instance.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>You can optionally also set the username and password - this is only useful if you are using
something like Elasticsearch Shield to enable basic authentiation.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="__re_start_apiman"/>4.1.4. (Re)start apiman</h3></div></div></div><p>If apiman was running, you should stop it now.  Once everything is shutdown, and the changes
to apiman.properties have been made, go ahead and start apiman up again.  It will pick up the
new settings in apiman.properties and attempt to use Elasticsearch instead of the database!</p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Perform standard admin configuration</h5><p class="formalpara">Note that the apiman quickstart overlay ZIP comes pre-configured with a number of settings, including:</p><div class="itemizedlist"><ul><li>Installed policy definitions</li><li>Default configured roles (Organization Owner, API Developer, Appliation Developer)</li><li>A default configured Gateway</li></ul></div><p>This built-in configuration will be lost when you switch from JPA to Elasticsearch.  You will
need to use the apiman admin UI to reconfigure these settings.  Refer to the "System Administration"
section of the User Guide for more information on this.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_a_standalone_elasticsearch_instance_cluster_instead_of_the_quickstart_instance"/>4.2. How To:  Use a standalone Elasticsearch instance/cluster instead of the quickstart instance</h2></div></div></div><p>The apiman quickstart overlay ZIP ships by default with an embedded instance of Elasticsearch.
This is suitable for getting up and running quickly, but is not a good long term solution.  Instead,
users are encouraged to install a standalone instance of Elasticsearch and point apiman to it.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_2"/>4.2.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and install <a class="link" href="https://www.elastic.co/downloads/elasticsearch" target="">Elasticsearch</a></li><li>Make changes to "apiman.properties" to point to your standalone Elasticsearch instance</li><li>(Re)start apiman!</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_and_install_elasticsearch_2"/>4.2.2. Download and install Elasticsearch</h3></div></div></div><p>This part is pretty easy - download the Elasticsearch software and get it running.  A very good
resource for this can be found here:</p><p><a class="link" href="http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html" target="">http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_make_changes_to_apiman_properties_2"/>4.2.3. Make changes to "apiman.properties"</h3></div></div></div><p>Once Elasticsearch is running smoothly, you must make some minor changes to the <span class="strong"><strong>apiman.properties</strong></span>
file in order to tell apiman where your Elasticsearch instance is located.</p><p>There are a set of global properties used for all apiman components that use Elasticsearch to
load data.  These properties are:</p><pre class="screen">apiman.es.protocol=http
apiman.es.host=localhost
apiman.es.port=19200
apiman.es.username=
apiman.es.password=</pre><p>Make sure you enter appropriate values for this properties - they should reflect the settings
of your Elasticsearch installation.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="__re_start_apiman_2"/>4.2.4. (Re)start apiman</h3></div></div></div><p>If apiman was running, you should stop it now.  Once everything is shutdown, and the changes
to apiman.properties have been made, go ahead and start apiman up again.  It will pick up the
new settings in apiman.properties and attempt to use Elasticsearch instead of Infinispan.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_enable_mtls_mutual_ssl_support_for_endpoint_security"/>4.3. How To:  Enable MTLS (Mutual SSL) Support for Endpoint Security</h2></div></div></div><p>If you wish to use mutual SSL to ensure endpoint security between the apiman API Gateway and
your back-end API(s), you must update some settings in the apiman.properties file.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_3"/>4.3.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Create Trust and Key Stores</li><li>Make changes to "apiman.properties" to switch from JPA to Elasticsearch</li><li>(Re)start apiman!</li><li>Configure one or more API to use MTLS</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_create_trust_and_key_stores"/>4.3.2. Create Trust and Key Stores</h3></div></div></div><p>Please refer to <a class="link" href="https://docs.oracle.com/javase/7/docs/technotes/tools/solaris/keytool.html" target="">official JDK documentation</a>
to learn how to create and managed your SSL Trust and Key stores. Minimally a Keystore
is required in order to successfully utilise MTLS, and in many cases also a Truststore.</p><p>A <span class="strong"><strong>keystore</strong></span> contains a given node’s private key material, and must be kept safe.
Each node should have a unique key entry. For instance, a gateway should have its
own keystore, and each API likewise. In a production system, these keys should
be issued by a trusted certificate authority.</p><p>A <span class="strong"><strong>truststore</strong></span> typically contains a set of certificate authorities which are trusted issuers.
Therefore, any certificate signed by the trusted CA would be trusted by the gateway. If
no truststore is explicitly provided to apiman the
<a class="link" href="https://docs.oracle.com/javase/7/docs/technotes/tools/solaris/keytool.html#cacerts" target="">default trusted certificates</a>
provided by the JVM will be used. A typical use-case would be that an organization’s
internal signing authority is marked as trusted within in the truststore,
and as the authority has been used to sign the certificate material in the keystores,
they will mutually trust each other by virtue of the issuer.</p><p>It is also possible to directly insert the <span class="strong"><strong>public/self-signed certificate</strong></span> corresponding
to a given private key pair into a truststore, which works well at small scales and for development, but will
quickly cause the accumulation of a huge number of certificates in larger systems as
it requires a 1:1 mapping of certificates and private keys (rather than 1:N by using a trusted authority).</p><p>Your back-end APIs must be SSL enabled and <span class="strong"><strong>require authenticated client SSL connections</strong></span>.
This means you must have server SSL certificates generated (and appropriate certificates and/or
CAs stored in your Trust Store).</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_example_scenarios"/>4.3.3. Example Scenarios</h3></div></div></div><p>There are many potential configuration permutations, but we’ll outline a few simple ones here to
get you started.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_development_setup"/>4.3.3.1. Development Setup</h4></div></div></div><p>In our hypothetical development setup, let’s imagine we have two APIs and a single gateway.</p><div class="table"><a id="d0e578"/><p class="title"><b>Table 4.1. Simple Development MTLS Setup</b></p><div class="table-contents"><table summary="Simple Development MTLS Setup" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="left" valign="top">Component</th><th align="left" valign="top">Key Alias</th><th align="left" valign="top">Truststore’s Trusted Certificates</th></tr></thead><tbody><tr><td align="left" valign="top"><p>Apiman Gateway</p></td><td align="left" valign="top"><p>gateway</p></td><td align="left" valign="top"><p>api_a.cer, api_b.cer</p></td></tr><tr><td align="left" valign="top"><p>API A</p></td><td align="left" valign="top"><p>api_a</p></td><td align="left" valign="top"><p>gateway.cer</p></td></tr><tr><td align="left" valign="top"><p>API B</p></td><td align="left" valign="top"><p>api_b</p></td><td align="left" valign="top"><p>gateway.cer</p></td></tr></tbody></table></div></div><br class="table-break"/><div class="itemizedlist"><p class="title"><b>Walkthrough</b></p><ul><li><p>Generate a keystore and export a certificate for each component:</p><div class="itemizedlist"><ul><li><p>Gateway:</p><pre class="literallayout">keytool -genkey -keyalg RSA -keystore gateway_ks.jks -alias gateway
keytool -export -alias gateway -file gateway.cer -keystore gateway_ks.jks</pre></li><li><p>API A:</p><pre class="literallayout">keytool -genkey -keyalg RSA -keystore api_a_ks.jks -alias api_a
keytool -export -alias api_a -file api_a.cer -keystore api_a_ks.jks</pre></li><li><p>API B:</p><pre class="literallayout">keytool -genkey -keyalg RSA -keystore api_b_ks.jks -alias api_b
keytool -export -alias api_b -file api_b.cer -keystore api_b_ks.jks</pre></li></ul></div></li><li><p>Import certificates into appropriate trust stores:</p><div class="itemizedlist"><ul><li><p>Gateway:</p><pre class="literallayout">keytool -import -file api_a.cer -alias api_a -keystore gateway_ts.jks
keytool -import -file api_b.cer -alias api_b -keystore gateway_ts.jks</pre></li><li><p>API A:</p><pre class="literallayout">keytool -import -file gateway.cer -alias gateway -keystore api_a_ts.jks</pre></li><li><p>API B:</p><pre class="literallayout">keytool -import -file gateway.cer -alias gateway -keystore api_b_ts.jks</pre></li></ul></div></li></ul></div><p>Now simply set the appropriate paths to the keystore and truststore in
<code class="literal">apiman.properties</code> for the gateway, and set up your APIs with their respective
truststores and keystores (the specifics of how to do this will depend on your
API’s implementation).</p><p>We will also set the following in <code class="literal">apiman.properties</code> to make our development
easier:</p><pre class="literallayout">apiman-gateway.connector-factory.tls.allowAnyHost=true</pre><p>When you add your MTLS protected APIs into apiman, you should set the
<code class="literal">API Security</code> field to <code class="literal">MTLS/Two-Way-SSL</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_mtls_via_custom_certificate_authority"/>4.3.3.2. MTLS via Custom Certificate Authority</h4></div></div></div><p>The previous approach works for development, but doesn’t scale well, is harder to manage
and doesn’t gracefully handle revocations, expiry, expansion, etc. Instead, let’s
summarise a scenario where an organisation has an internal CA which they use to
sign APIs' certificates. The process for generating a CA and signing
certificates is out of scope for this guide, but is trivial to accomplish using
OpenSSL, LibreSSL, or similar.</p><p>Let’s imagine we have a CA called <code class="literal">apimanCA</code>, and have <span class="strong"><strong>signed</strong></span> the certificates
for each node.</p><div class="table"><a id="d0e698"/><p class="title"><b>Table 4.2. CA-based MTLS Setup</b></p><div class="table-contents"><table summary="CA-based MTLS Setup" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="left" valign="top">Component</th><th align="left" valign="top">Signed Key Alias</th><th align="left" valign="top">Truststore Contents</th></tr></thead><tbody><tr><td align="left" valign="top"><p>Apiman Gateway</p></td><td align="left" valign="top"><p>gateway (signed by apimanCA)</p></td><td align="left" valign="top"><p>apimanCA.cer</p></td></tr><tr><td align="left" valign="top"><p>API A</p></td><td align="left" valign="top"><p>api_a (signed by apimanCA)</p></td><td align="left" valign="top"><p>apimanCA.cer</p></td></tr><tr><td align="left" valign="top"><p>API N</p></td><td align="left" valign="top"><p>api_n (signed by apimanCA)</p></td><td align="left" valign="top"><p>apimanCA.cer</p></td></tr></tbody></table></div></div><br class="table-break"/><p>Despite the initial administrative work setting up the CA and signing the
certificates, this process is drastically less effort to maintain in large
deployments. Only the trusted CA needs to be in the truststore, and any
certificates signed by it are trusted by virtue of this.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_make_changes_to_apiman_properties_3"/>4.3.4. Make changes to "apiman.properties"</h3></div></div></div><p>Once you have your Trust Store and Key Store properly configured, you must
configure your apiman.properties file.  Here is a summary of the properties:</p><p>Omit any properties which are not relevant to you, with the exception of
<code class="literal">trustStore</code>, which is mandatory for MTLS.</p><pre class="screen"># ---------------------------------------------------------------------
# SSL/TLS settings for the gateway connector(s).
# ---------------------------------------------------------------------

# Trust store contains certificate(s) trusted by gateway.
apiman-gateway.connector-factory.tls.trustStore=&lt;PATH_TO_TRUST_STORE&gt;
apiman-gateway.connector-factory.tls.trustStorePassword=&lt;PASSWORD_IF_ANY&gt;

# Key store contains gateway's keys (including private components: keep it safe).
apiman-gateway.connector-factory.tls.keyStore=&lt;PATH_TO_KEY_STORE&gt;
apiman-gateway.connector-factory.tls.keyStorePassword=&lt;PASSWORD_IF_ANY&gt; # Password on key store as a whole
apiman-gateway.connector-factory.tls.keyPassword=&lt;PASSWORD_IF_ANY&gt; # Password on specific key(s)
# By default all keys can be used (will try all). If alias list provided, will only attempt to use listed keys.
apiman-gateway.connector-factory.tls.keyAliases=&lt;COMMA_SEPARATED_LIST&gt;

# Allowed TLS/SSL protocols and ciphers suites as CSV. Availability will vary depending on your JVM impl.
# Uses JVM defaults depending if not explicitly provided.
# See: https://docs.oracle.com/javase/7/docs/technotes/guides/security/SunProviders.html
apiman-gateway.connector-factory.tls.allowedProtocols=TLSv1.2,TLSv1.1
apiman-gateway.connector-factory.tls.allowedCiphers=TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA

# Whether certificate host checks should be bypassed. *Use with great care.*
apiman-gateway.connector-factory.tls.allowAnyHost=false

# Whether self-signed certificates should be automatically trusted. *Use with great care.*
apiman-gateway.connector-factory.tls.allowSelfSigned=false</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="caution"><h2>Caution</h2><p>The settings chosen here have significant security implications. Best practice
guides are <a class="link" href="https://www.owasp.org/" target="">available at OWASP</a>.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="__re_start_apiman_3"/>4.3.5. (Re)start apiman</h3></div></div></div><p>If apiman was running, you should stop it now.  Once everything is shutdown, and the changes
to apiman.properties have been made, go ahead and start apiman up again.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configure_one_or_more_api_to_use_mtls"/>4.3.6. Configure one or more API to use MTLS</h3></div></div></div><p>Now that the apiman MTLS feature has been configured, use the Manager UI to enable MTLS in
one or more API.  This can be done on the "Implementation" tab when you are configuring
the details of your back-end endpoint (URL, type, and endpoint security).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_an_external_keycloak_authentication_server"/>4.4. How To:  Use an External Keycloak Authentication Server</h2></div></div></div><p>The apiman quickstart overlay ZIP comes with an embedded version of Keycloak that we use for
authentication.  You may already have a Keycloak instance that you use.  This section
explains how to modify apiman to use yours instead of ours.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_4"/>4.4.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Create the apiman Realm in Keycloak</li><li>Configure the API Manager UI client in Keycloak</li><li>Point apiman at the remote Keycloak</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_create_the_apiman_realm_in_keycloak"/>4.4.2. Create the apiman Realm in Keycloak</h3></div></div></div><p>You’ll need to make sure you create the <span class="strong"><strong>apiman</strong></span> realm in your Keycloak server.  A
quick way to do that is to use the Keycloak admin console to import the apiman
realm file located here:</p><p><a class="link" href="https://github.com/apiman/apiman/blob/master/distro/data/src/main/resources/data/apiman-realm.json" target="">https://github.com/apiman/apiman/blob/master/distro/data/src/main/resources/data/apiman-realm.json</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_configure_the_api_manager_ui_client_in_keycloak"/>4.4.3. Configure the API Manager UI client in Keycloak</h3></div></div></div><p>Once the apiman realm has been created or imported, make sure to configure the
<span class="strong"><strong>Valid Redirect URIs</strong></span> section of the <span class="strong"><strong>apimanui</strong></span> client.  The default value of
"/apimanui/*" must be replaced with the full public URL of your API Manager UI.
For example, the value may be something like:</p><pre class="literallayout">https://apiman.myorg.com/apimanui/*</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Don’t forget the "*" wildcard at the end of the URL.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_point_apiman_at_the_remote_keycloak"/>4.4.4. Point apiman at the remote Keycloak</h3></div></div></div><p>Finally, you must modify the <span class="strong"><strong>standalone-apiman.xml</strong></span> configuration file to point
apiman at the remote Keycloak server.  Make sure you know the full public URL of
your Keycloak server and add it to the following section of <span class="strong"><strong>standalone-apiman.xml</strong></span>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns:kc</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:keycloak:1.0&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">MIGf..snip..QAB</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm-public-key</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">https://keycloak-host.org:8443/auth</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:auth-server-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">none</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:ssl-required</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">false</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:enable-cors</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">preferred_username</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:principal-attribute</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">kc:realm</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>If you manually created the apiman realm in Keycloak, you will also need to
copy the realm’s public key into &lt;kc:realm-public-key&gt; above.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_configure_a_custom_api_catalog"/>4.5. How To:  Configure a Custom API Catalog</h2></div></div></div><p>The API Manager has a feature where users can import APIs from a globally configured
API Catalog.  By default, apiman comes with a community catalog that contains a set
of common public APIs such as Flickr and Netflix.  When deploying apiman into an
enterprise setting, it is often useful to replace the community API Catalog with
something that lists out the internal APIs available within the enterprise.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_5"/>4.5.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Describe your enterprise APIs as apiman API Catalog JSON</li><li>Make your enterprise API Catalog available in URL form</li><li>Point apiman at your enterprise API Catalog</li></ol></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_create_a_custom_enterprise_api_catalog_json"/>4.5.1.1. Create a Custom Enterprise API Catalog JSON</h4></div></div></div><p>The first thing you will need to do is express all of your enterprise APIs as a
JSON file.  The format of the JSON file is specific to apiman.  You can find an
example of the format here:</p><p><a class="link" href="https://github.com/apiman/apiman-api-catalog/blob/master/catalog.json" target="">https://github.com/apiman/apiman-api-catalog/blob/master/catalog.json</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_make_your_enterprise_api_catalog_available"/>4.5.1.2. Make Your Enterprise API Catalog Available</h4></div></div></div><p>Now that you have a custom JSON based API Catalog, you need to make it available
at a URL accessible to the API Manager.  This can either be done by stashing it
in some web server location so you have an http based URL, or you can store
it locally on the API Manager server so as to have a valid file based URL.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_point_apiman_at_your_enterprise_api_catalog"/>4.5.1.3. Point apiman at Your Enterprise API Catalog</h4></div></div></div><p>The last step is to make apiman aware of your custom API Catalog file.  The
catalog is configured in the <span class="strong"><strong>apiman.properties</strong></span> file via these properties:</p><pre class="screen">apiman-manager.api-catalog.type=io.apiman.manager.api.core.catalog.JsonApiCatalog
apiman-manager.api-catalog.catalog-url=http://cdn.rawgit.com/apiman/apiman-api-catalog/1.2.0.Final/catalog.json</pre><p>Simply change the URL defined by the <code class="literal">apiman-manager.api-catalog.catalog-url</code> property
and you’re good to go!</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>For even more customization, you can actually implement your own API Catalog
java class.  This approach will allow you to find your APIs in whatever location they
happen to be (e.g. a database, registry, etc).  Please see the Developer Guide
for more information on how to create a truly custom API Catalog.</p></div></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_a_custom_plugin_registry"/>4.6. How To:  Use a Custom Plugin Registry</h2></div></div></div><p>The API Manager uses a plugin registry to show admin users a list of available plugins
that can be installed.  Apiman comes with an official plugin registry that shows a
list of the standard apiman plugins.  If your enterprise implements a large number
of custom policies, you may find it useful to replace the standard registry with one
that includes your custom plugins in the list.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_6"/>4.6.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Describe your enterprise plugins in a registry JSON file</li><li>Make your enterprise plugin registry available in URL form</li><li>Point apiman at your enterprise plugin registry</li></ol></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_create_a_custom_enterprise_plugin_registry_json"/>4.6.1.1. Create a Custom Enterprise Plugin Registry JSON</h4></div></div></div><p>The first thing you will need to do is express all of your enterprise plugins as a
JSON file.  The format of the JSON file is specific to apiman.  You can find an
example of the format here:</p><p><a class="link" href="https://github.com/apiman/apiman-plugin-registry/blob/master/registry.json" target="">https://github.com/apiman/apiman-plugin-registry/blob/master/registry.json</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_make_your_enterprise_plugin_registry_available"/>4.6.1.2. Make Your Enterprise Plugin Registry Available</h4></div></div></div><p>Now that you have a custom JSON based plugin registry, you need to make it available
at a URL accessible to the API Manager.  This can either be done by stashing it
in some web server location so you have an http based URL, or you can store
it locally on the API Manager server so as to have a valid file based URL.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_point_apiman_at_your_enterprise_plugin_registry"/>4.6.1.3. Point apiman at Your Enterprise Plugin Registry</h4></div></div></div><p>The last step is to make apiman aware of your custom plugin registry file.  The
registry is configured in the <span class="strong"><strong>apiman.properties</strong></span> file via the following property:</p><pre class="screen">apiman-manager.plugins.registries=http://cdn.rawgit.com/apiman/apiman-plugin-registry/1.2.0.Final/registry.json</pre><p>The value of this property is a comma-separated list of URLs.  Each URL in the list
should point to a valid plugin registry JSON file.  So to include your enterprise
plugins in the list, simply add the URL to your plugin registry to the end of the
existing list.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_property_replacement_in_policy_config"/>4.7. How To:  Use Property Replacement in Policy Config</h2></div></div></div><p>It is often useful to externalize certain information that varies from one deployment
environment to another.  For example, you may have an LDAP server for authentication,
but you have one in the Test deployment environment and a different one in Production.
Rather than configure your apiman policies differently in each environment (to match
the actual LDAP connection info) you can externalize those settings into system
properties or environment variables.  Once that is done, you can refer to those
properties/variables in your apiman policy configuration.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_7"/>4.7.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Externalize values into system properties or environment variables</li><li>Reference a system property or environment variable in a policy</li></ol></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_externalize_values"/>4.7.1.1. Externalize Values</h4></div></div></div><p>Depending on your deployment strategy, how you do this may vary.  If you are using
WildFly, for example, you can set system properties in the standalone.xml file or
by passing them in via -D parameters on startup (not recommended).  For more
information, see:</p><p><a class="link" href="https://docs.jboss.org/author/display/WFLY8/General+configuration+concepts" target="">https://docs.jboss.org/author/display/WFLY8/General+configuration+concepts</a></p><p>Describing all approaches to setting system properties and environment variables
is out of scope for this document.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_reference_a_system_property_or_environment_variable"/>4.7.1.2. Reference a System Property or Environment Variable</h4></div></div></div><p>Once you have some values externalized into system properties or environment
variables, you can reference them easily in your apiman policies.  All you need
to do is use the Ant style syntax to refer to your externalized values, like
this:</p><pre class="screen">${MY_ENVIRONMENT_VARIABLE}</pre><p>A variable of this style can be used in any apiman policy configuration field.
The variables are resolved when the policy configuration is first loaded, and
then cached.  To change a value, you must restart your server.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>When resolving variables, if there is an environment variable with the same
name as a system property, the value of the <span class="strong"><strong>system property</strong></span> will be used.</p></div></div></div></div></div></div></body></html>
