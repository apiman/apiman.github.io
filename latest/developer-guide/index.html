<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">apiman - Developer Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e3"/>apiman - Developer Guide</h1></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#_introduction">1. Introduction</a></span></dt><dt><span class="chapter"><a href="#_developer_resources">2. Developer Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#_source_code">2.1. Source Code</a></span></dt><dt><span class="section"><a href="#_issue_tracking">2.2. Issue Tracking</a></span></dt><dt><span class="section"><a href="#_development_tools">2.3. Development Tools</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_building_the_project">3. Building the Project</a></span></dt><dt><span class="chapter"><a href="#_setting_up_a_development_environment">4. Setting up a Development Environment</a></span></dt><dt><span class="chapter"><a href="#_architecture">5. Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#_policy_implementations">5.1. Policy Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#_standard_ipolicy">5.1.1. Standard IPolicy</a></span></dt><dt><span class="section"><a href="#_idata_policy">5.1.2. IData Policy</a></span></dt><dt><span class="section"><a href="#_performance_considerations">5.1.3. Performance Considerations</a></span></dt><dt><span class="section"><a href="#_loading_policy_implementations">5.1.4. Loading Policy Implementations</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_gateway_implementations">6. Gateway Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#_implementing_iapimanbuffer">6.1. Implementing IApimanBuffer</a></span></dt><dt><span class="section"><a href="#_executing_apiman_core">6.2. Executing apiman-core</a></span></dt><dd><dl><dt><span class="section"><a href="#_streaming_data">6.2.1. Streaming data</a></span></dt><dt><span class="section"><a href="#_handling_results">6.2.2. Handling results</a></span></dt><dt><span class="section"><a href="#_handling_failures">6.2.3. Handling Failures</a></span></dt></dl></dd><dt><span class="section"><a href="#_creating_a_service_connector">6.3. Creating a Service Connector</a></span></dt><dd><dl><dt><span class="section"><a href="#_connector_basics">6.3.1. Connector basics</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnection">6.3.2. Creating the IServiceConnection</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnectionresponse">6.3.3. Creating the IServiceConnectionResponse</a></span></dt><dt><span class="section"><a href="#_implementation_strategies">6.3.4. Implementation strategies</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_introduction"/>Chapter 1. Introduction</h2></div></div></div><p>Are you interested in contributing to the development of apiman?  Maybe you want to embed the
project in your own solution?  In either case this is the guide for you.</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_developer_resources"/>Chapter 2. Developer Resources</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_source_code">2.1. Source Code</a></span></dt><dt><span class="section"><a href="#_issue_tracking">2.2. Issue Tracking</a></span></dt><dt><span class="section"><a href="#_development_tools">2.3. Development Tools</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_source_code"/>2.1. Source Code</h2></div></div></div><p>The apiman source code is located in github here:</p><p><a class="ulink" href="https://github.com/apiman/apiman">https://github.com/apiman/apiman</a></p><p>Source code for the apiman project web site is here:</p><p><a class="ulink" href="https://github.com/apiman/apiman.github.io">https://github.com/apiman/apiman.github.io</a></p><p>The docker files are currently here:</p><p><a class="ulink" href="https://github.com/apiman/apiman-docker">https://github.com/apiman/apiman-docker</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_issue_tracking"/>2.2. Issue Tracking</h2></div></div></div><p>The apiman project uses JIRA to track issues such as bugs and feature requests.  It’s a good place to start
if you’re trying to figure out how to get involved!</p><p><a class="ulink" href="https://issues.jboss.org/browse/APIMAN">https://issues.jboss.org/browse/APIMAN</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_development_tools"/>2.3. Development Tools</h2></div></div></div><p>We’re rather IDE agnostic, so contributors should feel free to use whatever tools they feel most
comfortable with.  At the time of this writing, the core apiman developers primarily use Eclipse
Kepler.</p><p><a class="ulink" href="http://www.eclipse.org/downloads/">http://www.eclipse.org/downloads/</a></p><p>The core apiman project is built using maven.  Currently we recommend at least version 3.0.3.</p><p><a class="ulink" href="http://maven.apache.org/download.cgi">http://maven.apache.org/download.cgi</a></p><p>And of course you’ll need to have git installed if you want to check out the code from github.</p><p><a class="ulink" href="http://git-scm.com/">http://git-scm.com/</a></p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_building_the_project"/>Chapter 3. Building the Project</h2></div></div></div><p>Building apiman should be a simple matter of doing a standard Maven build:</p><pre class="literallayout">mvn clean install</pre><p>This will do a full build of apiman and execute all unit tests.  However,
the result will not include a ready-to-run version of apiman.  For that, you
may want to try the following:</p><pre class="literallayout">mvn clean install -Pinstall-all-wildfly8</pre><p>This command will do a full apiman build, but will also download WildFly
and install apiman into it.  The result will be a fully configured install of
apiman running in WildFly.  The location of this WildFly install will be here:</p><pre class="literallayout">apiman/tools/server-all/targe/wildfly-{wildfly.version}/</pre><p>At this point you can test apiman by simply running WildFly from the above
location using a command something like this:</p><pre class="literallayout">./bin/standalone.sh -b 0.0.0.0</pre></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_setting_up_a_development_environment"/>Chapter 4. Setting up a Development Environment</h2></div></div></div><p>Because apiman is a fairly standard maven project, it should be relatively easy
to import the project into Eclipse or IntelliJ IDEA.  For now we’ll leave this
as an exercise for the reader.</p></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_architecture"/>Chapter 5. Architecture</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_policy_implementations">5.1. Policy Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#_standard_ipolicy">5.1.1. Standard IPolicy</a></span></dt><dt><span class="section"><a href="#_idata_policy">5.1.2. IData Policy</a></span></dt><dt><span class="section"><a href="#_performance_considerations">5.1.3. Performance Considerations</a></span></dt><dt><span class="section"><a href="#_loading_policy_implementations">5.1.4. Loading Policy Implementations</a></span></dt></dl></dd></dl></div><p>The basic architecture of apiman is fairly straightforward.  There are several WARs that
make up the default apiman installation.  These include:</p><div class="itemizedlist"><ul><li>API Manager back-end (JAX-RS WAR)</li><li>API Manager UI (GWT/Errai WAR)</li><li>API Gateway Config (JAX-RS WAR)</li><li>API Gateway (Servlet WAR)</li></ul></div><p>The API Manager back-end WAR is responsible for exposing a set of REST endpoints that
make up the API Manager REST interface.  The API Manager UI uses this REST API
directly when the user manages the various entities in the data model.</p><p>The API Manager UI is a client-only GWT/Errai application.  Aside from authentication
related activities, this WAR only contains HTML, JavaScript, and CSS.  The UI uses
the browser to make direct, authenticated calls to the REST endpoints exposed by the
API Manager back-end WAR.</p><p>The API Gateway Config exposes the standard apiman Gateway REST API so that the API
Gateway can be remotely configured.  This is the REST API that the API Manager uses
whenever a user publishes a Service or registers an Application.  It is responsible
for configuring the API Gateway’s embedded Policy Engine.</p><p>The API Gateway is the primary runtime component of apiman and is implemented as a
servlet that embeds the apiman Policy Engine.  All requests to the API Gateway WAR are
assumed to be intended for managed Services previously published to it.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_policy_implementations"/>5.1. Policy Implementations</h2></div></div></div><p>Policies are the mechanism through which the principal functionality of apiman is enforced.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_standard_ipolicy"/>5.1.1. Standard IPolicy</h3></div></div></div><p>All policies must implement the <code class="literal">IPolicy</code> interface, consisting of three methods.</p><p>The <code class="literal">apply</code> method with <code class="literal">ServiceRequest</code> is called during the request phase, and the <code class="literal">apply</code> with <code class="literal">ServiceResponse</code> during the response phase:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;apply</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyContext</span><!-- <br/> --><span class="java_plain">&nbsp;context</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;config</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyChain</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;chain</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">void</span><span class="java_plain">&nbsp;apply</span><span class="java_separator">(</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;config</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyChain</span><span class="java_operator">&lt;</span><span class="java_type">ServiceResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;chain</span><span class="java_separator">);</span></pre><p>The service objects, respectively, provide abstracted representations of the head of a request and response for a given conversation. These can be modified in any manner the implementor sees fit.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Policy instances are bound to a conversation, hence the same object will receive the response corresponding to the request.</p></div><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;parseConfiguration</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;jsonConfiguration</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">throws</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ConfigurationParseException</span><!-- <br/> --><span class="java_separator">;</span></pre><p>The final <code class="literal">IPolicy</code> method is used to parse JSON configuration into an arbitrary object configuration which will be passed in in its parsed form to <code class="literal">doApply</code>, where the implementor may cast it their native configuration object. This method should be regarded as a static, as it is only called at the point when a policy is registered.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_indicating_successes"/>5.1.1.1. Indicating Successes</h4></div></div></div><p>If a policy determines that the conversation can continue, <code class="literal">chain.doApply</code> should be signalled. Any modifications you wish to pass onto the next policy should be completed and included in the invocation.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_indicating_failures"/>5.1.1.2. Indicating Failures</h4></div></div></div><p>If it is determined that a conversation should be interrupted for governance reasons (i.e. according to business logic and not exceptional), then <code class="literal">chain.doFailure</code> should be signalled. A useful <code class="literal">PolicyFailure</code> should be provided, which allows gateways to respond in a sensible way to the requestor.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>The platform’s <code class="literal">PolicyFailureFactoryComponent</code> can be used to generate failures.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_handling_exceptions"/>5.1.1.3. Handling Exceptions</h4></div></div></div><p>As a factor of the asynchronous nature of apiman, any exceptions that may occur during the operation of a policy should be caught and explicitly handed to <code class="literal">chain.doError</code>. If exceptions are left uncaught, then it is possible that they will be lost.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_idata_policy"/>5.1.2. IData Policy</h3></div></div></div><p>Whilst standard policies are concerned only with the head of the conversation, it is also possible for policies to access and manipulate the body in transit. A data policy must implement the <code class="literal">IDataPolicy</code> interface.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Handling of data streams is a performance sensitive area, implementors should strive to be as efficient as possible and avoid any unnecessary interactions with the stream.</p></div><p>The <code class="literal">getRequestDataHandler</code> and <code class="literal">getResponseDataHandler</code> methods are the data corollaries of <code class="literal">apply</code>. Implementors must return <code class="literal">IReadWriteStream</code> streams, which apiman uses to write data chunks into policies, and the policies write data to subsequent policies:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">IReadWriteStream</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;getRequestDataHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IPolicyContext</span><!-- <br/> --><span class="java_plain">&nbsp;context</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_type">IReadWriteStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getResponseDataHandler</span><span class="java_separator">(</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">);</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not return an <code class="literal">IApimanBuffer</code> with a different native type than you received. Use assign and append patterns instead.</p></div><p>Implementors must explicitly hand each chunk onto apiman when they are finished interacting with it. A convenient way to achieve this is via <code class="literal">AbstractStream&lt;H&gt;</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Override</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IReadWriteStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceRequest</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;getRequestDataHandler</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IPolicyContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">AbstractStream</span><span class="java_operator">&lt;</span><span class="java_type">ServiceRequest</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;write</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Mutate</span><span class="java_plain">&nbsp;chunk&nbsp;by&nbsp;appending&nbsp;a&nbsp;string</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">append</span><span class="java_separator">(</span><span class="java_literal">&quot;my&nbsp;modification&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">'re&nbsp;finished</span><span class="java_operator">:</span><span class="java_plain">&nbsp;write&nbsp;the&nbsp;chunk&nbsp;back&nbsp;to&nbsp;apiman</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;using&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">().</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">chunk</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;end</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">End</span><span class="java_plain">&nbsp;of&nbsp;stream&nbsp;signalled</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;cleanup</span><span class="java_separator">,</span><span class="java_plain">&nbsp;etc</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">super</span><span class="java_separator">.</span><span class="java_plain">end</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not mutate an <code class="literal">IApimanBuffer</code> once handed over.</p></div><p>The request or response body will not begin streaming before the corresponding <code class="literal">doApply</code> has been called, however, it is still possible to interrupt the conversation during the streaming phase by signalling <code class="literal">doFailure</code> or <code class="literal">doError</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_performance_considerations"/>5.1.3. Performance Considerations</h3></div></div></div><p>Policies are amongst the most impactful elements of the system for performance. To minimise the impact of a policy implementors may wish to follow these guidelines:</p><div class="itemizedlist"><ul><li>■ Maintain as little state within a policy instance as possible.</li><li>■ Call <code class="literal">doApply</code>, <code class="literal">doFailure</code> or <code class="literal">doError</code> as soon as possible.</li><li>■ Data policies should interact with the data stream as efficiently as possible and prefer mutating in-place (especially with small changes).</li><li>■ If you are contributing a policy to apiman: implement any long-running tasks asynchronously (e.g. database calls); <span class="strong"><strong>do not</strong></span> block the main thread (e.g. blocking futures, wait, sleep); use asynchronous techniques to interact with the outside world, such as callbacks.</li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_loading_policy_implementations"/>5.1.4. Loading Policy Implementations</h3></div></div></div><p>The method of making policies available for loading is platform-specific: refer to your implementation’s documentation to discover how to achieve this.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_gateway_implementations"/>Chapter 6. Gateway Implementations</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_implementing_iapimanbuffer">6.1. Implementing IApimanBuffer</a></span></dt><dt><span class="section"><a href="#_executing_apiman_core">6.2. Executing apiman-core</a></span></dt><dd><dl><dt><span class="section"><a href="#_streaming_data">6.2.1. Streaming data</a></span></dt><dt><span class="section"><a href="#_handling_results">6.2.2. Handling results</a></span></dt><dt><span class="section"><a href="#_handling_failures">6.2.3. Handling Failures</a></span></dt></dl></dd><dt><span class="section"><a href="#_creating_a_service_connector">6.3. Creating a Service Connector</a></span></dt><dd><dl><dt><span class="section"><a href="#_connector_basics">6.3.1. Connector basics</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnection">6.3.2. Creating the IServiceConnection</a></span></dt><dt><span class="section"><a href="#_creating_the_iserviceconnectionresponse">6.3.3. Creating the IServiceConnectionResponse</a></span></dt><dt><span class="section"><a href="#_implementation_strategies">6.3.4. Implementation strategies</a></span></dt></dl></dd></dl></div><p>At the heart of any apiman gateway implementation is the flexible, lightweight
apiman-core. The core serves to execute policies upon the traffic passing through
it, determining whether a given conversation should continue or not.</p><p>A set of simple, asynchronous interfaces are provided which an implementor should
fulfill using the platform’s native functionality to allow apiman to interact with
its various components and services.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_implementing_iapimanbuffer"/>6.1. Implementing IApimanBuffer</h2></div></div></div><p>Before you can send any data through apiman, you must implement the <code class="literal">IApimanBuffer</code> interface. It provides a set of methods which allow apiman to access your native buffer format as effectively as possible. Any data you pass into apiman must be wrapped in your implementation of <code class="literal">IApimanBuffer</code>, whilst any data returned to you by apiman will be an <code class="literal">IApimanBuffer</code> which you can extricate your native buffer from.</p><p>Implementation is fairy self explanatory, but a few points are worth noting:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">YourApimanBufferImpl</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IApimanBuffer</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">VertxApimanBuffer</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">nativeBuffer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;is&nbsp;your&nbsp;mechanism&nbsp;to&nbsp;efficiently&nbsp;yank&nbsp;your&nbsp;</span><span class="java_keyword">native</span><span class="java_plain">&nbsp;buffer&nbsp;back</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_plain">&nbsp;getNativeBuffer</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;length</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;nativeBuffer</span><span class="java_separator">.</span><span class="java_plain">length</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;insert</span><span class="java_separator">(</span><span class="java_type">int</span><span class="java_plain">&nbsp;index</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;buffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;nativeBuffer</span><span class="java_separator">.</span><span class="java_plain">setBuffer</span><span class="java_separator">(</span><span class="java_plain">index</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Buffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;buffer</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_separator">...</span><span class="java_operator">&gt;</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Implementors of <code class="literal">IApimanBuffer</code> should ensure that the native format is preserved within the instance, this allows it to be retrieved again using <code class="literal">getNativeBuffer</code>. Any mutation should be on the native buffer.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_executing_apiman_core"/>6.2. Executing apiman-core</h2></div></div></div><p>Let’s consider the following snippet:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">IEngine</span><!-- <br/> --><span class="java_plain">&nbsp;engine&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">your&nbsp;engine</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEngine</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Request</span><span class="java_plain">&nbsp;executor</span><span class="java_separator">,</span><span class="java_plain">&nbsp;through&nbsp;which&nbsp;we&nbsp;can&nbsp;send&nbsp;chunks&nbsp;and&nbsp;indicate&nbsp;end</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceRequestExecutor</span><span class="java_plain">&nbsp;requestExecutor&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engine</span><span class="java_separator">.</span><span class="java_plain">executor</span><span class="java_separator">(</span><span class="java_plain">request</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IAsyncResult</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;result</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;streamHandler&nbsp;called&nbsp;when&nbsp;back</span><span class="java_operator">-</span><span class="java_plain">end&nbsp;connector&nbsp;is&nbsp;ready&nbsp;to&nbsp;receive&nbsp;data</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">requestExecutor</span><span class="java_separator">.</span><span class="java_plain">streamHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnection</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;writeStream</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Execute</span><span class="java_plain">&nbsp;the&nbsp;request</span>
<!--  --><br/><span class="java_plain">executor</span><span class="java_separator">.</span><span class="java_plain">execute</span><span class="java_separator">();</span></pre><p>After instantiating your engine implementation, you can call <code class="literal">execute</code>. This is the main point through which you pipe data into and out of apiman. In order to avoid any buffering you must write body data through <code class="literal">streamHandler</code>'s <code class="literal">IServiceConnection</code> which will be called when the connection to the backend service is ready to receive. The result is provided to <code class="literal">executor</code>'s <code class="literal">IAsyncResultHandler</code>, which can be evaluated to determine the result of the call, and, if successful, retrieve a <code class="literal">ServiceResponse</code> and attach handlers to receive response data.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_streaming_data"/>6.2.1. Streaming data</h3></div></div></div><p>Exploring <code class="literal">streamHandler</code> further:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">requestExecutor</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">streamHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IAsyncHandler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">IServiceConnection</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_keyword">final</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;writeStream</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Just</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;illustrative&nbsp;purposes</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;apimanBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">YourApimanBufferImpl</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Call</span><span class="java_plain">&nbsp;#write&nbsp;as&nbsp;many&nbsp;times&nbsp;as&nbsp;desired</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;writeStream</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">apimanBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Call</span><span class="java_plain">&nbsp;#end&nbsp;only&nbsp;once</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;writeStream</span><span class="java_separator">.</span><span class="java_plain">end</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Any data flowing into the executor must first be wrapped in your implementation of <code class="literal">IApimanBuffer</code> before being passed to <code class="literal">write</code>. You may call <code class="literal">write</code> an unlimited number of times, and indicate that transmission has completed by signalling <code class="literal">end</code>.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>No further calls to <code class="literal">write</code> should occur after <code class="literal">end</code> has been called.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_handling_results"/>6.2.2. Handling results</h3></div></div></div><p>An excerpt of the executor’s result handler and considering a successful result:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">engine</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">executor</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">request</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IAsyncResultHandler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">IEngineResult</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IAsyncResult</span><span class="java_operator">&lt;</span><span class="java_type">IEngineResult</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;result</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Did</span><span class="java_plain">&nbsp;an&nbsp;exception&nbsp;occur</span><span class="java_operator">?</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">result</span><span class="java_separator">.</span><span class="java_plain">isSuccess</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IEngineResult</span><span class="java_plain">&nbsp;engineResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;result</span><span class="java_separator">.</span><span class="java_plain">getResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">engineResult</span><span class="java_separator">.</span><span class="java_plain">isResponse</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Our</span><span class="java_plain">&nbsp;successfully&nbsp;returned&nbsp;service&nbsp;response</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getServiceResponse</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;a&nbsp;bodyHandler&nbsp;to&nbsp;receive&nbsp;the&nbsp;response's&nbsp;body&nbsp;chunks</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">bodyHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Important</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;efficiency</span><span class="java_separator">,</span><span class="java_plain">&nbsp;retrieve&nbsp;</span><span class="java_keyword">native</span><span class="java_plain">&nbsp;buffer&nbsp;format&nbsp;directly&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;possible</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_separator">(</span><span class="java_plain">chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_keyword">instanceof</span><span class="java_plain">&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;buffer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_plain">&nbsp;an&nbsp;endHandler&nbsp;to&nbsp;receive&nbsp;the&nbsp;end&nbsp;signal</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">endHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">Void</span><span class="java_plain">&nbsp;flag</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Transmission</span><span class="java_plain">&nbsp;has&nbsp;now&nbsp;completed</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;policy&nbsp;failure</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;exception</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">});</span></pre><p>After testing <code class="literal">IAsyncResult.isSuccess</code>, we can be certain that the request completed without an exception occurring. Next, we verify <code class="literal">IEngineResult.isFailure</code>, which indicates whether there was a policy failure or the response returned successfully.</p><p>Upon success the <code class="literal">ServiceResponse</code> can be extracted, and a <code class="literal">bodyHandler</code> and <code class="literal">endHandler</code> can be attached in order to receive the response’s associated data as it arrives. At this point the data has exited apiman, and can handled as makes sense for your implementation. For instance, you may wish to translate the <code class="literal">ServiceResponse</code> into its native equivalent and return it to the requestor.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Where possible, it is advisable to use <code class="literal">getNativeBuffer</code> on any <code class="literal">IApimanBuffer</code> chunks you receive; avoiding any expensive format conversions. You must cast it back to your native format; <code class="literal">instanceof</code> is helpful to ensure the the correct type has been received.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_handling_failures"/>6.2.3. Handling Failures</h3></div></div></div><p>In the case of errors or policy failures, a variety of information is provided which can be used to construct a sensible response:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">if</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">result</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">isSuccess</span><!-- <br/> --><span class="java_separator">())</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IEngineResult</span><span class="java_plain">&nbsp;engineResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;result</span><span class="java_separator">.</span><span class="java_plain">getResult</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_operator">!</span><span class="java_plain">engineResult</span><span class="java_separator">.</span><span class="java_plain">isFailure</span><span class="java_separator">())</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_separator">...</span><span class="java_operator">&gt;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">PolicyFailure</span><span class="java_plain">&nbsp;policyFailure&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getPolicyFailure</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;type:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getType</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;code:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getFailureCode</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;Message:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getMessage</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Failure&nbsp;Headers:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;policyFailure</span><span class="java_separator">.</span><span class="java_plain">getHeaders</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">Throwable</span><span class="java_plain">&nbsp;throwable&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;engineResult</span><span class="java_separator">.</span><span class="java_plain">getError</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">error</span><span class="java_separator">(</span><span class="java_literal">&quot;Something&nbsp;bad&nbsp;happened:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;throwable</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The appropriate response to failures will vary widely depending upon implementation. For instance, a RESTful platform may wish to transmit an appropriate HTTP error code, message and possibly body.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_creating_a_service_connector"/>6.3. Creating a Service Connector</h2></div></div></div><p>Connectors enable apiman to transmit and receive data from the backend services under management. For instance, should your system need to connect to an HTTP service, an HTTP connector must be created. The following samples illustrate in general terms how an implementor may go about creating a connector, and although the specifics will vary extremely widely depending upon the platform some general principals should be obeyed.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_connector_basics"/>6.3.1. Connector basics</h3></div></div></div><p>Inside of your <code class="literal">IConnectorFactory</code> implementation you must return an <code class="literal">IServiceConnector</code> corresponding to the type of request and service being interacted with:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ConnectorFactory</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IConnectorFactory</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnector</span><span class="java_plain">&nbsp;createConnector</span><span class="java_separator">(</span><span class="java_type">ServiceRequest</span><span class="java_plain">&nbsp;request</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Service</span><span class="java_plain">&nbsp;service</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnector</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>Inspecting the <code class="literal">IServiceConnector</code> more closely, we can see the key interface of a connector:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IServiceConnection</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">ServiceRequest</span><!-- <br/> --><span class="java_plain">&nbsp;request</span><!-- <br/> --><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResultHandler</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;resultHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The <code class="literal">IServiceConnection</code> you must return is used by apiman to write request chunks; hence, it will be <span class="strong"><strong>read</strong></span> by your connector. Conversely, the <code class="literal">IServiceConnectionResponse</code> handler must be called in order to send the <code class="literal">ServiceResponse</code> and its associated data chunks back to apiman once a response has returned from the service; hence, you will <span class="strong"><strong>write</strong></span> data to it.</p><p>The <code class="literal">IAsyncResultHandler</code> is also used to indicate whether an exception has occurred during the conversation with the backend.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_the_iserviceconnection"/>6.3.2. Creating the IServiceConnection</h3></div></div></div><p>Generally, an implementor must attempt to return their <code class="literal">IServiceConnection</code> as soon as it is valid for apiman to write data to the backend. Until you respond, apiman will not fire <code class="literal">IServiceRequestExecutor.streamHandler</code>, and hence no data will arrive prematurely to your connector. Following this guideline should help to minimise or eliminate any buffering requirements in your connectors.</p><p>Looking at an example:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Native</span><!-- <br/> --><span class="java_plain">&nbsp;platform's&nbsp;connector&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">e</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">g</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">&nbsp;HTTP</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">ImaginaryBackendConnector</span><span class="java_plain">&nbsp;imaginaryConnector&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Connection</span><span class="java_plain">&nbsp;c&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">establishConnection</span><span class="java_separator">(</span><span class="java_plain">service</span><span class="java_separator">.</span><span class="java_plain">getEndpoint</span><span class="java_separator">(),</span><span class="java_plain">&nbsp;</span><span class="java_separator">...);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Prepare</span><span class="java_plain">&nbsp;in&nbsp;advance&nbsp;to&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;something&nbsp;sensible&nbsp;with&nbsp;the&nbsp;response</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">See</span><span class="java_plain">&nbsp;next&nbsp;section&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;more&nbsp;detail</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">c</span><span class="java_separator">.</span><span class="java_plain">responseHandler</span><span class="java_separator">(</span><span class="java_operator">&lt;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;the&nbsp;response</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;an&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">From</span><span class="java_plain">&nbsp;our&nbsp;perspective&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_plain">&nbsp;is</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_operator">*</span><span class="java_plain">inbound&nbsp;data</span><span class="java_operator">*</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">i</span><span class="java_separator">.</span><span class="java_plain">e</span><span class="java_separator">.</span><span class="java_plain">&nbsp;the&nbsp;user&nbsp;writes&nbsp;to&nbsp;us</span><span class="java_separator">).</span>
<!--  --><br/><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnection</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;write</span><span class="java_separator">(</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;arriving&nbsp;data&nbsp;chunk</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">YourNativeBuffer</span><span class="java_plain">&nbsp;nativeBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">(</span><span class="java_type">YourNativeBuffer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">.</span><span class="java_plain">getNativeBuffer</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">write</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;end</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;the&nbsp;signal&nbsp;to&nbsp;indicate&nbsp;stream&nbsp;has&nbsp;completed</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">finish_connection</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;abort</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Handle</span><span class="java_plain">&nbsp;immediate&nbsp;abort</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;instance&nbsp;by&nbsp;closing&nbsp;your&nbsp;connection</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;imaginaryConnector</span><span class="java_separator">.</span><span class="java_plain">abort</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isFinished</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;finished</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">};</span></pre><p><code class="literal">imaginaryConnector</code> represents your platform’s backend connector. After establishing a connection that can accept data, you should return an <code class="literal">IServiceConnection</code>, allowing data to be written to your connector. You can extract your native buffer format using <code class="literal">getNativeBuffer</code> plus a cast. Although we haven’t yet explored how to handle a response, we can imagine that the platform’s <code class="literal">ImaginaryBackendConnector</code> would allows us to set a <code class="literal">responseHandler</code>, which will be fired when a response has arrived; this is point at which we can build an <code class="literal">IServiceConnectionResponse</code>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_the_iserviceconnectionresponse"/>6.3.3. Creating the IServiceConnectionResponse</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_handling_a_successful_response"/>6.3.3.1. Handling a successful response</h4></div></div></div><p>Apiman’s <code class="literal">resultHandler</code> should be called with an  <code class="literal">IServiceConnectionResponse</code> when your connector has received a response from the service.</p><p>Let’s imagine that <code class="literal">responseHandler</code> is called when the platform’s response has arrived, and looks like this:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">c</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">responseHandler</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Handler</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">ImaginaryResponse</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">ImaginaryResponse</span><span class="java_plain">&nbsp;response</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">});</span></pre><p>This is where we must build our apiman response, using the data returned in the platform’s response, and attaching appropriate handlers to capture any data that arrives.</p><p>In the following example, we expand the response <code class="literal">handle</code> method to build an <code class="literal">IServiceConnectionResponse</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">void</span><!-- <br/> --><span class="java_plain">&nbsp;handle</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_keyword">final</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">ImaginaryResponse</span><!-- <br/> --><span class="java_plain">&nbsp;response</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_plain">&nbsp;readStream&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;finished&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">false</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;response&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">YourResponseBuilder</span><span class="java_separator">.</span><span class="java_plain">build</span><span class="java_separator">(</span><span class="java_plain">response</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doConnection</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;doConnection</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">&nbsp;stop&nbsp;any&nbsp;data&nbsp;arriving</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">pause</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">This</span><span class="java_plain">&nbsp;will&nbsp;be&nbsp;called&nbsp;when&nbsp;we&nbsp;resume&nbsp;transmission</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">bodyHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Handler</span><span class="java_operator">&lt;</span><span class="java_type">NativeDataChunk</span><span class="java_operator">&gt;</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">NativeDataChunk</span><span class="java_plain">&nbsp;chunk</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">IApimanBuffer</span><span class="java_plain">&nbsp;apimanBuffer&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">YourApimanBufferImpl</span><span class="java_separator">(</span><span class="java_plain">nativeBuffer</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bodyHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">apimanBuffer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">});</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Transmission</span><span class="java_plain">&nbsp;has&nbsp;finished</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">endHandler</span><span class="java_separator">(</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Handler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;handle</span><span class="java_separator">(</span><span class="java_type">Void</span><span class="java_plain">&nbsp;flag</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">((</span><span class="java_type">Void</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">You</span><span class="java_plain">&nbsp;may&nbsp;want&nbsp;to&nbsp;close&nbsp;your&nbsp;backend&nbsp;connection&nbsp;here</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">(</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">IApimanBuffer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">bodyHandler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;bodyHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">(</span><span class="java_type">IAsyncHandler</span><span class="java_operator">&lt;</span><span class="java_type">Void</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">endHandler&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;endHandler</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">ServiceResponse</span><span class="java_plain">&nbsp;getHead</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;serviceResponse</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">boolean</span><span class="java_plain">&nbsp;isFinished</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;finished</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;abort</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Abort</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">&nbsp;explicitly&nbsp;resume&nbsp;transmission</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;transmit</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response</span><span class="java_separator">.</span><span class="java_plain">resume</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">};</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">We</span><span class="java_plain">'re&nbsp;ready&nbsp;to&nbsp;transmit&nbsp;the&nbsp;response</span><span class="java_separator">,</span><span class="java_plain">&nbsp;let&nbsp;apiman&nbsp;know</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResult</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">AsyncResultImpl</span><span class="java_separator">.</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;create</span><span class="java_separator">(</span><span class="java_plain">readStream</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;resultHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">result</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>We imagine that our <code class="literal">response</code> object contains what we need to build a <code class="literal">ServiceResponse</code>, and that handlers can be attached in order to retrieve body data and an end signal. It can be paused using <code class="literal">pause</code>, which prevents any data from arriving until <code class="literal">resume</code> is called.</p><p>Importantly, data transmission <span class="strong"><strong>must not</strong></span> begin until <code class="literal">transmit</code> has been called, otherwise the appropriate handlers may not yet have been set, and data will be liable to disappear. Hence, in this example, <code class="literal">resume</code> is called in <code class="literal">transmit</code> where we are certain that it’s safe to send data.</p><p>After <code class="literal">end</code> has been signalled, clean up on the native connection can be performed, such as closing it. In this example was assume the connection is closed for us.</p><p>Once we are sure our stream is ready, we pass it to apiman using <code class="literal">resultHandler.handle</code> wrapped inside of an IAsyncResult indicating we were successful. Some helpful <code class="literal">create</code> methods are available in <code class="literal">AsyncResultImpl</code>.</p><p>Whilst a given platform’s implementation may look very different, implementors must be careful to preserve the same external behaviour; some platforms may require buffering of data if pause-like functionality is not available. In many cases it may be possible to implement <code class="literal">IServiceConnectionResponse</code> and <code class="literal">IServiceConnection</code> in the same class.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Do not transmit any response data into apiman until <code class="literal">transmit</code> has been signalled.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_handling_an_error"/>6.3.3.2. Handling an error</h4></div></div></div><p>If an error occurs, you must return a failure <code class="literal">IAsyncResult</code>, which may be caused, for instance, by an endpoint being unresolvable. The simplest way to share this is by using <code class="literal">AsyncResultImpl</code>:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">try</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_separator">(</span><span class="java_type">Exception</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_type">IAsyncResult</span><span class="java_plain">&nbsp;errorResult&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">AsyncResultImpl</span><span class="java_separator">.</span><span class="java_operator">&lt;</span><span class="java_type">IServiceConnectionResponse</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;create</span><span class="java_separator">(</span><span class="java_plain">e</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;resultHandler</span><span class="java_separator">.</span><span class="java_plain">handle</span><span class="java_separator">(</span><span class="java_plain">errorResult</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Remember to clean up any resources you may have left open.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_implementation_strategies"/>6.3.4. Implementation strategies</h3></div></div></div><p>Implementors may notice that the only overlap between the <code class="literal">IServiceConnection</code> and <code class="literal">IServiceConnectionResponse</code> interfaces is the <code class="literal">isFinished</code> method. Hence, it is often possible to implement both interfaces using the same class, which may be a cleaner way to orchestrate the process.</p><p>Implementation exemplars:</p><div class="itemizedlist"><ul><li>link:<code class="literal"><a class="ulink" href="https://github.com/apiman/apiman/blob/master/gateway/platforms/servlet/src/main/java/io/apiman/gateway/platforms/servlet/connectors/HttpServiceConnection.java">https://github.com/apiman/apiman/blob/master/gateway/platforms/servlet/src/main/java/io/apiman/gateway/platforms/servlet/connectors/HttpServiceConnection.java</a></code>[Servlet HTTP Connector] is a more traditional synchronous implementations.</li><li>link:<code class="literal"> <a class="ulink" href="https://github.com/apiman/apiman/blob/master/gateway/platforms/vertx/src/main/java/io/apiman/gateway/vertx/connector/HttpConnector.java">https://github.com/apiman/apiman/blob/master/gateway/platforms/vertx/src/main/java/io/apiman/gateway/vertx/connector/HttpConnector.java</a></code>[Vert.x HTTP Connector] is an asynchronous HTTP implementation.</li></ul></div></div></div></div></div></body></html>